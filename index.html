<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Avatar G Workspace</title>

  <!-- ‚úÖ React -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- ‚úÖ Babel (JSX in one file) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- ‚úÖ Supabase JS v2 -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#070A0F;
      --panel:rgba(255,255,255,.06);
      --panel2:rgba(255,255,255,.04);
      --line:rgba(255,255,255,.10);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.62);
      --muted2:rgba(255,255,255,.45);
      --accent:#22d3ee;
      --accent2:#3b82f6;
      --good:#10b981;
      --bad:#ef4444;
      --warn:#f59e0b;
      --shadow: 0 20px 80px rgba(0,0,0,.45);
      --radius:18px;
      --radius2:26px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(34,211,238,.16), transparent 60%),
        radial-gradient(900px 500px at 80% 0%, rgba(59,130,246,.14), transparent 55%),
        radial-gradient(900px 700px at 70% 90%, rgba(34,211,238,.10), transparent 55%),
        var(--bg);
      overflow-x:hidden;
    }

    .appShell{
      max-width:1200px;
      margin:0 auto;
      padding:22px 14px 40px;
      display:grid;
      gap:14px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:14px 16px;
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border-radius:var(--radius2);
      box-shadow:var(--shadow);
      position:sticky;
      top:10px;
      z-index:20;
      backdrop-filter: blur(10px);
    }

    .brand{
      display:flex; align-items:center; gap:10px;
      min-width:0;
    }
    .logo{
      width:34px;height:34px;border-radius:12px;
      background:linear-gradient(135deg, rgba(34,211,238,.35), rgba(59,130,246,.28));
      border:1px solid rgba(255,255,255,.18);
      display:grid; place-items:center;
      box-shadow: 0 12px 40px rgba(0,0,0,.35);
    }
    .logo::after{
      content:"‚ö°";
      font-size:16px;
      opacity:.95;
    }
    .brandTitle{
      display:flex; flex-direction:column; gap:2px;
      min-width:0;
    }
    .brandTitle b{font-size:14px; letter-spacing:.2px}
    .brandTitle span{font-size:12px;color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

    .topActions{display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end}

    .pill{
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text);
      font-weight:800;
      font-size:12px;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:8px;
      user-select:none;
    }
    .pill:hover{border-color:rgba(255,255,255,.18)}
    .pillPrimary{
      background:linear-gradient(135deg, rgba(34,211,238,.22), rgba(59,130,246,.16));
      border-color:rgba(34,211,238,.35);
    }
    .pillDanger{
      background:rgba(239,68,68,.10);
      border-color:rgba(239,68,68,.25);
    }

    .grid{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }

    .panel{
      border:1px solid var(--line);
      border-radius:var(--radius2);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .panelHeader{
      padding:14px 14px 10px;
      display:flex; align-items:center; justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,.08);
      gap:10px;
    }
    .panelHeader h3{
      margin:0;
      font-size:14px;
      letter-spacing:.2px;
    }
    .panelHeader small{color:var(--muted); font-weight:700}

    .panelBody{padding:12px 14px 14px}

    .notice{
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(245,158,11,.25);
      background:rgba(245,158,11,.10);
      color:rgba(255,255,255,.92);
      font-weight:800;
      font-size:12px;
      line-height:1.35;
      margin-bottom:12px;
    }

    .row{display:flex; gap:10px; align-items:center}
    .col{display:flex; flex-direction:column; gap:10px}

    .divider{height:1px; background:rgba(255,255,255,.08); margin:10px 0}

    .muted{color:var(--muted)}
    .muted2{color:var(--muted2)}
    .tiny{font-size:11px}
    .tag{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      font-weight:800;
      font-size:11px;
      color:var(--muted);
    }

    .btn{
      height:40px;
      padding:0 14px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text);
      font-weight:900;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .btn:hover{border-color:rgba(255,255,255,.18)}
    .btnPrimary{
      background:linear-gradient(135deg, rgba(34,211,238,.22), rgba(59,130,246,.16));
      border-color:rgba(34,211,238,.35);
    }
    .btnGhost{
      background:transparent;
      border-color:rgba(255,255,255,.10);
    }
    .btnDanger{
      background:rgba(239,68,68,.10);
      border-color:rgba(239,68,68,.25);
    }
    .btn:disabled{opacity:.55; cursor:not-allowed}

    .input{
      height:40px;
      width:100%;
      padding:0 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.20);
      color:var(--text);
      outline:none;
      font-weight:800;
    }
    .input::placeholder{color:rgba(255,255,255,.35); font-weight:800}

    .select{
      height:40px;
      width:100%;
      padding:0 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.20);
      color:var(--text);
      outline:none;
      font-weight:900;
    }

    .projectItem{
      padding:10px 10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      display:flex; align-items:center; gap:10px;
      cursor:pointer;
    }
    .projectItem:hover{border-color:rgba(255,255,255,.18)}
    .projectItem.active{
      border-color:rgba(34,211,238,.35);
      background:linear-gradient(135deg, rgba(34,211,238,.12), rgba(59,130,246,.08));
    }
    .projectItem b{font-size:12px}
    .projectItem span{font-size:11px; color:var(--muted)}
    .projectItem .trash{
      margin-left:auto;
      width:32px; height:32px;
      border-radius:12px;
      border:1px solid rgba(239,68,68,.22);
      background:rgba(239,68,68,.10);
      display:grid; place-items:center;
      cursor:pointer;
    }

    .usageBox{
      padding:12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      display:grid; gap:8px;
    }
    .bar{
      height:10px;
      border-radius:999px;
      background:rgba(255,255,255,.08);
      overflow:hidden;
      border:1px solid rgba(255,255,255,.08);
    }
    .bar > div{
      height:100%;
      width:0%;
      background:linear-gradient(90deg, rgba(34,211,238,.9), rgba(59,130,246,.9));
    }

    /* Chat */
    .chatWrap{
      display:grid;
      grid-template-rows: auto 1fr auto;
      min-height: 72vh;
    }
    .chatHeader{
      padding:14px 14px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
    }
    .chatHeader .left{
      display:flex; flex-direction:column; gap:2px;
      min-width:0;
    }
    .chatHeader b{font-size:13px}
    .chatHeader small{font-size:12px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

    .chatBody{
      padding:14px;
      overflow:auto;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .bubble{
      max-width: 82%;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      line-height:1.4;
      white-space:pre-wrap;
      word-break:break-word;
      font-weight:750;
      font-size:13px;
    }
    .bubble.user{
      margin-left:auto;
      background:linear-gradient(135deg, rgba(34,211,238,.14), rgba(59,130,246,.10));
      border-color:rgba(34,211,238,.22);
    }
    .bubble.assistant{
      margin-right:auto;
      background:rgba(255,255,255,.035);
    }

    .chatComposer{
      padding:12px 14px 14px;
      border-top:1px solid rgba(255,255,255,.08);
      display:grid;
      gap:10px;
    }
    .composerRow{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .textarea{
      width:100%;
      min-height:44px;
      max-height:160px;
      resize:vertical;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.20);
      color:var(--text);
      outline:none;
      font-weight:800;
      font-size:13px;
    }

    .fileRow{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .fileChip{
      display:flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      font-size:12px;
      font-weight:850;
      color:var(--muted);
    }
    .fileChip button{
      border:none;
      background:transparent;
      color:rgba(255,255,255,.65);
      cursor:pointer;
      font-weight:900;
    }

    /* Modal */
    .modalOverlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:50;
    }
    .modal{
      width:min(560px, 100%);
      border-radius:22px;
      border:1px solid rgba(255,255,255,.14);
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      box-shadow: 0 30px 120px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modalHead{
      padding:14px 14px 12px;
      display:flex; align-items:center; justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,.08);
      gap:10px;
    }
    .modalHead b{font-size:14px}
    .modalBody{padding:14px}
    .xBtn{
      width:36px;height:36px;border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      color:var(--text);
      cursor:pointer;
      font-weight:900;
    }

    .ok{
      color:rgba(16,185,129,.95); font-weight:900;
    }
    .err{
      color:rgba(239,68,68,.95); font-weight:900;
    }
  </style>
</head>

<body>
  <div id="root"></div>

  <script type="text/babel">
    /******************************************************************
     ‚úÖ CONFIG ‚Äî EDIT THESE 3 VALUES ONLY
    ******************************************************************/
    const CONFIG = {
      SUPABASE_URL: "PASTE_SUPABASE_URL_HERE",
      SUPABASE_ANON_KEY: "PASTE_SUPABASE_ANON_KEY_HERE",
      API_BASE: "https://YOUR_BACKEND_DOMAIN", // e.g. https://avatarg-backend.onrender.com
    };

    /******************************************************************
     ‚úÖ SAFETY: config check (shows banner instead of breaking)
    ******************************************************************/
    const isConfigSet =
      CONFIG.SUPABASE_URL && CONFIG.SUPABASE_URL.startsWith("http") &&
      CONFIG.SUPABASE_ANON_KEY && CONFIG.SUPABASE_ANON_KEY.length > 20 &&
      CONFIG.API_BASE && CONFIG.API_BASE.startsWith("http");

    const supabase = isConfigSet
      ? window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY)
      : null;

    /******************************************************************
     ‚úÖ Helpers
    ******************************************************************/
    const fmtBytes = (n) => {
      const v = Number(n || 0);
      if (v < 1024) return v + " B";
      if (v < 1024*1024) return (v/1024).toFixed(1) + " KB";
      if (v < 1024*1024*1024) return (v/1024/1024).toFixed(1) + " MB";
      return (v/1024/1024/1024).toFixed(2) + " GB";
    };

    async function apiFetch(path, { method="GET", headers={}, body=null, token=null, isForm=false } = {}) {
      const h = { ...headers };
      if (token) h["Authorization"] = "Bearer " + token;
      if (!isForm && body && !h["Content-Type"]) h["Content-Type"] = "application/json";
      const res = await fetch(CONFIG.API_BASE + path, {
        method,
        headers: h,
        body: isForm ? body : (body ? JSON.stringify(body) : null),
      });
      let json = null;
      const text = await res.text();
      try { json = text ? JSON.parse(text) : null; } catch { json = { raw:text }; }
      if (!res.ok) {
        const msg = json?.error || json?.message || ("HTTP " + res.status);
        throw new Error(msg);
      }
      return json;
    }

    /******************************************************************
     ‚úÖ Auth Modal (Polished UI)
    ******************************************************************/
    function AuthModal({ open, onClose, onAuthed }) {
      const [tab, setTab] = React.useState("magic");
      const [email, setEmail] = React.useState("");
      const [password, setPassword] = React.useState("");
      const [loading, setLoading] = React.useState(false);
      const [msg, setMsg] = React.useState("");

      React.useEffect(() => { if(open){ setMsg(""); setPassword(""); } }, [open]);

      if (!open) return null;

      async function doMagic() {
        setLoading(true); setMsg("");
        try {
          const { error } = await supabase.auth.signInWithOtp({
            email,
            options: { emailRedirectTo: window.location.href }
          });
          if (error) throw error;
          setMsg("‚úÖ Magic link sent. Check your email.");
        } catch (e) {
          setMsg("‚ùå " + (e?.message || "Failed"));
        } finally {
          setLoading(false);
        }
      }

      async function doSignup() {
        setLoading(true); setMsg("");
        try {
          const { data, error } = await supabase.auth.signUp({ email, password });
          if (error) throw error;
          setMsg("‚úÖ Account created. Confirm email if needed, then Sign in.");
        } catch (e) {
          setMsg("‚ùå " + (e?.message || "Failed"));
        } finally {
          setLoading(false);
        }
      }

      async function doSignin() {
        setLoading(true); setMsg("");
        try {
          const { data, error } = await supabase.auth.signInWithPassword({ email, password });
          if (error) throw error;
          onAuthed?.();
          onClose?.();
        } catch (e) {
          setMsg("‚ùå " + (e?.message || "Failed"));
        } finally {
          setLoading(false);
        }
      }

      return (
        <div className="modalOverlay" onMouseDown={(e)=>{ if(e.target===e.currentTarget) onClose?.(); }}>
          <div className="modal">
            <div className="modalHead">
              <b>üîê Sign in to Avatar G</b>
              <button className="xBtn" onClick={onClose}>‚úï</button>
            </div>
            <div className="modalBody">
              <div className="row" style={{gap:8, flexWrap:"wrap", marginBottom:10}}>
                <button className={"btn " + (tab==="magic"?"btnPrimary":"btnGhost")} onClick={()=>setTab("magic")}>Magic link</button>
                <button className={"btn " + (tab==="signin"?"btnPrimary":"btnGhost")} onClick={()=>setTab("signin")}>Email + Password</button>
                <button className={"btn " + (tab==="signup"?"btnPrimary":"btnGhost")} onClick={()=>setTab("signup")}>Create account</button>
              </div>

              <div className="col">
                <input className="input" placeholder="Email" value={email} onChange={(e)=>setEmail(e.target.value)} />
                {(tab!=="magic") && (
                  <input className="input" placeholder="Password" type="password" value={password} onChange={(e)=>setPassword(e.target.value)} />
                )}

                {tab==="magic" && (
                  <button className="btn btnPrimary" disabled={loading || !email} onClick={doMagic}>
                    {loading ? "Sending‚Ä¶" : "Send Magic Link"}
                  </button>
                )}
                {tab==="signin" && (
                  <button className="btn btnPrimary" disabled={loading || !email || !password} onClick={doSignin}>
                    {loading ? "Signing in‚Ä¶" : "Sign in"}
                  </button>
                )}
                {tab==="signup" && (
                  <button className="btn btnPrimary" disabled={loading || !email || !password} onClick={doSignup}>
                    {loading ? "Creating‚Ä¶" : "Create account"}
                  </button>
                )}

                {msg && <div className={msg.startsWith("‚úÖ")?"ok":"err"} style={{fontWeight:900}}>{msg}</div>}
                <div className="muted tiny">Tip: Magic link is best for fast mobile login.</div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    /******************************************************************
     ‚úÖ Main App
    ******************************************************************/
    function App(){
      const [session, setSession] = React.useState(null);
      const [user, setUser] = React.useState(null);
      const [token, setToken] = React.useState(null);

      const [authOpen, setAuthOpen] = React.useState(false);

      // Projects
      const [projects, setProjects] = React.useState([]);
      const [activeProjectId, setActiveProjectId] = React.useState(null);
      const [projectName, setProjectName] = React.useState("");

      // Usage
      const [usage, setUsage] = React.useState(null);
      const [ent, setEnt] = React.useState(null);

      // Chat
      const [mode, setMode] = React.useState("chat"); // chat/avatar/voice/music/video/photo/marketing
      const [messages, setMessages] = React.useState([
        { role:"assistant", content:"Welcome to **Avatar G Workspace**.\n\n‚úÖ GPT-style unified window\n‚úÖ Projects + Files\n‚úÖ Usage limits + Billing\n\nUpload files and tell me what you want." }
      ]);
      const [input, setInput] = React.useState("");
      const [streaming, setStreaming] = React.useState(false);

      // Attachments (project-scoped)
      const [attachments, setAttachments] = React.useState([]);

      const chatRef = React.useRef(null);
      const fileRef = React.useRef(null);

      const configWarning = !isConfigSet;

      // Load session
      React.useEffect(()=>{
        if(!supabase) return;
        supabase.auth.getSession().then(({ data })=>{
          setSession(data.session || null);
          setUser(data.session?.user || null);
          setToken(data.session?.access_token || null);
        });
        const { data: sub } = supabase.auth.onAuthStateChange((_event, s)=>{
          setSession(s);
          setUser(s?.user || null);
          setToken(s?.access_token || null);
        });
        return ()=> sub?.subscription?.unsubscribe?.();
      },[]);

      // When token changes -> refresh projects + usage
      React.useEffect(()=>{
        if(!token) {
          setProjects([]);
          setActiveProjectId(null);
          setUsage(null);
          setEnt(null);
          return;
        }
        refreshProjects();
        refreshUsage();
      },[token]);

      React.useEffect(()=>{
        // scroll chat bottom
        if(chatRef.current) chatRef.current.scrollTop = chatRef.current.scrollHeight;
      },[messages, streaming]);

      // Visible attachments per project
      const visibleAttachments = attachments.filter(a => a.projectId === activeProjectId);

      async function refreshUsage(){
        try{
          const data = await apiFetch("/api/usage", { token });
          setUsage(data.usage);
          setEnt(data.entitlements);
        }catch(e){
          console.log("usage err", e.message);
        }
      }

      async function refreshProjects(){
        try{
          // We are using Supabase directly (Option B) for projects
          const { data, error } = await supabase
            .from("projects")
            .select("id,name,created_at,archived")
            .eq("archived", false)
            .order("created_at", { ascending: true });

          if(error) throw error;
          const list = data || [];
          setProjects(list);

          // pick active
          const saved = localStorage.getItem("ag_active_project");
          const exists = saved && list.find(p=>p.id===saved);
          const next = exists ? saved : (list[0]?.id || null);
          setActiveProjectId(next);
          if(next) localStorage.setItem("ag_active_project", next);
        }catch(e){
          console.log("projects err", e.message);
        }
      }

      async function createProject(){
        if(!token) return setAuthOpen(true);
        const name = (projectName || "").trim();
        if(!name) return alert("Project name required");
        try{
          // Enforce project limit from entitlements (client-side UX; server-side should also enforce)
          if(ent && projects.length >= ent.projects){
            return alert(`Project limit reached for ${ent.tier}. Upgrade to create more.`);
          }
          const { data, error } = await supabase
            .from("projects")
            .insert({ user_id: user.id, name })
            .select("id,name,created_at")
            .single();
          if(error) throw error;

          setProjectName("");
          await refreshProjects();
          setActiveProjectId(data.id);
          localStorage.setItem("ag_active_project", data.id);
        }catch(e){
          alert(e.message || "Create project failed");
        }
      }

      async function deleteProject(id){
        if(!confirm("Delete this project? (Files will remain in storage unless deleted)")) return;
        try{
          // soft archive
          const { error } = await supabase.from("projects").update({ archived:true }).eq("id", id);
          if(error) throw error;

          // local attachments cleanup (optional)
          setAttachments(prev => prev.filter(a => a.projectId !== id));

          await refreshProjects();
          if(activeProjectId === id){
            const next = projects.find(p=>p.id!==id)?.id || null;
            setActiveProjectId(next);
            if(next) localStorage.setItem("ag_active_project", next);
          }
        }catch(e){
          alert(e.message || "Delete failed");
        }
      }

      function setActive(id){
        setActiveProjectId(id);
        localStorage.setItem("ag_active_project", id);
      }

      async function handleUpload(file){
        if(!token) return setAuthOpen(true);
        if(!activeProjectId) return alert("Create/select a project first.");

        const fd = new FormData();
        fd.append("file", file);
        fd.append("projectId", activeProjectId);

        try{
          const json = await apiFetch("/api/upload", { method:"POST", body: fd, token, isForm:true });
          const meta = json.meta;

          // Attach to local state
          setAttachments(prev => [...prev, { 
            key: meta.key,
            projectId: meta.projectId,
            name: meta.name,
            type: meta.type,
            size: meta.size
          }]);

          setMessages(prev => [...prev, {
            role:"assistant",
            content:`‚úÖ Uploaded **${meta.name}** to this project.\nüîí Private storage (owner-only access).`
          }]);

          refreshUsage();
        }catch(e){
          alert(e.message || "Upload failed");
        }
      }

      async function signAndOpen(key){
        try{
          const json = await apiFetch("/api/r2/sign", { method:"POST", body:{ key }, token });
          window.open(json.url, "_blank");
        }catch(e){
          alert(e.message || "Sign failed");
        }
      }

      async function deleteFile(key){
        if(!confirm("Delete this file from private storage?")) return;
        try{
          await apiFetch("/api/r2/delete", { method:"POST", body:{ key }, token });
          setAttachments(prev => prev.filter(a=>a.key!==key));
          refreshUsage();
        }catch(e){
          alert(e.message || "Delete failed");
        }
      }

      async function stripeCheckout(plan){
        if(!token) return setAuthOpen(true);
        try{
          const json = await apiFetch("/api/billing/checkout", { method:"POST", body:{ plan }, token });
          window.location.href = json.url;
        }catch(e){
          alert(e.message || "Checkout failed");
        }
      }

      async function customerPortal(){
        if(!token) return setAuthOpen(true);
        try{
          const json = await apiFetch("/api/billing/portal", { method:"POST", body:{}, token });
          window.location.href = json.url;
        }catch(e){
          alert(e.message || "Portal failed");
        }
      }

      async function send(){
        const text = (input||"").trim();
        if(!text || streaming) return;
        if(!token) return setAuthOpen(true);
        if(!activeProjectId) return alert("Create/select a project first.");

        const next = [...messages, { role:"user", content:text }, { role:"assistant", content:"" }];
        setMessages(next);
        setInput("");
        setStreaming(true);

        // Stream via SSE
        try{
          const res = await fetch(CONFIG.API_BASE + "/api/chat", {
            method:"POST",
            headers:{
              "Content-Type":"application/json",
              "Authorization":"Bearer " + token
            },
            body: JSON.stringify({
              mode,
              projectId: activeProjectId,
              messages: [...messages, { role:"user", content:text }],
              attachments: visibleAttachments
            })
          });

          if(!res.ok){
            const t = await res.text();
            let j=null; try{ j=JSON.parse(t) }catch{ j={error:t} }
            throw new Error(j?.error || "Chat failed");
          }

          const reader = res.body.getReader();
          const decoder = new TextDecoder();
          let buffer = "";

          while(true){
            const { done, value } = await reader.read();
            if(done) break;
            buffer += decoder.decode(value, { stream:true });

            const parts = buffer.split("\n\n");
            buffer = parts.pop() || "";

            for(const p of parts){
              const line = p.split("\n").find(l=>l.startsWith("data:"));
              if(!line) continue;
              const payload = line.slice(5).trim();
              if(!payload) continue;
              let obj=null; try{ obj=JSON.parse(payload) }catch{ continue; }
              if(obj.type === "delta"){
                const delta = obj.delta || "";
                setMessages(prev=>{
                  const copy = [...prev];
                  const last = copy[copy.length-1];
                  copy[copy.length-1] = { ...last, content: (last.content||"") + delta };
                  return copy;
                });
              }
            }
          }
        }catch(e){
          setMessages(prev=>{
            const copy=[...prev];
            const last=copy[copy.length-1];
            copy[copy.length-1] = { ...last, content: "‚ùå " + (e.message || "Chat failed") };
            return copy;
          });
        }finally{
          setStreaming(false);
        }
      }

      async function signOut(){
        try{
          await supabase.auth.signOut();
        }catch{}
      }

      const tier = ent?.tier || (token ? "free" : "guest");
      const storageUsed = usage?.storage_used_bytes || 0;
      const storageMax = ent?.storage_bytes || 1;
      const pct = Math.min(100, Math.round((storageUsed / storageMax) * 100));

      return (
        <div className="appShell">
          <div className="topbar">
            <div className="brand">
              <div className="logo"></div>
              <div className="brandTitle">
                <b>Avatar G</b>
                <span>Unified AI Workspace</span>
              </div>
            </div>

            <div className="topActions">
              {token ? (
                <>
                  <div className="tag">Tier: {tier.toUpperCase()}</div>
                  <button className="pill pillDanger" onClick={signOut}>Log out</button>
                </>
              ) : (
                <button className="pill pillPrimary" onClick={()=>setAuthOpen(true)}>Sign in</button>
              )}
            </div>
          </div>

          {configWarning && (
            <div className="notice">
              ‚ö†Ô∏è <b>CONFIG is not set.</b><br/>
              Edit <b>CONFIG</b> at top of this file:<br/>
              - <b>SUPABASE_URL</b> + <b>SUPABASE_ANON_KEY</b><br/>
              - <b>API_BASE</b> (your backend domain)<br/>
              Then refresh.
            </div>
          )}

          <div className="grid">
            {/* Left panel */}
            <div className="panel">
              <div className="panelHeader">
                <div>
                  <h3>Avatar G Workspace</h3>
                  <small>{token ? (user?.email || "User") : "Guest"}</small>
                </div>
                <button className={"btn " + (token?"btnGhost":"btnPrimary")} onClick={()=> token ? refreshUsage() : setAuthOpen(true)}>
                  {token ? "Refresh" : "Sign in"}
                </button>
              </div>

              <div className="panelBody">
                <div className="usageBox">
                  <div className="row" style={{justifyContent:"space-between"}}>
                    <div style={{fontWeight:900}}>USAGE</div>
                    <div className="tag">{token ? tier.toUpperCase() : "GUEST"}</div>
                  </div>
                  <div className="muted tiny">Storage</div>
                  <div className="bar"><div style={{width: pct + "%"}}></div></div>
                  <div className="row" style={{justifyContent:"space-between"}}>
                    <div className="muted tiny">{fmtBytes(storageUsed)} used</div>
                    <div className="muted tiny">{fmtBytes(storageMax)} max</div>
                  </div>

                  {ent && (
                    <div className="muted tiny">
                      Projects limit: <b>{ent.projects >= 999999 ? "Unlimited" : ent.projects}</b>
                    </div>
                  )}
                </div>

                <div className="divider"></div>

                <div className="row" style={{justifyContent:"space-between"}}>
                  <div style={{fontWeight:900}}>PROJECTS</div>
                  <button className="btn btnPrimary" disabled={!token} onClick={createProject}>Ôºã</button>
                </div>

                <div className="row">
                  <input className="input" placeholder="New project name‚Ä¶" value={projectName} onChange={(e)=>setProjectName(e.target.value)} disabled={!token}/>
                </div>

                <div className="col" style={{marginTop:10}}>
                  {projects.length === 0 && (
                    <div className="muted tiny">No projects yet. Create one.</div>
                  )}

                  {projects.map(p=>(
                    <div key={p.id} className={"projectItem " + (p.id===activeProjectId ? "active":"")} onClick={()=>setActive(p.id)}>
                      <div style={{fontSize:16}}>{p.id===activeProjectId ? "üìÇ" : "üìÅ"}</div>
                      <div style={{minWidth:0}}>
                        <b style={{display:"block", whiteSpace:"nowrap", overflow:"hidden", textOverflow:"ellipsis"}}>{p.name}</b>
                        <span>{new Date(p.created_at).toLocaleDateString("ka-GE")}</span>
                      </div>
                      <div className="trash" title="Archive project" onClick={(e)=>{ e.stopPropagation(); deleteProject(p.id); }}>üóëÔ∏è</div>
                    </div>
                  ))}

                  <button className="btn" onClick={refreshProjects} disabled={!token}>Refresh Projects</button>
                </div>

                <div className="divider"></div>

                <div style={{fontWeight:900, marginBottom:8}}>BILLING</div>
                <div className="col">
                  <button className="btn btnPrimary" onClick={()=>stripeCheckout("pro")} disabled={!token}>Stripe Checkout: PRO ‚Üí</button>
                  <button className="btn btnPrimary" onClick={()=>stripeCheckout("studio")} disabled={!token} style={{opacity:.92}}>Stripe Checkout: STUDIO ‚Üí</button>
                  <button className="btn" onClick={customerPortal} disabled={!token}>Customer Portal</button>
                </div>

                <div className="divider"></div>

                <div style={{fontWeight:900, marginBottom:8}}>MODES</div>
                <div className="col">
                  {[
                    ["chat","üí¨ Chat"],
                    ["avatar","üßë‚ÄçüöÄ Avatar"],
                    ["voice","üéôÔ∏è Voice"],
                    ["music","üéµ Music"],
                    ["video","üé¨ Video"],
                    ["photo","üñºÔ∏è Photo"],
                    ["marketing","üìà Marketing"]
                  ].map(([id,label])=>(
                    <button
                      key={id}
                      className={"btn " + (mode===id ? "btnPrimary":"")}
                      onClick={()=>setMode(id)}
                    >
                      {label}
                    </button>
                  ))}
                </div>

              </div>
            </div>

            {/* Right panel (Chat) */}
            <div className="panel chatWrap">
              <div className="chatHeader">
                <div className="left">
                  <b>Chat</b>
                  <small>Project: {activeProjectId ? (projects.find(p=>p.id===activeProjectId)?.name || "Selected") : "None"}</small>
                </div>

                <div className="row">
                  <input
                    ref={fileRef}
                    type="file"
                    style={{display:"none"}}
                    onChange={(e)=>{
                      const f = e.target.files?.[0];
                      if(!f) return;
                      handleUpload(f);
                      e.target.value="";
                    }}
                  />
                  <button className="btn btnPrimary" onClick={()=>{
                    if(!token) return setAuthOpen(true);
                    if(!activeProjectId) return alert("Create/select a project first.");
                    fileRef.current.click();
                  }}>
                    üìé Upload
                  </button>
                </div>
              </div>

              <div className="chatBody" ref={chatRef}>
                {messages.map((m, idx)=>(
                  <div key={idx} className={"bubble " + (m.role==="user"?"user":"assistant")}>
                    {m.content}
                  </div>
                ))}

                {visibleAttachments.length > 0 && (
                  <div className="fileRow">
                    {visibleAttachments.map((a)=>(
                      <div className="fileChip" key={a.key}>
                        <span>üìé {a.name}</span>
                        <button title="Open" onClick={()=>signAndOpen(a.key)}>‚Üó</button>
                        <button title="Delete" onClick={()=>deleteFile(a.key)}>‚úï</button>
                      </div>
                    ))}
                  </div>
                )}
              </div>

              <div className="chatComposer">
                <textarea
                  className="textarea"
                  placeholder={token ? "Type a message‚Ä¶ (Enter to send, Shift+Enter for new line)" : "Sign in to chat‚Ä¶"}
                  value={input}
                  onChange={(e)=>setInput(e.target.value)}
                  onKeyDown={(e)=>{
                    if(e.key==="Enter" && !e.shiftKey){
                      e.preventDefault();
                      send();
                    }
                  }}
                  disabled={!token || streaming || configWarning}
                />
                <div className="composerRow">
                  <button
                    className={"btn " + (streaming ? "" : "btnPrimary")}
                    onClick={send}
                    disabled={!token || streaming || configWarning}
                    style={{padding:"0 24px"}}
                  >
                    {streaming ? "‚è≥" : "Send ‚Üí"}
                  </button>
                  <div className="muted tiny" style={{lineHeight:1.2}}>
                    Tip: Attach files per project. Backend enforces owner-only access.
                  </div>
                </div>
              </div>
            </div>
          </div>

          <AuthModal
            open={authOpen}
            onClose={()=>setAuthOpen(false)}
            onAuthed={()=>{ /* session is auto-updated */ }}
          />
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App/>);
  </script>
</body>
  </html>
