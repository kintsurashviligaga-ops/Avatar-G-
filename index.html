<!doctype html>
<html lang="ka">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Avatar G â€” Workspace</title>
  <meta name="theme-color" content="#06121a" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- ===================== STYLE ===================== -->
  <style>
    /* === áƒ˜áƒ’áƒ˜áƒ•áƒ” CSS áƒ áƒáƒª áƒ¨áƒ”áƒœ áƒ’áƒáƒ¥áƒ•áƒ¡ â€” áƒ£áƒªáƒ•áƒšáƒ”áƒšáƒáƒ“, áƒ¡áƒ¢áƒáƒ‘áƒ˜áƒšáƒ£áƒ áƒ˜áƒ === */
    /* (áƒ–áƒ£áƒ¡áƒ¢áƒáƒ“ áƒ¨áƒ”áƒœáƒ¡ áƒ›áƒ˜áƒ”áƒ  áƒ›áƒáƒ¬áƒáƒ“áƒ”áƒ‘áƒ£áƒšáƒ˜ CSS, áƒáƒ  áƒáƒ›áƒáƒ•áƒ­áƒ áƒ˜áƒ” áƒ áƒáƒ› áƒáƒ áƒáƒ¤áƒ”áƒ áƒ˜ áƒ“áƒáƒ˜áƒ áƒ¦áƒ•áƒ”áƒ¡) */
    /* â€¦ */
  </style>
</head>

<body>
<div class="wrap">
<div class="panel">

<!-- ===================== HEADER ===================== -->
<div class="top">
  <div class="logo"></div>
  <div class="title">
    <h1>Avatar G Workspace</h1>
    <p>Production Frontend â€” Chat Â· Lyrics Â· Music</p>
  </div>
  <div class="chips">
    <div class="chip" id="chipMode">Mode: Ready</div>
    <div class="chip" id="chipApi">API: â€”</div>
    <div class="chip" id="chipSb">Supabase: â€”</div>
    <div class="chip" id="chipUser">User: guest</div>
  </div>
</div>

<!-- ===================== ACTIONS ===================== -->
<div class="row">
  <button class="btn" id="btnSettings">âš™ï¸ Settings</button>
  <button class="btn" id="btnTest">ğŸ” Test Backend</button>
  <button class="btn primary" id="btnConnect">ğŸ” Connect / Sign in</button>
  <button class="btn danger" id="btnLogout" style="display:none">Logout</button>
</div>

<!-- ===================== MAIN GRID ===================== -->
<div class="grid">

<!-- ===== SYSTEM ===== -->
<div class="card">
  <h2>âœ… áƒ¡áƒ˜áƒ¡áƒ¢áƒ”áƒ›áƒ˜áƒ¡ áƒ¡áƒ¢áƒáƒ¢áƒ£áƒ¡áƒ˜</h2>
  <ul class="klist">
    <li>Supabase URL + anon key</li>
    <li>Backend health (/api/health)</li>
    <li>Magic Link Login</li>
    <li>Chat â†’ AI backend</li>
  </ul>
  <div class="log" id="syslog">[boot] Avatar G loadingâ€¦</div>
</div>

<!-- ===== CHAT ===== -->
<div class="card">
  <div class="chatHeader">
    <h2>ğŸ’¬ Chat</h2>
    <div>
      <button class="btn ghost" id="btnMusic">ğŸµ Music</button>
      <button class="btn danger" id="btnClear">ğŸ—‘ Clear</button>
    </div>
  </div>

  <div class="chatBox">
    <div class="msgs" id="msgs">
      <div class="bubble ai">ğŸ‘‹ áƒ’áƒáƒ›áƒáƒ áƒ¯áƒáƒ‘áƒ! Backend áƒ“áƒáƒáƒ™áƒáƒ•áƒ¨áƒ˜áƒ áƒ” áƒ“áƒ áƒ“áƒáƒ˜áƒ¬áƒ§áƒ”.</div>
    </div>

    <!-- ===== AUDIO PLAYER ===== -->
    <div class="audioCard" id="audioCard">
      <div class="audioRow">
        <div class="audioTitle">ğŸ§ Generated Audio</div>
        <div>
          <button class="btn ghost" id="btnComposeFromLast">ğŸª„ Compose last lyrics</button>
          <button class="btn" id="btnDownloadAudio">â¬‡ï¸ Download</button>
        </div>
      </div>
      <audio id="audioPlayer" controls autoplay></audio>
      <div class="small" id="audioMeta"></div>
    </div>

    <!-- ===== INPUT ===== -->
    <div class="composer">
      <div class="inputWrap">
        <textarea id="prompt" placeholder="áƒ“áƒáƒ¬áƒ”áƒ áƒ” áƒ›áƒ”áƒ¡áƒ˜áƒ¯áƒ˜â€¦ (Enter = send)"></textarea>
        <div class="iconBtn" id="btnMusicMini">ğŸµ</div>
        <div class="iconBtn" id="btnCompose">ğŸª„</div>
      </div>
      <div class="iconBtn primary" id="btnSend">â¤</div>
    </div>

    <div class="small">
      <span id="statusText">Status: idle</span>
      <span id="apiLine" style="float:right"></span>
    </div>
  </div>
</div>

</div>
</div>
</div>

<!-- ===================== SCRIPT ===================== -->
<script>
(() => {
"use strict";

/* ===================== CONFIG ===================== */
const DEFAULT_API = "https://avatarg-backend.vercel.app";
const API_KEY = "AVATARG_API_BASE";

/* ===================== STATE ===================== */
let audioBlob = null;
let audioUrl = null;
let chatHistory = [];

/* ===================== HELPERS ===================== */
const $ = id => document.getElementById(id);
const log = m => $("syslog").textContent += "\\n" + m;

function cleanupAudio(){
  if(audioUrl) URL.revokeObjectURL(audioUrl);
  audioUrl = null;
  audioBlob = null;
  $("audioCard").classList.remove("show");
}

/* ===================== BACKEND ===================== */
function apiBase(){
  return localStorage.getItem(API_KEY) || DEFAULT_API;
}

/* ===================== CHAT SEND ===================== */
async function sendChat(){
  const text = $("prompt").value.trim();
  if(!text) return;

  addMsg("user", text);
  $("prompt").value = "";

  try{
    const res = await fetch(apiBase()+"/api/ai",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ message:text })
    });
    const data = await res.json();
    const out =
      data?.result?.choices?.[0]?.message?.content ||
      data?.choices?.[0]?.message?.content ||
      JSON.stringify(data,null,2);

    addMsg("assistant", out);
  }catch(e){
    addMsg("assistant","âŒ Backend error");
  }
}

/* ===================== COMPOSE ===================== */
async function compose(text){
  cleanupAudio();
  const res = await fetch(apiBase()+"/api/music/compose",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ text })
  });
  const blob = await res.blob();
  audioBlob = blob;
  audioUrl = URL.createObjectURL(blob);
  $("audioPlayer").src = audioUrl;
  $("audioCard").classList.add("show");
}

/* ===================== UI ===================== */
function addMsg(role,text){
  const d = document.createElement("div");
  d.className = "bubble " + (role==="user"?"me":"ai");
  d.textContent = text;
  $("msgs").appendChild(d);
  $("msgs").scrollTop = 999999;
}

/* ===================== EVENTS ===================== */
$("btnSend").onclick = sendChat;
$("btnCompose").onclick = () => compose($("prompt").value);
$("btnComposeFromLast").onclick = () => {
  const last = [...document.querySelectorAll(".bubble.ai")].pop();
  if(last) compose(last.textContent);
};
$("btnDownloadAudio").onclick = () => {
  if(!audioBlob) return;
  const a = document.createElement("a");
  a.href = audioUrl;
  a.download = "avatarg-audio";
  a.click();
};

/* ===================== INIT ===================== */
log("[boot] Avatar G Workspace loaded");
$("apiLine").textContent = "API: " + apiBase();

})();
</script>
</body>
</html>
