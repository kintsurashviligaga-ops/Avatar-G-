<!doctype html>  
<html lang="ka">  
<head>  
  <meta charset="UTF-8" />  
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />  
  <title>Avatar G â€” Workspace</title>  
  <meta name="theme-color" content="#06121a" />  
  <style>  
    :root{  
      --bg1:#06121a;  
      --bg2:#0a2533;  
      --card:rgba(0,0,0,.35);  
      --card2:rgba(255,255,255,.06);  
      --line:rgba(255,255,255,.10);  
      --text:rgba(255,255,255,.92);  
      --muted:rgba(255,255,255,.68);  
      --danger:#ff4d4d;  
      --ok:#46e6a1;  
      --cyan:#22d3ee;  
      --blue:#3b82f6;  
      --shadow: 0 18px 60px rgba(0,0,0,.45);  
      --radius: 18px;  
      --radius2: 14px;  
    }  
    *{box-sizing:border-box}  
    html,body{height:100%}  
    body{  
      margin:0;  
      color:var(--text);  
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";  
      background:  
        radial-gradient(1200px 800px at 20% 20%, rgba(34,211,238,.14), transparent 60%),  
        radial-gradient(900px 700px at 70% 30%, rgba(59,130,246,.12), transparent 55%),  
        linear-gradient(180deg, var(--bg1), var(--bg2));  
      overflow-x:hidden;  
    }  
    .wrap{  
      min-height:100vh;  
      display:flex;  
      align-items:flex-end;  
      justify-content:center;  
      padding: 18px 14px 24px;  
    }  
    .panel{  
      width:min(980px, 100%);  
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));  
      border:1px solid var(--line);  
      box-shadow: var(--shadow);  
      border-radius: var(--radius);  
      overflow:hidden;  
      backdrop-filter: blur(10px);  
      position:relative;  
    }  
    .top{  
      display:flex;  
      gap:14px;  
      align-items:center;  
      padding:18px 18px 10px;  
    }  
    .logo{  
      width:44px;height:44px;border-radius:14px;  
      background: radial-gradient(circle at 30% 30%, rgba(34,211,238,.9), rgba(59,130,246,.7));  
      box-shadow: 0 12px 30px rgba(34,211,238,.12);  
      border:1px solid rgba(255,255,255,.16);  
      flex:0 0 auto;  
    }  
    .title{  
      display:flex;flex-direction:column;line-height:1.1;  
    }  
    .title h1{  
      font-size:18px;margin:0 0 4px;font-weight:760;letter-spacing:.2px;  
    }  
    .title p{  
      margin:0;color:var(--muted);font-size:13px;  
    }  
    .chips{  
      margin-left:auto;  
      display:flex;flex-wrap:wrap;gap:8px;justify-content:flex-end;  
    }  
    .chip{  
      font-size:12px;  
      color:rgba(255,255,255,.82);  
      border:1px solid var(--line);  
      background: rgba(0,0,0,.18);  
      padding:7px 10px;border-radius:999px;  
      white-space:nowrap;  
    }  
    .chip.ok{border-color:rgba(70,230,161,.25); background:rgba(70,230,161,.08)}  
    .chip.bad{border-color:rgba(255,77,77,.25); background:rgba(255,77,77,.08)}  
    .row{  
      display:flex;  
      gap:14px;  
      padding: 10px 18px 18px;  
      flex-wrap:wrap;  
    }  
    .btn{  
      border:none;  
      border-radius: 14px;  
      padding: 12px 14px;  
      font-weight:700;  
      color:rgba(255,255,255,.92);  
      background: rgba(255,255,255,.06);  
      border:1px solid var(--line);  
      cursor:pointer;  
      user-select:none;  
      -webkit-tap-highlight-color: transparent;  
      display:inline-flex;gap:10px;align-items:center;  
    }  
    .btn.primary{  
      background: linear-gradient(90deg, rgba(34,211,238,.95), rgba(59,130,246,.85));  
      border: 1px solid rgba(255,255,255,.18);  
      color:#041018;  
      box-shadow: 0 12px 30px rgba(34,211,238,.18);  
    }  
    .btn.danger{  
      background: rgba(255,77,77,.10);  
      border:1px solid rgba(255,77,77,.28);  
    }  
    .btn:disabled{opacity:.5; cursor:not-allowed}  
    .btn:active:not(:disabled){transform:translateY(1px)}  
    .grid{  
      display:grid;  
      grid-template-columns: 1.05fr .95fr;  
      gap:14px;  
      padding: 0 18px 18px;  
    }  
    @media (max-width: 860px){  
      .grid{grid-template-columns:1fr}  
      .chips{display:none}  
    }  
    .card{  
      background: rgba(0,0,0,.22);  
      border:1px solid var(--line);  
      border-radius: var(--radius2);  
      padding:14px;  
      min-height: 220px;  
    }  
    .card h2{  
      margin:0 0 10px;  
      font-size:14px;  
      color:rgba(255,255,255,.90);  
      letter-spacing:.2px;  
    }  
    .muted{color:var(--muted);font-size:13px}  
    .klist{margin:10px 0 0; padding:0 0 0 18px; color:var(--muted); font-size:13px}  
    .klist li{margin:6px 0}  
    .log{  
      margin-top:10px;  
      background: rgba(0,0,0,.28);  
      border:1px solid rgba(255,255,255,.10);  
      border-radius: 12px;  
      padding:10px;  
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;  
      font-size:12px;  
      color:rgba(255,255,255,.82);  
      max-height: 160px;  
      overflow:auto;  
      white-space:pre-wrap;  
    }  
  
    /* Modal */  
    .modalBack{  
      position:fixed; inset:0;  
      background: rgba(0,0,0,.55);  
      backdrop-filter: blur(4px);  
      display:none;  
      align-items:center;  
      justify-content:center;  
      padding:16px;  
      z-index:9999;  
    }  
    .modal{  
      width:min(720px, 100%);  
      max-height: 90vh;  
      overflow:auto;  
      border-radius: 18px;  
      background: linear-gradient(180deg, rgba(10,25,35,.98), rgba(6,18,26,.98));  
      border:1px solid rgba(255,255,255,.14);  
      box-shadow: 0 22px 80px rgba(0,0,0,.6);  
    }  
    .modalHead{  
      display:flex;  
      align-items:center;  
      gap:10px;  
      padding:14px 14px 10px;  
      border-bottom:1px solid rgba(255,255,255,.10);  
      position:sticky;  
      top:0;  
      background: rgba(6,18,26,.95);  
      backdrop-filter: blur(8px);  
      z-index:1;  
    }  
    .modalHead h3{  
      margin:0;  
      font-size:14px;  
      font-weight:760;  
    }  
    .modalHead .x{  
      margin-left:auto;  
      width:40px;height:40px;  
      border-radius: 12px;  
      border:1px solid rgba(255,255,255,.12);  
      background: rgba(255,255,255,.06);  
      cursor:pointer;  
      color:rgba(255,255,255,.88);  
      font-size:18px;  
      display:flex;  
      align-items:center;  
      justify-content:center;  
    }  
    .modalBody{padding:14px}  
    .field{  
      margin-bottom:12px;  
    }  
    .label{  
      font-size:12px;  
      color:rgba(255,255,255,.75);  
      margin:0 0 6px;  
      display:block;  
    }  
    input, textarea{  
      width:100%;  
      padding:12px 12px;  
      border-radius: 14px;  
      border:1px solid rgba(255,255,255,.12);  
      background: rgba(0,0,0,.22);  
      color:rgba(255,255,255,.92);  
      outline:none;  
      font-size:14px;  
      font-family: inherit;  
    }  
    input:focus, textarea:focus{  
      border-color: rgba(34,211,238,.55);  
      box-shadow: 0 0 0 3px rgba(34,211,238,.15);  
    }  
    .modalActions{  
      display:flex; gap:10px; justify-content:flex-end;  
      padding: 12px 14px 14px;  
      border-top:1px solid rgba(255,255,255,.10);  
      flex-wrap:wrap;  
    }  
  
    /* Chat */  
    .chatBox{  
      display:flex;  
      flex-direction:column;  
      gap:10px;  
      min-height: 360px;  
    }  
    .chatHeader{  
      display:flex;  
      justify-content:space-between;  
      align-items:center;  
      margin-bottom:8px;  
    }  
    .msgs{  
      flex:1;  
      background: rgba(255,255,255,.04);  
      border:1px solid rgba(255,255,255,.10);  
      border-radius: 14px;  
      padding: 12px;  
      overflow:auto;  
      max-height: 420px;  
    }  
    .bubble{  
      max-width: 90%;  
      padding:10px 12px;  
      border-radius: 14px;  
      margin: 8px 0;  
      border:1px solid rgba(255,255,255,.10);  
      line-height:1.35;  
      font-size:14px;  
      white-space:pre-wrap;  
      word-break:break-word;  
    }  
    .me{  
      margin-left:auto;  
      background: rgba(34,211,238,.10);  
      border-color: rgba(34,211,238,.22);  
    }  
    .ai{  
      background: rgba(255,255,255,.06);  
    }  
    .bubble img{  
      max-width:100%;  
      border-radius:8px;  
      margin-top:6px;  
      display:block;  
    }  
    .typing{  
      display:inline-block;  
      padding:8px 12px;  
      border-radius:14px;  
      background:rgba(255,255,255,.06);  
      border:1px solid rgba(255,255,255,.10);  
      font-size:13px;  
      color:var(--muted);  
    }  
    .composer{  
      display:flex;  
      gap:10px;  
      align-items:flex-end;  
    }  
    .composer textarea{  
      min-height: 48px;  
      max-height: 140px;  
      resize: vertical;  
    }  
    .small{  
      font-size:12px;  
      color:rgba(255,255,255,.70);  
    }  
    .hint{  
      margin-top:8px;  
      padding:10px;  
      border-radius: 14px;  
      border:1px dashed rgba(255,255,255,.14);  
      background: rgba(0,0,0,.18);  
      color:rgba(255,255,255,.74);  
      font-size:12px;  
      line-height:1.4;  
    }  
    .warning{  
      margin-top:8px;  
      padding:10px;  
      border-radius: 14px;  
      border:1px solid rgba(255,193,7,.3);  
      background: rgba(255,193,7,.08);  
      color:rgba(255,240,180,.95);  
      font-size:12px;  
      line-height:1.4;  
    }  
    .dangerText{color:rgba(255,120,120,.95)}  
    .okText{color:rgba(120,255,190,.95)}  
  </style>  
  
  <!-- Supabase JS (CDN) -->  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>  
</head>  
  
<body>  
  <div class="wrap">  
    <div class="panel">  
      <div class="top">  
        <div class="logo" aria-hidden="true"></div>  
        <div class="title">  
          <h1>Avatar G Workspace</h1>  
          <p>Production Frontend â€” Connect & Chat</p>  
        </div>  
        <div class="chips" id="chips">  
          <div class="chip" id="chipMode">Mode: Ready</div>  
          <div class="chip" id="chipApi">API: not set</div>  
          <div class="chip" id="chipSb">Supabase: not set</div>  
          <div class="chip" id="chipUser">User: guest</div>  
        </div>  
      </div>  
  
      <div class="row">  
        <button class="btn" id="btnSettings">âš™ï¸ Settings</button>  
        <button class="btn" id="btnTest">ğŸ” Test Backend</button>  
        <button class="btn primary" id="btnConnect">ğŸ” Connect / Sign in</button>  
        <button class="btn danger" id="btnLogout" style="display:none">Logout</button>  
      </div>  
  
      <div class="grid">  
        <div class="card">  
          <h2>âœ… áƒ¡áƒ˜áƒ¡áƒ¢áƒ”áƒ›áƒ˜áƒ¡ áƒ¡áƒ¢áƒáƒ¢áƒ£áƒ¡áƒ˜</h2>  
          <div class="muted">  
            áƒáƒ¥ áƒ¨áƒ”áƒ’áƒ˜áƒ«áƒšáƒ˜áƒ:  
            <ul class="klist">  
              <li>áƒ“áƒáƒáƒ§áƒ”áƒœáƒ Supabase URL + anon key + API_BASE</li>  
              <li>áƒ¨áƒ”áƒáƒ›áƒáƒ¬áƒ›áƒ backend health (/api/health)</li>  
              <li>áƒ’áƒáƒ˜áƒáƒ áƒ Magic Link Login (email)</li>  
              <li>áƒ’áƒáƒ›áƒáƒ˜áƒ§áƒ”áƒœáƒ Chat â€” áƒ áƒáƒ›áƒ”áƒšáƒ˜áƒª backend-áƒ¡ áƒ”áƒ«áƒáƒ®áƒ˜áƒ¡</li>  
            </ul>  
          </div>  
  
          <div class="hint">  
            âœ… <b>Tip:</b> áƒ—áƒ£ "Failed to fetch" áƒ©áƒáƒœáƒ¡, áƒ”áƒ¡ áƒ®áƒ¨áƒ˜áƒ áƒáƒ“ áƒáƒ áƒ˜áƒ¡:<br/>  
            â€¢ CORS áƒáƒ áƒáƒ‘áƒšáƒ”áƒ›áƒ (backend áƒ£áƒœáƒ“áƒ allow-áƒ”áƒ‘áƒ“áƒ”áƒ¡ áƒ—áƒ¥áƒ•áƒ”áƒœáƒ¡ frontend domain-áƒ¡)<br/>  
            â€¢ API_BASE áƒáƒ áƒáƒ¡áƒ¬áƒáƒ áƒ˜áƒ (áƒ£áƒœáƒ“áƒ áƒ˜áƒ§áƒáƒ¡: https://avatarg-backend.vercel.app)<br/>  
            â€¢ Backend offline-áƒ˜áƒ áƒáƒœ route áƒáƒ  áƒáƒ áƒ¡áƒ”áƒ‘áƒáƒ‘áƒ¡  
          </div>  
  
          <div class="log" id="syslog">[boot] Page loadedâ€¦</div>  
        </div>  
  
        <div class="card">  
          <div class="chatHeader">  
            <h2>ğŸ’¬ Chat</h2>  
            <button class="btn danger" id="btnClear" style="padding:8px 12px; font-size:12px">ğŸ—‘ Clear</button>  
          </div>  
  
          <div class="chatBox">  
            <div class="msgs" id="msgs">  
              <div class="bubble ai">ğŸ‘‹ áƒ’áƒáƒ›áƒáƒ áƒ¯áƒáƒ‘áƒ! áƒ’áƒáƒáƒ¥áƒ¢áƒ˜áƒ£áƒ áƒ” backend connection áƒ“áƒ áƒ“áƒáƒ˜áƒ¬áƒ§áƒ” áƒ©áƒáƒ¢áƒ˜.</div>  
            </div>  
  
            <div class="composer">  
              <textarea id="prompt" placeholder="áƒ“áƒáƒ¬áƒ”áƒ áƒ” áƒ›áƒ”áƒ¡áƒ˜áƒ¯áƒ˜â€¦ (Enter = send, Shift+Enter = new line)"></textarea>  
              <button class="btn primary" id="btnSend">Send</button>  
            </div>  
  
            <div class="small" id="chatStatus">Status: idle</div>  
          </div>  
        </div>  
      </div>  
    </div>  
  </div>  
  
  <!-- Settings Modal -->  
  <div class="modalBack" id="modalBack" role="dialog" aria-modal="true">  
    <div class="modal">  
      <div class="modalHead">  
        <h3>âš™ï¸ Connect Avatar G</h3>  
        <button class="x" id="btnClose" aria-label="Close">Ã—</button>  
      </div>  
  
      <div class="modalBody">  
        <div class="small" style="margin-bottom:10px">  
          Paste your config once â€” saved in localStorage (this browser only).  
        </div>  
  
        <div class="field">  
          <label class="label" for="sbUrl">SUPABASE_URL</label>  
          <input id="sbUrl" type="url" inputmode="url" placeholder="https://xxxx.supabase.co" autocomplete="off" />  
        </div>  
  
        <div class="field">  
          <label class="label" for="apiBase">API_BASE (backend domain)</label>  
          <input id="apiBase" type="url" inputmode="url" placeholder="https://avatarg-backend.vercel.app" autocomplete="off" />  
        </div>  
  
        <div class="field">  
          <label class="label" for="sbAnon">SUPABASE_ANON_KEY (public key only)</label>  
          <textarea id="sbAnon" rows="3" placeholder="eyJhbGciOi..." autocomplete="off"></textarea>  
        </div>  
  
        <div class="warning">  
          âš ï¸ <b>Security Warning:</b><br/>  
          â€¢ Only paste the <b>anon public key</b> here (starts with eyJhbGciOi...)<br/>  
          â€¢ NEVER paste your <b>service_role key</b> or any secret keys<br/>  
          â€¢ These values are stored in localStorage (browser only, not secure for secrets)  
        </div>  
  
        <div class="small" style="margin-top:10px">  
          Get these from: Supabase â†’ Project Settings â†’ API<br/>  
          API_BASE is your backend HTTPS domain (e.g., https://avatarg-backend.vercel.app)  
        </div>  
  
        <div class="log" id="cfglog">[cfg] Readyâ€¦</div>  
      </div>  
  
      <div class="modalActions">  
        <button class="btn" id="btnReset">ğŸ—‘ Reset</button>  
        <button class="btn primary" id="btnSave">ğŸ’¾ Save & Continue</button>  
      </div>  
    </div>  
  </div>  
  
  <script>  
    // ==================== UTILITIES ====================  
      
    const KEY = {  
      SUPABASE_URL: "AVATARG_SUPABASE_URL",  
      SUPABASE_ANON: "AVATARG_SUPABASE_ANON",  
      API_BASE: "AVATARG_API_BASE",  
      CHAT: "AVATARG_CHAT_LOG"  
    };  
  
    function log(el, text) {  
      const ts = new Date().toLocaleTimeString();  
      el.textContent += `\n[${ts}] ${text}`;  
      el.scrollTop = el.scrollHeight;  
    }  
  
    function setLog(el, text) {  
      el.textContent = text;  
      el.scrollTop = el.scrollHeight;  
    }  
  
    function getCfg() {  
      return {  
        supabaseUrl: (localStorage.getItem(KEY.SUPABASE_URL) || "").trim(),  
        supabaseAnon: (localStorage.getItem(KEY.SUPABASE_ANON) || "").trim(),  
        apiBase: (localStorage.getItem(KEY.API_BASE) || "").trim().replace(/\/+$/, "")  
      };  
    }  
  
    function saveCfg(cfg) {  
      localStorage.setItem(KEY.SUPABASE_URL, (cfg.supabaseUrl || "").trim());  
      localStorage.setItem(KEY.SUPABASE_ANON, (cfg.supabaseAnon || "").trim());  
      localStorage.setItem(KEY.API_BASE, (cfg.apiBase || "").trim().replace(/\/+$/, ""));  
    }  
  
    function resetCfg() {  
      localStorage.removeItem(KEY.SUPABASE_URL);  
      localStorage.removeItem(KEY.SUPABASE_ANON);  
      localStorage.removeItem(KEY.API_BASE);  
    }  
  
    function isValidUrl(str) {  
      try {  
        const u = new URL(str);  
        return u.protocol === "https:";  
      } catch {  
        return false;  
      }  
    }  
  
    function withTimeout(ms) {  
      const ctrl = new AbortController();  
      const t = setTimeout(() => ctrl.abort(), ms);  
      return { ctrl, done: () => clearTimeout(t) };  
    }  
  
    // ==================== DOM ELEMENTS ====================  
      
    const syslog = document.getElementById("syslog");  
    const cfglog = document.getElementById("cfglog");  
    const modalBack = document.getElementById("modalBack");  
  
    const chipMode = document.getElementById("chipMode");  
    const chipApi = document.getElementById("chipApi");  
    const chipSb = document.getElementById("chipSb");  
    const chipUser = document.getElementById("chipUser");  
  
    const btnSettings = document.getElementById("btnSettings");  
    const btnTest = document.getElementById("btnTest");  
    const btnConnect = document.getElementById("btnConnect");  
    const btnLogout = document.getElementById("btnLogout");  
    const btnClose = document.getElementById("btnClose");  
    const btnSave = document.getElementById("btnSave");  
    const btnReset = document.getElementById("btnReset");  
    const btnClear = document.getElementById("btnClear");  
  
    const sbUrl = document.getElementById("sbUrl");  
    const sbAnon = document.getElementById("sbAnon");  
    const apiBase = document.getElementById("apiBase");  
  
    const msgs = document.getElementById("msgs");  
    const prompt = document.getElementById("prompt");  
    const btnSend = document.getElementById("btnSend");  
    const chatStatus = document.getElementById("chatStatus");  
  
    // ==================== STATE ====================  
      
    let supabaseClient = null;  
    let currentUser = null;  
    let isSending = false;  
  
    // ==================== CHIP UPDATES ====================  
      
    function updateChips() {  
      const cfg = getCfg();  
  
      chipMode.textContent = currentUser ? "Mode: Authenticated" : "Mode: Ready";  
      chipMode.classList.toggle("ok", !!currentUser);  
  
      if (cfg.apiBase && isValidUrl(cfg.apiBase)) {  
        chipApi.textContent = "API: âœ“";  
        chipApi.classList.add("ok");  
        chipApi.classList.remove("bad");  
      } else {  
        chipApi.textContent = "API: not set";  
        chipApi.classList.remove("ok");  
        if (cfg.apiBase) chipApi.classList.add("bad");  
      }  
  
      if (cfg.supabaseUrl && cfg.supabaseAnon) {  
        chipSb.textContent = "Supabase: âœ“";  
        chipSb.classList.add("ok");  
        chipSb.classList.remove("bad");  
      } else {  
        chipSb.textContent = "Supabase: not set";  
        chipSb.classList.remove("ok");  
      }  
  
      if (currentUser?.email) {  
        chipUser.textContent = "User: " + currentUser.email.split("@")[0];  
        chipUser.classList.add("ok");  
        btnLogout.style.display = "inline-flex";  
        btnConnect.textContent = "ğŸ” Re-connect";  
      } else {  
        chipUser.textContent = "User: guest";  
        chipUser.classList.remove("ok");  
        btnLogout.style.display = "none";  
        btnConnect.textContent = "ğŸ” Connect / Sign in";  
      }  
    }  
  
    // ==================== MODAL ====================  
      
    function openModal() {  
      const cfg = getCfg();  
      sbUrl.value = cfg.supabaseUrl;  
      sbAnon.value = cfg.supabaseAnon;  
      apiBase.value = cfg.apiBase || "https://avatarg-backend.vercel.app";  
      setLog(cfglog, "[cfg] Paste values and Saveâ€¦");  
      modalBack.style.display = "flex";  
  
      setTimeout(() => {  
        sbUrl.focus();  
        sbUrl.scrollIntoView({ behavior: "smooth", block: "center" });  
      }, 120);  
    }  
  
    function closeModal() {  
      modalBack.style.display = "none";  
    }  
  
    btnSettings.addEventListener("click", openModal);  
    btnClose.addEventListener("click", closeModal);  
    modalBack.addEventListener("click", (e) => {  
      if (e.target === modalBack) closeModal();  
    });  
  
    btnSave.addEventListener("click", () => {  
      const cfg = {  
        supabaseUrl: sbUrl.value.trim(),  
        supabaseAnon: sbAnon.value.trim(),  
        apiBase: apiBase.value.trim().replace(/\/+$/, "")  
      };  
  
      // Validation  
      if (cfg.apiBase && !isValidUrl(cfg.apiBase)) {  
        setLog(cfglog, "âŒ API_BASE must start with https://");  
        return;  
      }  
      if (cfg.supabaseUrl && !cfg.supabaseUrl.includes("supabase")) {  
        log(cfglog, "âš ï¸ SUPABASE_URL doesn't look like a Supabase domain");  
      }  
      if (cfg.supabaseAnon && cfg.supabaseAnon.length < 100) {  
        log(cfglog, "âš ï¸ SUPABASE_ANON_KEY looks too short");  
      }  
  
      saveCfg(cfg);  
      supabaseClient = null;  
      setLog(cfglog, "âœ… Config saved! Close and test backend.");  
      log(syslog, "Config saved.");  
      updateChips();  
      setTimeout(closeModal, 800);  
    });  
  
    btnReset.addEventListener("click", () => {  
      if (!confirm("Reset all config? This will clear Supabase + API_BASE settings.")) return;  
      resetCfg();  
      supabaseClient = null;  
      currentUser = null;  
      setLog(cfglog, "âœ… Config reset.");  
      log(syslog, "Config reset.");  
      updateChips();  
      sbUrl.value = "";  
      sbAnon.value = "";  
      apiBase.value = "";  
    });  
  
    // ==================== SUPABASE AUTH ====================  
      
    function ensureSupabase() {  
      const cfg = getCfg();  
      if (!cfg.supabaseUrl || !cfg.supabaseAnon) {  
        log(syslog, "âš ï¸ Supabase not configured. Open Settings.");  
        chipSb.classList.add("bad");  
        return null;  
      }  
      if (!window.supabase) {  
        log(syslog, "âŒ Supabase SDK not loaded (CDN issue).");  
        return null;  
      }  
      if (!supabaseClient) {  
        try {  
          supabaseClient = window.supabase.createClient(cfg.supabaseUrl, cfg.supabaseAnon, {  
            auth: {  
              persistSession: true,  
              autoRefreshToken: true,  
              detectSessionInUrl: true  
            }  
          });  
          log(syslog, "âœ… Supabase client initialized.");  
        } catch (e) {  
          log(syslog, "âŒ Supabase init error: " + (e?.message || e));  
          return null;  
        }  
      }  
      return supabaseClient;  
    }  
  
    async function readUser() {  
      const sb = ensureSupabase();  
      if (!sb) return null;  
      try {  
        const { data, error } = await sb.auth.getUser();  
        if (error) throw error;  
        currentUser = data?.user || null;  
        updateChips();  
        if (currentUser) {  
          log(syslog, "âœ… Signed in as: " + currentUser.email);  
        }  
        return currentUser;  
      } catch (e) {  
        log(syslog, "Auth check error: " + (e?.message || e));  
        currentUser = null;  
        updateChips();  
        return null;  
      }  
    }  
  
    async function magicLinkLogin() {  
      const sb = ensureSupabase();  
      if (!sb) {  
        openModal();  
        return;  
      }  
  
      const email = window.prompt("Enter your email for Magic Link login:");  
      if (!email || !email.includes("@")) {  
        if (email) alert("Invalid email format");  
        return;  
      }  
  
      try {  
        log(syslog, "ğŸ“§ Sending magic link to: " + email);  
          
        // Use current URL as redirect (works for both local and deployed)  
        const redirectTo = window.location.href.split("?")[0].split("#")[0];  
          
        const { error } = await sb.auth.signInWithOtp({  
          email: email.trim(),  
          options: { emailRedirectTo: redirectTo }  
        });  
          
        if (error) throw error;  
          
        log(syslog, "âœ… Magic link sent! Check your email inbox.");  
        alert("âœ… Magic link sent!\n\nCheck your email and click the link.\nMake sure to open it in THIS browser.");  
      } catch (e) {  
        log(syslog, "âŒ Login error: " + (e?.message || e));  
        alert("Login failed: " + (e?.message || e));  
      }  
    }  
  
    async function logout() {  
      const sb = ensureSupabase();  
      if (!sb) return;  
      try {  
        await sb.auth.signOut();  
        currentUser = null;  
        log(syslog, "âœ… Signed out.");  
        updateChips();  
      } catch (e) {  
        log(syslog, "Sign out error: " + (e?.message || e));  
      }  
    }  
  
    btnConnect.addEventListener("click", async () => {  
      const cfg = getCfg();  
      if (!cfg.supabaseUrl || !cfg.supabaseAnon) {  
        openModal();  
        return;  
      }  
      await magicLinkLogin();  
    });  
  
    btnLogout.addEventListener("click", logout);  
  
    // ==================== BACKEND TEST ====================  
      
    async function testBackend() {  
      const cfg = getCfg();  
      if (!cfg.apiBase) {  
        log(syslog, "âš ï¸ API_BASE not set. Open Settings.");  
        chipApi.classList.add("bad");  
        openModal();  
        return;  
      }  
  
      const url = cfg.apiBase + "/api/health";  
      const { ctrl, done } = withTimeout(10000);  
  
      try {  
        log(syslog, "ğŸ” Testing: " + url);  
        const res = await fetch(url, {   
          method: "GET",   
          signal: ctrl.signal,  
          cache: "no-store"  
        });  
        done();  
  
        const text = await res.text();  
          
        if (!res.ok) {  
          chipApi.classList.add("bad");  
          chipApi.classList.remove("ok");  
          log(syslog, "âŒ Backend error: HTTP " + res.status + " â€” " + text.substring(0, 200));  
          alert("Backend Error\nHTTP " + res.status + "\n\nCheck CORS settings and backend route.");  
          return;  
        }  
  
        chipApi.classList.add("ok");  
        chipApi.classList.remove("bad");  
        log(syslog, "âœ… Backend OK: " + text.substring(0, 150));  
        alert("âœ… Backend is online!\n\n" + text.substring(0, 200));  
      } catch (e) {  
        done();  
        chipApi.classList.add("bad");  
        chipApi.classList.remove("ok");  
        const msg = e?.name === "AbortError" ? "Timeout (10s)" : (e?.message || e);  
        log(syslog, "âŒ Backend test failed: " + msg);  
        alert("Backend Test Failed\n\n" + msg + "\n\nCommon causes:\nâ€¢ CORS not configured\nâ€¢ Wrong API_BASE URL\nâ€¢ Backend offline");  
      }  
    }  
  
    btnTest.addEventListener("click", testBackend);  
  
    // ==================== CHAT ====================  
      
    function loadChat() {  
      try {  
        const raw = localStorage.getItem(KEY.CHAT);  
        if (!raw) return;  
        const arr = JSON.parse(raw);  
        msgs.innerHTML = "";  
        arr.forEach(m => addMsg(m.role, m.content, false));  
        msgs.scrollTop = msgs.scrollHeight;  
      } catch (e) {  
        console.warn("Chat load error:", e);  
      }  
    }  
  
    function saveChat() {  
      try {  
        const items = [...msgs.querySelectorAll(".bubble")].map(b => {  
          const role = b.classList.contains("me") ? "user" : "assistant";  
          // Get text content, excluding image alt text  
          const text = b.textContent || "";  
          return { role, content: text };  
        });  
        localStorage.setItem(KEY.CHAT, JSON.stringify(items.slice(-60)));  
      } catch (e) {  
        console.warn("Chat save error:", e);  
      }  
    }  
  
    function addMsg(role, content, persist = true) {  
      const div = document.createElement("div");  
      div.className = "bubble " + (role === "user" ? "me" : "ai");  
        
      // Check if content contains image URL  
      const imageUrlMatch = content.match(/https?:\/\/[^\s]+\.(jpg|jpeg|png|gif|webp)/i);  
        
      if (imageUrlMatch && isValidUrl(imageUrlMatch[0])) {  
        // Split content into text and image  
        const parts = content.split(imageUrlMatch[0]);  
          
        if (parts[0].trim()) {  
          div.textContent = parts[0].trim();  
        }  
          
        const img = document.createElement("img");  
        img.src = imageUrlMatch[0];  
        img.alt = "Generated image";  
        img.loading = "lazy";  
        div.appendChild(img);  
          
        if (parts[1] && parts[1].trim()) {  
          const textNode = document.createTextNode("\n" + parts[1].trim());  
          div.appendChild(textNode);  
        }  
      } else {  
        // Plain text  
        div.textContent = content;  
      }  
        
      msgs.appendChild(div);  
      msgs.scrollTop = msgs.scrollHeight;  
        
      if (persist) saveChat();  
    }  
  
    function showTyping() {  
      const typing = document.createElement("div");  
      typing.className = "typing";  
      typing.id = "typing";  
      typing.textContent = "â³ typing...";  
      msgs.appendChild(typing);  
      msgs.scrollTop = msgs.scrollHeight;  
    }  
  
    function hideTyping() {  
      const typing = document.getElementById("typing");  
      if (typing) typing.remove();  
    }  
  
    function extractResponse(data) {  
      // Support multiple backend response formats  
        
      // 1. Direct text field  
      if (data?.text) return String(data.text);  
        
      // 2. Reply field  
      if (data?.reply) return String(data.reply);  
        
      // 3. Message field  
      if (data?.message) return String(data.message);  
        
      // 4. Output field  
      if (data?.output) return String(data.output);  
        
      // 5. Nested data.text  
      if (data?.data?.text) return String(data.data.text);  
        
      // 6. OpenAI format: choices[0].message.content  
      if (data?.choices?.[0]?.message?.content) {  
        return String(data.choices[0].message.content);  
      }  
        
      // 7. Anthropic format: content[0].text  
      if (Array.isArray(data?.content) && data.content[0]?.text) {  
        return String(data.content[0].text);  
      }  
        
      // 8. Image URL  
      if (data?.imageUrl && isValidUrl(data.imageUrl)) {  
        return "Generated image:\n" + data.imageUrl;  
      }  
        
      // 9. Multiple images  
      if (Array.isArray(data?.images) && data.images.length > 0) {  
        return "Generated images:\n" + data.images.filter(isValidUrl).join("\n");  
      }  
        
      // 10. Fallback: stringify entire response  
      return JSON.stringify(data, null, 2);  
    }  
  
    async function sendChat() {  
      if (isSending) return;  
        
      const cfg = getCfg();  
      const text = (prompt.value || "").trim();  
        
      if (!text) return;  
  
      if (!cfg.apiBase) {  
        addMsg("assistant", "âŒ API_BASE áƒáƒ  áƒáƒ áƒ˜áƒ¡ áƒ“áƒáƒ§áƒ”áƒœáƒ”áƒ‘áƒ£áƒšáƒ˜.\n\náƒ’áƒáƒ®áƒ¡áƒ”áƒœáƒ˜ Settings áƒ“áƒ áƒ©áƒáƒ¡áƒ•áƒ˜ backend domain.");  
        openModal();  
        return;  
      }  
  
      isSending = true;  
      addMsg("user", text);  
      prompt.value = "";  
      chatStatus.innerHTML = '<span style="color:var(--cyan)">Status: sending...</span>';  
      btnSend.disabled = true;  
      showTyping();  
  
      const url = cfg.apiBase + "/api/ai";  
  
      const payload = {  
        message: text,  
        client: "AvatarG-Workspace-v2",  
        user: currentUser?.email || null,  
        timestamp: new Date().toISOString()  
      };  
  
      const { ctrl, done } = withTimeout(30000);  
  
      try {  
        const res = await fetch(url, {  
          method: "POST",  
          headers: {   
            "Content-Type": "application/json"  
          },  
          body: JSON.stringify(payload),  
          signal: ctrl.signal  
        });  
          
        done();  
        hideTyping();  
  
        const contentType = res.headers.get("content-type") || "";  
        let responseText = "";  
  
        if (contentType.includes("application/json")) {  
          const data = await res.json();  
            
          if (!res.ok) {  
            const errMsg = data?.error || data?.message || ("HTTP " + res.status);  
            responseText = "âŒ Backend Error:\n" + errMsg;  
            chatStatus.innerHTML = '<span class="dangerText">Status: error</span>';  
          } else {  
            responseText = extractResponse(data);  
            chatStatus.innerHTML = '<span class="okText">Status: success âœ“</span>';  
          }  
        } else {  
          // Plain text response  
          const text = await res.text();  
            
          if (!res.ok) {  
            responseText = "âŒ Backend Error (HTTP " + res.status + "):\n" + text.substring(0, 500);  
            chatStatus.innerHTML = '<span class="dangerText">Status: error</span>';  
          } else {  
            responseText = text || "(empty response)";  
            chatStatus.innerHTML = '<span class="okText">Status: success âœ“</span>';  
          }  
        }  
  
        addMsg("assistant", responseText);  
  
      } catch (e) {  
        done();  
        hideTyping();  
          
        const errType = e?.name === "AbortError" ? "Timeout (30s)" : "Network Error";  
        const errMsg = e?.message || String(e);  
          
        addMsg("assistant",   
          "âŒ " + errType + "\n\n" + errMsg +   
          "\n\náƒ¨áƒ”áƒ¡áƒáƒ«áƒšáƒ áƒ›áƒ˜áƒ–áƒ”áƒ–áƒ”áƒ‘áƒ˜:\nâ€¢ Backend offline-áƒ˜áƒ\nâ€¢ CORS áƒáƒ  áƒáƒ áƒ˜áƒ¡ configured\nâ€¢ Route áƒáƒ  áƒáƒ áƒ¡áƒ”áƒ‘áƒáƒ‘áƒ¡ (/api/ai)\nâ€¢ Timeout (áƒ«áƒáƒšáƒ˜áƒáƒœ áƒ’áƒ áƒ«áƒ”áƒšáƒ˜ áƒáƒ áƒáƒªáƒ”áƒ¡áƒ˜)"  
        );  
          
        chatStatus.innerHTML = '<span class="dangerText">Status: failed</span>';  
      } finally {  
        isSending = false;  
        btnSend.disabled = false;  
      }  
    }  
  
    prompt.addEventListener("keydown", (e) => {  
      if (e.key === "Enter" && !e.shiftKey) {  
        e.preventDefault();  
        sendChat();  
      }  
    });  
  
    btnSend.addEventListener("click", sendChat);  
  
    btnClear.addEventListener("click", () => {  
      if (!confirm("Clear all chat history? This cannot be undone.")) return;  
      localStorage.removeItem(KEY.CHAT);  
      msgs.innerHTML = '<div class="bubble ai">âœ… Chat history cleared.</div>';  
      log(syslog, "Chat cleared.");  
    });  
  
    // ==================== INITIALIZATION ====================  
      
    (async function init() {  
      setLog(syslog, "[boot] Avatar G Workspace loaded");  
      updateChips();  
  
      // Load saved chat  
      loadChat();  
  
      const cfg = getCfg();  
        
      // Auto-init Supabase if configured  
      if (cfg.supabaseUrl && cfg.supabaseAnon) {  
        ensureSupabase();  
        await readUser();  
  
        // Listen for auth state changes  
        if (supabaseClient) {  
          supabaseClient.auth.onAuthStateChange(async (event, session) => {  
            console.log("[auth]", event, session?.user?.email);  
            currentUser = session?.user || null;  
            updateChips();  
              
            if (event === "SIGNED_IN" && currentUser) {  
              log(syslog, "âœ… Auth: Signed in as " + currentUser.email);  
            } else if (event === "SIGNED_OUT") {  
              log(syslog, "âœ… Auth: Signed out");  
            }  
          });  
        }  
      } else {  
        log(syslog, "âš ï¸ Supabase not configured. Open Settings to connect.");  
      }  
  
      if (cfg.apiBase) {  
        log(syslog, "âœ… API_BASE loaded: " + cfg.apiBase);  
      } else {  
        log(syslog, "âš ï¸ API_BASE not set. Open Settings.");  
      }  
  
      log(syslog, "âœ… Ready. Test backend or start chatting!");  
    })();  
  </script>  
</body>  
</html>


