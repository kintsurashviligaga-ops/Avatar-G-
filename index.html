<!doctype html>
<html lang="ka">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Avatar G â€” Workspace</title>
  <meta name="theme-color" content="#06121a" />

  <!-- Basic hardening (best-effort for static HTML) -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="referrer" content="no-referrer" />

  <style>
    :root{
      --bg1:#06121a;
      --bg2:#0a2533;
      --card:rgba(0,0,0,.35);
      --card2:rgba(255,255,255,.06);
      --line:rgba(255,255,255,.10);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.68);
      --danger:#ff4d4d;
      --warn:#ffc107;
      --ok:#46e6a1;
      --cyan:#22d3ee;
      --blue:#3b82f6;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --radius: 18px;
      --radius2: 14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
      background:
        radial-gradient(1200px 800px at 20% 20%, rgba(34,211,238,.14), transparent 60%),
        radial-gradient(900px 700px at 70% 30%, rgba(59,130,246,.12), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      overflow-x:hidden;
    }
    .wrap{
      min-height:100vh;
      display:flex;
      align-items:flex-end;
      justify-content:center;
      padding: 18px 14px 24px;
    }
    .panel{
      width:min(1040px, 100%);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      overflow:hidden;
      backdrop-filter: blur(10px);
      position:relative;
      padding-bottom: env(safe-area-inset-bottom);
    }
    .top{
      display:flex;
      gap:14px;
      align-items:center;
      padding:18px 18px 10px;
    }
    .logo{
      width:44px;height:44px;border-radius:14px;
      background: radial-gradient(circle at 30% 30%, rgba(34,211,238,.9), rgba(59,130,246,.7));
      box-shadow: 0 12px 30px rgba(34,211,238,.12);
      border:1px solid rgba(255,255,255,.16);
      flex:0 0 auto;
      position:relative;
      overflow:hidden;
    }
    .logo:after{
      content:"";
      position:absolute; inset:-30%;
      background: radial-gradient(circle at 30% 35%, rgba(255,255,255,.30), transparent 55%);
      transform: rotate(18deg);
    }
    .title{display:flex;flex-direction:column;line-height:1.1;}
    .title h1{font-size:18px;margin:0 0 4px;font-weight:780;letter-spacing:.2px;}
    .title p{margin:0;color:var(--muted);font-size:13px;}

    .chips{margin-left:auto;display:flex;flex-wrap:wrap;gap:8px;justify-content:flex-end;}
    .chip{
      font-size:12px;color:rgba(255,255,255,.82);
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      padding:7px 10px;border-radius:999px;white-space:nowrap;
    }
    .chip.ok{border-color:rgba(70,230,161,.25); background:rgba(70,230,161,.08)}
    .chip.bad{border-color:rgba(255,77,77,.25); background:rgba(255,77,77,.08)}

    .row{display:flex;gap:10px;padding: 10px 18px 18px;flex-wrap:wrap;}
    .btn{
      border:none;border-radius: 14px;padding: 12px 14px;font-weight:750;
      color:rgba(255,255,255,.92);
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      cursor:pointer;user-select:none;-webkit-tap-highlight-color: transparent;
      display:inline-flex;gap:10px;align-items:center;
      transition: transform .08s ease, background .2s ease, border-color .2s ease, opacity .2s ease;
    }
    .btn.primary{
      background: linear-gradient(90deg, rgba(34,211,238,.95), rgba(59,130,246,.85));
      border: 1px solid rgba(255,255,255,.18);
      color:#041018;
      box-shadow: 0 12px 30px rgba(34,211,238,.18);
    }
    .btn.danger{background: rgba(255,77,77,.10);border:1px solid rgba(255,77,77,.28);}
    .btn.ghost{background: rgba(0,0,0,.16);}
    .btn:disabled{opacity:.5; cursor:not-allowed}
    .btn:active:not(:disabled){transform:translateY(1px)}
    .grid{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:14px;
      padding: 0 18px 18px;
    }
    @media (max-width: 900px){
      .grid{grid-template-columns:1fr}
      .chips{display:none}
    }
    .card{
      background: rgba(0,0,0,.22);
      border:1px solid var(--line);
      border-radius: var(--radius2);
      padding:14px;
      min-height: 240px;
    }
    .card h2{margin:0 0 10px;font-size:14px;color:rgba(255,255,255,.90);letter-spacing:.2px;}
    .muted{color:var(--muted);font-size:13px}
    .klist{margin:10px 0 0; padding:0 0 0 18px; color:var(--muted); font-size:13px}
    .klist li{margin:6px 0}
    .log{
      margin-top:10px;
      background: rgba(0,0,0,.28);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 12px;
      padding:10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;
      color:rgba(255,255,255,.82);
      max-height: 160px;
      overflow:auto;
      white-space:pre-wrap;
    }

    /* Chat */
    .chatBox{display:flex; flex-direction:column; gap:10px; min-height: 420px;}
    .chatHeader{display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;}
    .msgs{
      flex:1;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding: 12px;
      overflow:auto;
      max-height: 520px;
      scroll-behavior:smooth;
    }
    .bubble{
      max-width: 92%;
      padding:10px 12px;
      border-radius: 14px;
      margin: 8px 0;
      border:1px solid rgba(255,255,255,.10);
      line-height:1.35;
      font-size:14px;
      white-space:pre-wrap;
      word-break:break-word;
    }
    .me{margin-left:auto; background: rgba(34,211,238,.10); border-color: rgba(34,211,238,.22);}
    .ai{background: rgba(255,255,255,.06);}
    .metaLine{font-size:12px;color:rgba(255,255,255,.62);margin-top:6px;}
    .bubble img{max-width:100%; border-radius:10px; margin-top:8px; display:block; border:1px solid rgba(255,255,255,.08)}
    .typing{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:9px 12px;
      border-radius:14px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      font-size:13px;
      color:var(--muted);
      width:fit-content;
    }
    .dots{display:inline-flex; gap:4px;}
    .dot{width:6px;height:6px;border-radius:99px;background:rgba(255,255,255,.35); animation: b 1.1s infinite ease-in-out;}
    .dot:nth-child(2){animation-delay:.15s}
    .dot:nth-child(3){animation-delay:.3s}
    @keyframes b { 0%,80%,100%{transform:translateY(0);opacity:.55} 40%{transform:translateY(-4px);opacity:1} }

    /* Composer */
    .composer{display:flex;gap:10px;align-items:flex-end;}
    .inputWrap{
      flex:1;
      display:flex;
      gap:10px;
      align-items:flex-end;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      padding:10px;
    }
    textarea{
      width:100%;
      padding:10px 10px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color:rgba(255,255,255,.92);
      outline:none;
      font-size:14px;
      font-family: inherit;
      min-height: 44px;
      max-height: 160px;
      resize: vertical;
    }
    textarea:focus{border-color: rgba(34,211,238,.55);box-shadow: 0 0 0 3px rgba(34,211,238,.15);}

    .iconBtn{
      width:46px;height:46px;border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      display:flex;align-items:center;justify-content:center;
      cursor:pointer;user-select:none;-webkit-tap-highlight-color: transparent;
      transition: transform .08s ease, background .2s ease, opacity .2s ease;
      flex:0 0 auto;
    }
    .iconBtn:active{transform:translateY(1px)}
    .iconBtn.primary{
      background: linear-gradient(90deg, rgba(34,211,238,.95), rgba(59,130,246,.85));
      border: 1px solid rgba(255,255,255,.18);
      color:#041018;
    }
    .iconBtn svg{width:22px;height:22px; opacity:.92}
    .small{font-size:12px; color:rgba(255,255,255,.70);}
    .statusLine{display:inline-flex; align-items:center; gap:8px;}
    .statusDot{width:8px;height:8px;border-radius:999px;background:rgba(255,255,255,.35);}
    .statusDot.idle{background:rgba(255,255,255,.35)}
    .statusDot.sending{background:var(--cyan)}
    .statusDot.success{background:var(--ok)}
    .statusDot.error{background:var(--danger)}

    /* Attachment preview */
    .attachTray{
      display:none;
      margin-top:10px;
      padding:10px;
      border-radius: 14px;
      border:1px dashed rgba(255,255,255,.14);
      background: rgba(0,0,0,.16);
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .attachTray.show{display:flex}
    .attachMeta{display:flex;flex-direction:column;gap:4px;min-width: 0;}
    .attachName{
      font-size:13px;color:rgba(255,255,255,.86);
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width: 100%;
    }
    .attachSub{font-size:12px; color:rgba(255,255,255,.62)}
    .attachActions{display:flex; gap:8px; flex:0 0 auto;}
    .pill{
      font-size:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      padding:8px 10px;
      border-radius: 999px;
      cursor:pointer;
      user-select:none;
    }

    /* Audio card */
    .audioCard{
      display:none;
      margin-top:10px;
      padding:12px;
      border-radius: 14px;
      border:1px solid rgba(34,211,238,.18);
      background: rgba(34,211,238,.06);
      gap:10px;
    }
    .audioCard.show{display:block}
    .audioRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .audioTitle{
      font-size:12px;
      color:rgba(255,255,255,.78);
      display:flex;
      gap:8px;
      align-items:center;
    }
    audio{width:100%;margin-top:10px;border-radius: 12px;outline:none;}

    /* Modal */
    .modalBack{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(4px);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:9999;
    }
    .modalBack.show{display:flex}
    .modal{
      width:min(760px, 100%);
      max-height: 90vh;
      overflow:auto;
      border-radius: 18px;
      background: linear-gradient(180deg, rgba(10,25,35,.98), rgba(6,18,26,.98));
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 22px 80px rgba(0,0,0,.6);
    }
    .modalHead{
      display:flex;
      align-items:center;
      gap:10px;
      padding:14px 14px 10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      position:sticky;top:0;
      background: rgba(6,18,26,.95);
      backdrop-filter: blur(8px);
      z-index:1;
    }
    .modalHead h3{margin:0; font-size:14px; font-weight:780;}
    .modalHead .x{
      margin-left:auto;
      width:40px;height:40px;border-radius: 12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      cursor:pointer;color:rgba(255,255,255,.88);
      font-size:18px;display:flex;align-items:center;justify-content:center;
    }
    .modalBody{padding:14px}
    .field{margin-bottom:12px;}
    .label{font-size:12px;color:rgba(255,255,255,.75);margin:0 0 6px;display:block;}
    input, select{
      width:100%;
      padding:12px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      color:rgba(255,255,255,.92);
      outline:none;font-size:14px;font-family: inherit;
    }
    input:focus, select:focus{
      border-color: rgba(34,211,238,.55);
      box-shadow: 0 0 0 3px rgba(34,211,238,.15);
    }
    .modalActions{
      display:flex; gap:10px; justify-content:flex-end;
      padding: 12px 14px 14px;
      border-top:1px solid rgba(255,255,255,.10);
      flex-wrap:wrap;
    }
    .hint{
      margin-top:8px;
      padding:10px;
      border-radius: 14px;
      border:1px dashed rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color:rgba(255,255,255,.74);
      font-size:12px;
      line-height:1.4;
    }
    .warning{
      margin-top:8px;
      padding:10px;
      border-radius: 14px;
      border:1px solid rgba(255,193,7,.3);
      background: rgba(255,193,7,.08);
      color:rgba(255,240,180,.95);
      font-size:12px;
      line-height:1.4;
    }
    .cfgBadge{
      display:inline-flex;align-items:center;gap:8px;
      margin-top:8px;padding:8px 10px;border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.18);
      font-size:12px;color:rgba(255,255,255,.78);
    }
    .cfgBadge.ok{border-color:rgba(70,230,161,.25);background:rgba(70,230,161,.08)}
    .cfgBadge.bad{border-color:rgba(255,77,77,.25);background:rgba(255,77,77,.08)}
    .twoCol{display:grid;grid-template-columns: 1fr 1fr;gap:12px;}
    @media (max-width: 720px){.twoCol{grid-template-columns:1fr}}
  </style>

  <!-- Supabase -->
  <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
  <div class="wrap">
    <div class="panel">
      <div class="top">
        <div class="logo" aria-hidden="true"></div>
        <div class="title">
          <h1>Avatar G Workspace</h1>
          <p>Production Frontend â€” Connect & Chat</p>
        </div>
        <div class="chips" id="chips" aria-label="System status chips">
          <div class="chip" id="chipMode">Mode: Ready</div>
          <div class="chip" id="chipApi">API: not set</div>
          <div class="chip" id="chipSb">Supabase: not set</div>
          <div class="chip" id="chipUser">User: guest</div>
        </div>
      </div>

      <div class="row">
        <button class="btn" id="btnSettings" type="button">âš™ï¸ Settings</button>
        <button class="btn" id="btnTest" type="button">ğŸ” Test Backend</button>
        <button class="btn primary" id="btnConnect" type="button">ğŸ” Connect / Sign in</button>
        <button class="btn danger" id="btnLogout" type="button" style="display:none">Logout</button>
      </div>

      <div class="grid">
        <div class="card">
          <h2>âœ… áƒ¡áƒ˜áƒ¡áƒ¢áƒ”áƒ›áƒ˜áƒ¡ áƒ¡áƒ¢áƒáƒ¢áƒ£áƒ¡áƒ˜</h2>
          <div class="muted">
            áƒáƒ¥ áƒ¨áƒ”áƒ’áƒ˜áƒ«áƒšáƒ˜áƒ:
            <ul class="klist">
              <li>áƒ“áƒáƒáƒ§áƒ”áƒœáƒ Supabase URL + anon key + API_BASE</li>
              <li>áƒ¨áƒ”áƒáƒ›áƒáƒ¬áƒ›áƒ backend health (/api/health)</li>
              <li>áƒ’áƒáƒ˜áƒáƒ áƒ Magic Link Login (email)</li>
              <li>áƒ’áƒáƒ›áƒáƒ˜áƒ§áƒ”áƒœáƒ Chat â€” áƒ áƒáƒ›áƒ”áƒšáƒ˜áƒª backend-áƒ¡ áƒ”áƒ«áƒáƒ®áƒ˜áƒ¡</li>
            </ul>
          </div>
          <div class="hint">
            âœ… <b>Tip:</b> áƒ—áƒ£ "Failed to fetch" áƒ©áƒáƒœáƒ¡, áƒ”áƒ¡ áƒ®áƒ¨áƒ˜áƒ áƒáƒ“ áƒáƒ áƒ˜áƒ¡:<br/>
            â€¢ CORS áƒáƒ áƒáƒ‘áƒšáƒ”áƒ›áƒ (backend áƒ£áƒœáƒ“áƒ allow-áƒ”áƒ‘áƒ“áƒ”áƒ¡ áƒ—áƒ¥áƒ•áƒ”áƒœáƒ¡ frontend domain-áƒ¡)<br/>
            â€¢ API_BASE áƒáƒ áƒáƒ¡áƒ¬áƒáƒ áƒ˜áƒ (áƒ›áƒáƒ’: https://avatarg-backend.vercel.app)<br/>
            â€¢ Backend offline-áƒ˜áƒ áƒáƒœ route áƒáƒ  áƒáƒ áƒ¡áƒ”áƒ‘áƒáƒ‘áƒ¡
          </div>
          <div class="log" id="syslog">[boot] Page loadedâ€¦</div>
        </div>

        <div class="card">
          <div class="chatHeader">
            <h2>ğŸ’¬ Chat</h2>
            <div style="display:flex; gap:10px;">
              <button class="btn ghost" id="btnMusic" type="button" style="padding:8px 12px; font-size:12px">ğŸµ Music</button>
              <button class="btn danger" id="btnClear" type="button" style="padding:8px 12px; font-size:12px">ğŸ—‘ Clear</button>
            </div>
          </div>

          <div class="chatBox">
            <div class="msgs" id="msgs" aria-live="polite" aria-label="Chat messages">
              <div class="bubble ai">ğŸ‘‹ áƒ’áƒáƒ›áƒáƒ áƒ¯áƒáƒ‘áƒ! áƒ’áƒáƒáƒ¥áƒ¢áƒ˜áƒ£áƒ áƒ” backend connection áƒ“áƒ áƒ“áƒáƒ˜áƒ¬áƒ§áƒ” áƒ©áƒáƒ¢áƒ˜.</div>
            </div>

            <div class="audioCard" id="audioCard">
              <div class="audioRow">
                <div class="audioTitle">ğŸ§ Generated Audio (Compose)</div>
                <div style="display:flex; gap:10px;">
                  <button class="btn ghost" id="btnComposeFromLast" type="button" style="padding:8px 12px; font-size:12px">ğŸª„ Compose last lyrics</button>
                  <button class="btn" id="btnDownloadAudio" type="button" style="padding:8px 12px; font-size:12px">â¬‡ï¸ Download</button>
                </div>
              </div>
              <audio id="audioPlayer" controls autoplay></audio>
              <div class="small" id="audioMeta" style="margin-top:6px; opacity:.8"></div>
            </div>

            <div class="attachTray" id="attachTray" aria-label="Attachment preview">
              <div class="attachMeta">
                <div class="attachName" id="attachName">file</div>
                <div class="attachSub" id="attachSub">Ready to send</div>
              </div>
              <div class="attachActions">
                <div class="pill" id="btnAttachRemove" role="button" tabindex="0">Remove</div>
              </div>
            </div>

            <div class="composer">
              <div class="inputWrap">
                <textarea id="prompt" placeholder="áƒ“áƒáƒ¬áƒ”áƒ áƒ” áƒ›áƒ”áƒ¡áƒ˜áƒ¯áƒ˜â€¦ (Enter = send, Shift+Enter = new line)"></textarea>

                <div class="iconBtn" id="btnAttach" title="Attach file" role="button" tabindex="0" aria-label="Attach file">
                  <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path d="M21 12.5V17a4 4 0 0 1-4 4H7a5 5 0 0 1 0-10h11a3 3 0 0 1 0 6H9a1 1 0 0 1 0-2h9a1 1 0 0 0 0-2H7a3 3 0 0 0 0 6h10a2 2 0 0 0 2-2v-4.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </div>

                <div class="iconBtn" id="btnMusicMini" title="Music prompt builder" role="button" tabindex="0" aria-label="Open music prompt builder">
                  <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path d="M9 18V6l12-2v12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <circle cx="7" cy="18" r="3" stroke="currentColor" stroke-width="2"/>
                    <circle cx="19" cy="16" r="3" stroke="currentColor" stroke-width="2"/>
                  </svg>
                </div>

                <div class="iconBtn" id="btnCompose" title="Compose lyrics to audio" role="button" tabindex="0" aria-label="Compose to audio">
                  <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path d="M12 3v18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <path d="M5 8h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <path d="M7 21h10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  </svg>
                </div>
              </div>

              <div class="iconBtn primary" id="btnSend" title="Send" role="button" tabindex="0" aria-label="Send message">
                <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M22 2L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M22 2L15 22l-4-9-9-4 20-7Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </div>

              <input id="fileInput" type="file" style="display:none" />
            </div>

            <div class="small" id="chatStatus" style="margin-top:6px">
              <span class="statusLine">
                <span class="statusDot idle" id="statusDot"></span>
                <span id="statusText">Status: idle</span>
              </span>
              <span style="float:right; opacity:.7" id="apiLine"></span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modalBack" id="cfgModalBack" role="dialog" aria-modal="true" aria-label="Settings modal">
    <div class="modal">
      <div class="modalHead">
        <h3>âš™ï¸ Connect Avatar G</h3>
        <button class="x" id="btnCfgClose" aria-label="Close" type="button">Ã—</button>
      </div>

      <div class="modalBody">
        <div class="small" style="margin-bottom:10px">
          Paste your config once â€” saved in localStorage (this browser only).
        </div>

        <div class="field">
          <label class="label" for="sbUrl">SUPABASE_URL</label>
          <input id="sbUrl" type="url" inputmode="url" placeholder="https://xxxx.supabase.co" autocomplete="off" />
        </div>

        <div class="field">
          <label class="label" for="apiBase">API_BASE (backend domain)</label>
          <input id="apiBase" type="url" inputmode="url" placeholder="https://avatarg-backend.vercel.app" autocomplete="off" />
          <div class="cfgBadge" id="apiBadge">API_BASE: not checked</div>
        </div>

        <div class="field">
          <label class="label" for="sbAnon">SUPABASE_ANON_KEY (public key only)</label>
          <textarea id="sbAnon" rows="3" placeholder="eyJhbGciOi..." autocomplete="off"></textarea>
        </div>

        <div class="warning">
          âš ï¸ <b>Security Warning:</b><br/>
          â€¢ áƒáƒ¥ áƒ©áƒáƒ¡áƒ•áƒ˜ áƒ›áƒ®áƒáƒšáƒáƒ“ <b>anon public key</b> (áƒ©áƒ•áƒ”áƒ£áƒšáƒ”áƒ‘áƒ áƒ˜áƒ• áƒ˜áƒ¬áƒ§áƒ”áƒ‘áƒ: <b>eyJhbGciOi</b>)<br/>
          â€¢ <b>áƒáƒ áƒáƒ¡áƒ“áƒ áƒáƒ¡ áƒ©áƒáƒ¡áƒ•áƒ service_role</b> â€” áƒ”áƒ¡ áƒáƒ áƒ˜áƒ¡ áƒ¡áƒáƒ˜áƒ“áƒ£áƒ›áƒšáƒ áƒ’áƒáƒ¡áƒáƒ¦áƒ”áƒ‘áƒ˜ áƒ“áƒ áƒ¨áƒ”áƒ£áƒ«áƒšáƒ˜áƒ áƒáƒ áƒáƒ”áƒ¥áƒ¢áƒ˜áƒ¡ áƒ¡áƒ áƒ£áƒšáƒáƒ“ áƒ’áƒáƒ¢áƒ”áƒ®áƒ•áƒ<br/>
          â€¢ áƒ”áƒ¡ áƒ›áƒœáƒ˜áƒ¨áƒ•áƒœáƒ”áƒšáƒáƒ‘áƒ”áƒ‘áƒ˜ áƒ˜áƒœáƒáƒ®áƒ”áƒ‘áƒ áƒ›áƒ®áƒáƒšáƒáƒ“ localStorage-áƒ¨áƒ˜ (áƒáƒ› áƒ‘áƒ áƒáƒ£áƒ–áƒ”áƒ áƒ¨áƒ˜)
        </div>

        <div class="hint">
          ğŸ“ Attach limit: <b>5MB</b> (images show inline; other files send as note).<br/>
          ğŸ§  Chat context: last <b>6 turns</b> (to keep backend fast).
        </div>

        <div class="log" id="cfglog">[cfg] Readyâ€¦</div>
      </div>

      <div class="modalActions">
        <button class="btn" id="btnReset" type="button">ğŸ—‘ Reset</button>
        <button class="btn primary" id="btnSave" type="button">ğŸ’¾ Save & Continue</button>
      </div>
    </div>
  </div>

  <!-- Music Modal -->
  <div class="modalBack" id="musicModalBack" role="dialog" aria-modal="true" aria-label="Music builder modal">
    <div class="modal">
      <div class="modalHead">
        <h3>ğŸµ Music Prompt Builder (Suno-ready)</h3>
        <button class="x" id="btnMusicClose" aria-label="Close" type="button">Ã—</button>
      </div>

      <div class="modalBody">
        <div class="twoCol">
          <div class="field">
            <label class="label">Mood</label>
            <select id="mood">
              <option>Uplifting / modern</option>
              <option>Happy / festive</option>
              <option>Cinematic / epic</option>
              <option>Chill / cozy</option>
              <option>Energetic / club</option>
              <option>Emotional / soulful</option>
            </select>
          </div>
          <div class="field">
            <label class="label">Language</label>
            <select id="lang">
              <option>Georgian</option>
              <option>English</option>
              <option>Russian</option>
            </select>
          </div>
        </div>

        <div class="twoCol">
          <div class="field">
            <label class="label">Genre</label>
            <select id="genre">
              <option>Pop / Cinematic</option>
              <option>R&B / Soul</option>
              <option>Hip-hop / Trap</option>
              <option>EDM / House</option>
              <option>Rock / Alternative</option>
              <option>Lo-fi / Chill</option>
            </select>
          </div>
          <div class="field">
            <label class="label">Topic</label>
            <input id="topic" placeholder="Avatar G platform promo" value="Avatar G platform promo"/>
          </div>
        </div>

        <div class="field">
          <label class="label">Must include (optional)</label>
          <input id="must" placeholder="e.g., New Year vibe, business CTA, Tbilisi"/>
        </div>

        <div class="field">
          <label class="label">Generated prompt</label>
          <textarea id="musicOut" rows="6" placeholder="Click Generate..."></textarea>
          <div class="hint">
            Tip: â€œInsert to Chatâ€ áƒ©áƒáƒ¡áƒ•áƒáƒ›áƒ¡ prompt-áƒ¡ áƒ©áƒáƒ¢áƒ¨áƒ˜. áƒ›áƒ”áƒ áƒ” Send.
          </div>
        </div>
      </div>

      <div class="modalActions">
        <button class="btn" id="btnMusicGen" type="button">Generate</button>
        <button class="btn primary" id="btnMusicInsert" type="button">Insert to Chat</button>
      </div>
    </div>
  </div>

  <script>
    (function () {
      "use strict";

      const KEY = {
        SUPABASE_URL: "AVATARG_SUPABASE_URL",
        SUPABASE_ANON: "AVATARG_SUPABASE_ANON",
        API_BASE: "AVATARG_API_BASE",
        CHAT: "AVATARG_CHAT_LOG",
        SEEN_CFG_HINT: "AVATARG_SEEN_CFG_HINT"
      };

      const DEFAULT_API_BASE = "https://avatarg-backend.vercel.app";
      const CHAT_HISTORY_LIMIT = 80;
      const CHAT_CONTEXT_TURNS = 6;
      const TIMEOUT_HEALTH_MS = 10000;
      const TIMEOUT_AI_MS = 45000;
      const TIMEOUT_COMPOSE_MS = 60000;
      const MAX_FILE_BYTES = 5 * 1024 * 1024;

      const syslog = document.getElementById("syslog");
      const cfglog = document.getElementById("cfglog");

      const chipMode = document.getElementById("chipMode");
      const chipApi = document.getElementById("chipApi");
      const chipSb = document.getElementById("chipSb");
      const chipUser = document.getElementById("chipUser");

      const btnSettings = document.getElementById("btnSettings");
      const btnTest = document.getElementById("btnTest");
      const btnConnect = document.getElementById("btnConnect");
      const btnLogout = document.getElementById("btnLogout");

      const cfgModalBack = document.getElementById("cfgModalBack");
      const btnCfgClose = document.getElementById("btnCfgClose");
      const btnSave = document.getElementById("btnSave");
      const btnReset = document.getElementById("btnReset");

      const sbUrl = document.getElementById("sbUrl");
      const sbAnon = document.getElementById("sbAnon");
      const apiBase = document.getElementById("apiBase");
      const apiBadge = document.getElementById("apiBadge");

      const msgs = document.getElementById("msgs");
      const prompt = document.getElementById("prompt");
      const btnSend = document.getElementById("btnSend");
      const btnClear = document.getElementById("btnClear");
      const statusDot = document.getElementById("statusDot");
      const statusText = document.getElementById("statusText");
      const apiLine = document.getElementById("apiLine");

      const btnAttach = document.getElementById("btnAttach");
      const fileInput = document.getElementById("fileInput");
      const attachTray = document.getElementById("attachTray");
      const attachName = document.getElementById("attachName");
      const attachSub = document.getElementById("attachSub");
      const btnAttachRemove = document.getElementById("btnAttachRemove");

      const btnMusic = document.getElementById("btnMusic");
      const btnMusicMini = document.getElementById("btnMusicMini");
      const musicModalBack = document.getElementById("musicModalBack");
      const btnMusicClose = document.getElementById("btnMusicClose");
      const btnMusicGen = document.getElementById("btnMusicGen");
      const btnMusicInsert = document.getElementById("btnMusicInsert");
      const mood = document.getElementById("mood");
      const lang = document.getElementById("lang");
      const genre = document.getElementById("genre");
      const topic = document.getElementById("topic");
      const must = document.getElementById("must");
      const musicOut = document.getElementById("musicOut");

      const audioCard = document.getElementById("audioCard");
      const audioPlayer = document.getElementById("audioPlayer");
      const audioMeta = document.getElementById("audioMeta");
      const btnCompose = document.getElementById("btnCompose");
      const btnComposeFromLast = document.getElementById("btnComposeFromLast");
      const btnDownloadAudio = document.getElementById("btnDownloadAudio");

      let supabaseClient = null;
      let currentUser = null;
      let isSending = false;
      let chatHistory = [];
      let attached = null;

      // Audio state
      let audioUrl = "";
      let lastAudioBlob = null;
      let lastAudioExt = "mp3";

      function safeText(str) { return String(str ?? "").replace(/\0/g, "").trim(); }
      function normalizeUrl(url) { return String(url || "").trim().replace(/\/+$/, ""); }
      function isLocalhost(u) { return /^http:\/\/(localhost|127\.0\.0\.1)(:\d+)?$/i.test(u); }

      function isValidApiBase(url) {
        if (!url) return false;
        const normalized = normalizeUrl(url);
        try {
          const u = new URL(normalized);
          if (u.protocol === "https:") return true;
          if (u.protocol === "http:" && isLocalhost(normalized)) return true;
          return false;
        } catch { return false; }
      }

      function setStatus(text, type = "idle") {
        if (statusText) statusText.textContent = safeText(text);
        if (statusDot) {
          statusDot.classList.remove("idle", "sending", "success", "error");
          statusDot.classList.add(type);
        }
      }

      function log(el, text) {
        if (!el) return;
        const ts = new Date().toLocaleTimeString();
        el.textContent += "\n[" + ts + "] " + safeText(text);
        el.scrollTop = el.scrollHeight;
      }

      function setLog(el, text) {
        if (!el) return;
        el.textContent = safeText(text);
        el.scrollTop = el.scrollHeight;
      }

      function withTimeout(ms) {
        const ctrl = new AbortController();
        const t = setTimeout(() => ctrl.abort(), ms);
        return { ctrl, done: () => clearTimeout(t) };
      }

      function explainFetchFailure(err, resStatus) {
        const msg = String(err?.message || err || "").toLowerCase();
        if (err?.name === "AbortError") return "Request Timeout â€” áƒ¡áƒªáƒáƒ“áƒ” áƒ™áƒ˜áƒ“áƒ”áƒ• áƒ”áƒ áƒ—áƒ®áƒ”áƒš áƒáƒœ áƒ’áƒáƒáƒ›áƒáƒ™áƒšáƒ” áƒ¢áƒ”áƒ¥áƒ¡áƒ¢áƒ˜.";
        if (msg.includes("failed to fetch") || msg.includes("network")) return "Network/CORS Error â€” áƒ®áƒ¨áƒ˜áƒ áƒáƒ“ áƒ”áƒ¡ áƒáƒ áƒ˜áƒ¡ CORS áƒáƒœ API_BASE áƒáƒ áƒáƒ¡áƒ¬áƒáƒ áƒ˜áƒ.";
        if (typeof resStatus === "number" && resStatus >= 400) return "Backend Error â€” áƒ¡áƒ”áƒ áƒ•áƒ”áƒ áƒ›áƒ áƒ“áƒáƒáƒ‘áƒ áƒ£áƒœáƒ áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ. áƒ’áƒáƒ“áƒáƒáƒ›áƒáƒ¬áƒ›áƒ” route áƒ“áƒ áƒšáƒáƒ’áƒ”áƒ‘áƒ˜.";
        return "Request Failed â€” áƒ£áƒªáƒœáƒáƒ‘áƒ˜ áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ. áƒ’áƒáƒ“áƒáƒáƒ›áƒáƒ¬áƒ›áƒ” backend áƒ“áƒ CORS.";
      }

      function humanSize(bytes) {
        const b = Number(bytes || 0);
        if (b < 1024) return b + " B";
        if (b < 1024 * 1024) return (b / 1024).toFixed(1) + " KB";
        return (b / (1024 * 1024)).toFixed(2) + " MB";
      }

      function getCfg() {
        const storedApi = normalizeUrl(localStorage.getItem(KEY.API_BASE) || "");
        const api = storedApi ? storedApi : DEFAULT_API_BASE;
        return {
          supabaseUrl: normalizeUrl(localStorage.getItem(KEY.SUPABASE_URL) || ""),
          supabaseAnon: (localStorage.getItem(KEY.SUPABASE_ANON) || "").trim(),
          apiBase: normalizeUrl(api)
        };
      }

      function saveCfg(cfg) {
        localStorage.setItem(KEY.SUPABASE_URL, normalizeUrl(cfg.supabaseUrl || ""));
        localStorage.setItem(KEY.SUPABASE_ANON, (cfg.supabaseAnon || "").trim());
        localStorage.setItem(KEY.API_BASE, normalizeUrl(cfg.apiBase || DEFAULT_API_BASE));
      }

      function resetCfg() {
        localStorage.removeItem(KEY.SUPABASE_URL);
        localStorage.removeItem(KEY.SUPABASE_ANON);
        localStorage.removeItem(KEY.API_BASE);
      }

      function updateApiBadge() {
        if (!apiBadge || !apiBase) return;
        const val = normalizeUrl(apiBase.value);
        apiBadge.classList.remove("ok", "bad");
        if (!val) { apiBadge.textContent = "API_BASE: empty (will use default)"; return; }
        if (isValidApiBase(val)) {
          apiBadge.textContent = "API_BASE: âœ“ valid";
          apiBadge.classList.add("ok");
        } else {
          apiBadge.textContent = "API_BASE: âœ• invalid (https:// required, except http://localhost)";
          apiBadge.classList.add("bad");
        }
      }

      function updateChips() {
        const cfg = getCfg();

        if (chipMode) {
          chipMode.textContent = currentUser ? "Mode: Authenticated" : "Mode: Ready";
          chipMode.classList.toggle("ok", !!currentUser);
        }
        if (chipApi) {
          if (cfg.apiBase && isValidApiBase(cfg.apiBase)) {
            chipApi.textContent = "API: âœ“";
            chipApi.classList.add("ok"); chipApi.classList.remove("bad");
          } else {
            chipApi.textContent = "API: not set";
            chipApi.classList.remove("ok");
            chipApi.classList.toggle("bad", !!cfg.apiBase);
          }
        }
        if (chipSb) {
          if (cfg.supabaseUrl && cfg.supabaseAnon) {
            chipSb.textContent = "Supabase: âœ“";
            chipSb.classList.add("ok"); chipSb.classList.remove("bad");
          } else {
            chipSb.textContent = "Supabase: not set";
            chipSb.classList.remove("ok"); chipSb.classList.remove("bad");
          }
        }
        if (chipUser) {
          if (currentUser?.email) {
            chipUser.textContent = "User: " + safeText(currentUser.email.split("@")[0]);
            chipUser.classList.add("ok");
            if (btnLogout) btnLogout.style.display = "inline-flex";
            if (btnConnect) btnConnect.textContent = "ğŸ” Re-connect";
          } else {
            chipUser.textContent = "User: guest";
            chipUser.classList.remove("ok");
            if (btnLogout) btnLogout.style.display = "none";
            if (btnConnect) btnConnect.textContent = "ğŸ” Connect / Sign in";
          }
        }

        if (apiLine) apiLine.textContent = "API Base: " + (cfg.apiBase || DEFAULT_API_BASE);
      }

      function openCfg() {
        const cfg = getCfg();
        if (sbUrl) sbUrl.value = cfg.supabaseUrl;
        if (sbAnon) sbAnon.value = cfg.supabaseAnon;
        if (apiBase) apiBase.value = cfg.apiBase || DEFAULT_API_BASE;
        setLog(cfglog, "[cfg] Paste values and Saveâ€¦");
        updateApiBadge();
        if (cfgModalBack) cfgModalBack.classList.add("show");
        setTimeout(() => sbUrl && sbUrl.focus(), 120);
      }
      function closeCfg() { if (cfgModalBack) cfgModalBack.classList.remove("show"); }

      function openMusic() { if (musicModalBack) musicModalBack.classList.add("show"); setTimeout(() => musicOut && musicOut.focus(), 120); }
      function closeMusic() { if (musicModalBack) musicModalBack.classList.remove("show"); }

      function addClickAndKey(el, fn) {
        if (!el) return;
        el.addEventListener("click", fn);
        el.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") { e.preventDefault(); fn(); }
        });
      }

      if (btnSettings) btnSettings.addEventListener("click", openCfg);
      if (btnCfgClose) btnCfgClose.addEventListener("click", closeCfg);
      if (cfgModalBack) cfgModalBack.addEventListener("click", (e) => { if (e.target === cfgModalBack) closeCfg(); });
      if (apiBase) apiBase.addEventListener("input", updateApiBadge);

      if (btnMusic) btnMusic.addEventListener("click", openMusic);
      if (btnMusicMini) btnMusicMini.addEventListener("click", openMusic);
      if (btnMusicClose) btnMusicClose.addEventListener("click", closeMusic);
      if (musicModalBack) musicModalBack.addEventListener("click", (e) => { if (e.target === musicModalBack) closeMusic(); });

      // âœ… FIXED: Robust response extraction (handles {ok:true,result:{...}} + multiple formats)
      function extractResponse(data) {
        if (!data) return "(empty)";
        if (typeof data === "string") return data;

        const root = (data && typeof data === "object" && ("result" in data)) ? (data.result ?? data) : data;

        const content =
          root?.choices?.[0]?.message?.content ??
          root?.choices?.[0]?.delta?.content ??
          root?.output_text ??
          root?.text ??
          root?.reply ??
          root?.message ??
          root?.data?.text ??
          root?.data?.message;

        if (typeof content === "string" && content.trim()) return content.trim();

        if (Array.isArray(root?.content) && root.content[0]?.text) return String(root.content[0].text);

        try { return JSON.stringify(root, null, 2); } catch { return String(root); }
      }

      function buildMusicPrompt() {
        const m = safeText(mood?.value);
        const l = safeText(lang?.value);
        const g = safeText(genre?.value);
        const t = safeText(topic?.value || "Avatar G platform promo");
        const x = safeText(must?.value);

        const langLine = (l === "Georgian") ? "Language: Georgian (ka)" : (l === "Russian") ? "Language: Russian" : "Language: English";
        const extras = x ? ("\nMust include: " + x) : "";

        return [
          "SUNO PROMPT (ready):",
          "Mood: " + m,
          "Genre: " + g,
          langLine,
          "Topic: " + t + extras,
          "",
          "Write catchy, short-to-medium lyrics with a clear chorus and a friendly business CTA for Avatar G.",
          "Keep it modern, memorable, and easy to sing. Avoid explicit content."
        ].join("\n");
      }

      if (btnMusicGen) {
        btnMusicGen.addEventListener("click", () => {
          const generated = buildMusicPrompt();
          if (musicOut) musicOut.value = generated;
        });
      }

      if (btnMusicInsert) {
        btnMusicInsert.addEventListener("click", () => {
          if (!musicOut || !prompt) return;
          const v = safeText(musicOut.value);
          if (!v) return;
          prompt.value = (prompt.value ? prompt.value.trim() + "\n\n" : "") + v;
          prompt.focus();
          closeMusic();
        });
      }

      if (btnSave) {
        btnSave.addEventListener("click", () => {
          const cfg = {
            supabaseUrl: sbUrl ? sbUrl.value.trim() : "",
            supabaseAnon: sbAnon ? sbAnon.value.trim() : "",
            apiBase: apiBase ? apiBase.value.trim() : ""
          };

          const normalizedApi = normalizeUrl(cfg.apiBase);
          if (normalizedApi && !isValidApiBase(normalizedApi)) {
            setLog(cfglog, "âŒ API_BASE must be https:// (or http://localhost for testing)");
            return;
          }
          cfg.apiBase = normalizedApi || DEFAULT_API_BASE;

          if (cfg.supabaseAnon && cfg.supabaseAnon.toLowerCase().includes("service_role")) {
            setLog(cfglog, "âŒ DANGER: This looks like a service_role key! Only use anon key here.");
            return;
          }

          saveCfg(cfg);
          supabaseClient = null;

          setLog(cfglog, "âœ… Config saved! Close and test backend.");
          log(syslog, "Config saved.");
          updateChips();
          setTimeout(closeCfg, 600);
        });
      }

      if (btnReset) {
        btnReset.addEventListener("click", () => {
          if (!confirm("Reset all config? This will clear Supabase + API_BASE settings.")) return;
          resetCfg();
          supabaseClient = null;
          currentUser = null;
          updateChips();
          setLog(cfglog, "âœ… Config reset.");
          log(syslog, "Config reset.");
          if (sbUrl) sbUrl.value = "";
          if (sbAnon) sbAnon.value = "";
          if (apiBase) apiBase.value = "";
          updateApiBadge();
        });
      }

      function ensureSupabase() {
        const cfg = getCfg();
        if (!cfg.supabaseUrl || !cfg.supabaseAnon) {
          log(syslog, "âš ï¸ Supabase not configured. Open Settings.");
          if (chipSb) chipSb.classList.add("bad");
          return null;
        }
        if (!window.supabase || typeof window.supabase.createClient !== "function") {
          log(syslog, "âŒ Supabase SDK not loaded (CDN issue). Refresh or try another network.");
          return null;
        }
        if (!supabaseClient) {
          try {
            supabaseClient = window.supabase.createClient(cfg.supabaseUrl, cfg.supabaseAnon, {
              auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
            });
            log(syslog, "âœ… Supabase client initialized.");
          } catch (e) {
            log(syslog, "âŒ Supabase init error: " + safeText(e?.message || e));
            return null;
          }
        }
        return supabaseClient;
      }

      async function readUser() {
        const sb = ensureSupabase();
        if (!sb) return null;
        try {
          const { data, error } = await sb.auth.getUser();
          if (error) throw error;
          currentUser = data?.user || null;
          updateChips();
          if (currentUser?.email) log(syslog, "âœ… Signed in as: " + safeText(currentUser.email));
          return currentUser;
        } catch (e) {
          log(syslog, "Auth check error: " + safeText(e?.message || e));
          currentUser = null;
          updateChips();
          return null;
        }
      }

      async function magicLinkLogin() {
        const sb = ensureSupabase();
        if (!sb) { openCfg(); return; }
        const email = window.prompt("Enter your email for Magic Link login:");
        if (!email || !email.includes("@")) { if (email) alert("Invalid email format"); return; }
        try {
          log(syslog, "ğŸ“§ Sending magic link to: " + safeText(email));
          const redirectTo = window.location.href.split("?")[0].split("#")[0];
          const { error } = await sb.auth.signInWithOtp({
            email: email.trim(),
            options: { emailRedirectTo: redirectTo }
          });
          if (error) throw error;
          log(syslog, "âœ… Magic link sent! Check your email inbox.");
          alert("âœ… Magic link sent!\n\nCheck your email and click the link.\nOpen it in THIS browser.");
        } catch (e) {
          log(syslog, "âŒ Login error: " + safeText(e?.message || e));
          alert("Login failed: " + safeText(e?.message || e));
        }
      }

      async function logout() {
        const sb = ensureSupabase();
        if (!sb) return;
        try {
          await sb.auth.signOut();
          currentUser = null;
          updateChips();
          log(syslog, "âœ… Signed out.");
        } catch (e) {
          log(syslog, "Sign out error: " + safeText(e?.message || e));
        }
      }

      if (btnConnect) btnConnect.addEventListener("click", async () => {
        const cfg = getCfg();
        if (!cfg.supabaseUrl || !cfg.supabaseAnon) { openCfg(); return; }
        await magicLinkLogin();
      });
      if (btnLogout) btnLogout.addEventListener("click", logout);

      async function testBackend() {
        const cfg = getCfg();
        const base = normalizeUrl(cfg.apiBase || "");
        if (!base || !isValidApiBase(base)) {
          log(syslog, "âš ï¸ API_BASE invalid. Open Settings.");
          if (chipApi) chipApi.classList.add("bad");
          openCfg();
          return;
        }
        const url = base + "/api/health";
        const { ctrl, done } = withTimeout(TIMEOUT_HEALTH_MS);

        try {
          log(syslog, "ğŸ” Testing: " + safeText(url));
          const res = await fetch(url, { method: "GET", signal: ctrl.signal, cache: "no-store" });
          done();

          const text = await res.text().catch(() => "");
          if (!res.ok) {
            if (chipApi) { chipApi.classList.add("bad"); chipApi.classList.remove("ok"); }
            const hint = explainFetchFailure(null, res.status);
            log(syslog, "âŒ Backend error: HTTP " + res.status + " â€” " + safeText(text.substring(0, 200)));
            alert("Backend Error\nHTTP " + res.status + "\n\n" + hint + "\n\nCheck CORS + route: /api/health");
            return;
          }

          if (chipApi) { chipApi.classList.add("ok"); chipApi.classList.remove("bad"); }
          log(syslog, "âœ… Backend OK: " + safeText(text.substring(0, 160)));
          alert("âœ… Backend is online!\n\n" + safeText(text.substring(0, 200)));
        } catch (e) {
          done();
          if (chipApi) { chipApi.classList.add("bad"); chipApi.classList.remove("ok"); }
          const hint = explainFetchFailure(e);
          log(syslog, "âŒ Backend test failed: " + safeText(hint));
          alert("Backend Test Failed\n\n" + hint + "\n\nCommon causes:\nâ€¢ CORS not configured\nâ€¢ Wrong API_BASE URL\nâ€¢ Backend offline");
        }
      }
      if (btnTest) btnTest.addEventListener("click", testBackend);

      function loadChat() {
        try {
          const raw = localStorage.getItem(KEY.CHAT);
          if (!raw) return;
          const arr = JSON.parse(raw);
          if (Array.isArray(arr)) {
            chatHistory = arr
              .filter(x => x && (x.role === "user" || x.role === "assistant") && typeof x.content === "string")
              .slice(-CHAT_HISTORY_LIMIT);
          }
        } catch { }
      }
      function persistChat() {
        try { localStorage.setItem(KEY.CHAT, JSON.stringify(chatHistory.slice(-CHAT_HISTORY_LIMIT))); } catch { }
      }

      function looksLikeDataImage(s) {
        return /data:image\/(png|jpeg|jpg|webp|gif);base64,[A-Za-z0-9+/=]+/i.test(s || "");
      }
      function findFirstDataImage(s) {
        const m = String(s || "").match(/data:image\/(png|jpeg|jpg|webp|gif);base64,[A-Za-z0-9+/=]+/i);
        return m ? m[0] : "";
      }
      function findFirstHttpImage(s) {
        const m = String(s || "").match(/https?:\/\/[^\s]+\.(jpg|jpeg|png|gif|webp)(\?[^\s]+)?/i);
        return m ? m[0] : "";
      }

      function appendBubble(role, content, meta) {
        if (!msgs) return;

        const raw = String(content ?? "");
        let displayText = raw;

        // âœ… UX FIX: If message contains a huge base64 image, don't dump it as text
        const dataImg = findFirstDataImage(raw);
        const httpImg = dataImg ? "" : findFirstHttpImage(raw);
        const imgUrl = dataImg || httpImg;

        if (dataImg) {
          displayText = raw.replace(dataImg, "[Image attached]");
        }

        const div = document.createElement("div");
        div.className = "bubble " + (role === "user" ? "me" : "ai");
        div.textContent = displayText;

        if (meta && (meta.fileName || meta.fileUrl)) {
          const m = document.createElement("div");
          m.className = "metaLine";
          m.textContent = meta.fileUrl
            ? ("Attachment: " + (meta.fileName || "file") + " â€” " + meta.fileUrl)
            : ("Attachment: " + (meta.fileName || "file"));
          div.appendChild(m);
        }

        if (imgUrl) {
          const img = document.createElement("img");
          img.src = imgUrl;
          img.alt = "Image";
          img.loading = "lazy";
          div.appendChild(img);
        }

        msgs.appendChild(div);
        msgs.scrollTop = msgs.scrollHeight;
      }

      function renderChat() {
        if (!msgs) return;
        msgs.innerHTML = "";
        if (!chatHistory.length) {
          appendBubble("assistant", "ğŸ‘‹ áƒ’áƒáƒ›áƒáƒ áƒ¯áƒáƒ‘áƒ! áƒ’áƒáƒáƒ¥áƒ¢áƒ˜áƒ£áƒ áƒ” backend connection áƒ“áƒ áƒ“áƒáƒ˜áƒ¬áƒ§áƒ” áƒ©áƒáƒ¢áƒ˜.");
          return;
        }
        for (const m of chatHistory) appendBubble(m.role, m.content, m.meta);
        msgs.scrollTop = msgs.scrollHeight;
      }

      function addMessage(role, content, meta) {
        const item = { role, content: String(content ?? ""), meta: meta || null };
        chatHistory.push(item);
        if (chatHistory.length > CHAT_HISTORY_LIMIT) chatHistory = chatHistory.slice(-CHAT_HISTORY_LIMIT);
        persistChat();
        appendBubble(role, item.content, item.meta);
      }

      function buildChatContext() {
        const maxItems = CHAT_CONTEXT_TURNS * 2;
        return chatHistory
          .slice(-maxItems)
          .map(m => ({ role: m.role, content: String(m.content || "").trim() }))
          .filter(m => m.content);
      }

      function showTyping() {
        if (!msgs) return;
        hideTyping();
        const typing = document.createElement("div");
        typing.className = "typing";
        typing.id = "typing";
        typing.innerHTML = '<span>Avatar G</span><span class="dots"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>';
        msgs.appendChild(typing);
        msgs.scrollTop = msgs.scrollHeight;
      }
      function hideTyping() {
        const typing = document.getElementById("typing");
        if (typing && typing.parentNode) typing.parentNode.removeChild(typing);
      }

      function setAttachment(fileObj) {
        attached = fileObj;
        if (!attachTray || !attachName || !attachSub) return;
        if (!attached) { attachTray.classList.remove("show"); return; }
        attachTray.classList.add("show");
        attachName.textContent = attached.name || "file";
        attachSub.textContent = (attached.isImage ? "Image ready" : "File ready") + " â€¢ " + humanSize(attached.size || 0);
      }
      function clearAttachment() { setAttachment(null); }

      async function fileToDataUrl(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = () => reject(new Error("File read failed"));
          reader.readAsDataURL(file);
        });
      }

      function bindFilePick() {
        if (!btnAttach || !fileInput) return;

        addClickAndKey(btnAttach, () => fileInput.click());

        fileInput.addEventListener("change", async () => {
          const f = fileInput.files && fileInput.files[0];
          if (!f) return;

          if (f.size > MAX_FILE_BYTES) {
            alert("File too large. Max 5MB.");
            fileInput.value = "";
            return;
          }

          const isImage = /^image\//i.test(f.type);
          try {
            const dataUrl = await fileToDataUrl(f);
            setAttachment({
              name: f.name,
              type: f.type || "application/octet-stream",
              size: f.size,
              dataUrl: String(dataUrl || ""),
              isImage
            });
            log(syslog, "ğŸ“ Attached: " + f.name + " (" + humanSize(f.size) + ")");
          } catch (e) {
            alert("Failed to read file");
          } finally {
            fileInput.value = "";
          }
        });
      }

      bindFilePick();
      addClickAndKey(btnAttachRemove, clearAttachment);

      // ===================== COMPOSE FLOW =====================
      function cleanupAudioUrl() {
        try { if (audioUrl) URL.revokeObjectURL(audioUrl); } catch { }
        audioUrl = "";
        lastAudioBlob = null;
        lastAudioExt = "mp3";
        if (audioPlayer) audioPlayer.removeAttribute("src");
        if (audioCard) audioCard.classList.remove("show");
        if (audioMeta) audioMeta.textContent = "";
      }

      function guessExtFromMime(mime) {
        const m = String(mime || "").toLowerCase();
        if (m.includes("audio/wav")) return "wav";
        if (m.includes("audio/mpeg") || m.includes("audio/mp3")) return "mp3";
        if (m.includes("audio/ogg")) return "ogg";
        if (m.includes("audio/webm")) return "webm";
        if (m.includes("audio/aac")) return "aac";
        return "mp3";
      }

      function showAudio(blob, metaText) {
        cleanupAudioUrl();
        lastAudioBlob = blob;
        lastAudioExt = guessExtFromMime(blob?.type);
        audioUrl = URL.createObjectURL(blob);
        if (audioPlayer) {
          audioPlayer.src = audioUrl;
          audioPlayer.load();
          audioPlayer.play().catch(() => { });
        }
        if (audioMeta) audioMeta.textContent = metaText || "";
        if (audioCard) audioCard.classList.add("show");
      }

      function getLastAssistantText() {
        for (let i = chatHistory.length - 1; i >= 0; i--) {
          const m = chatHistory[i];
          if (m && m.role === "assistant" && typeof m.content === "string") {
            const t = m.content.trim();
            if (t) return t;
          }
        }
        return "";
      }

      async function composeToAudio(text) {
        const lyrics = safeText(text);
        if (!lyrics) { alert("No lyrics/text found to compose."); return; }

        setStatus("Status: composing audio...", "sending");
        log(syslog, "ğŸµ Compose started...");
        cleanupAudioUrl();

        try {
          const { ctrl, done } = withTimeout(TIMEOUT_COMPOSE_MS);

          const cfg = getCfg();
          const base = normalizeUrl(cfg.apiBase || "");
          if (!base || !isValidApiBase(base)) {
            done();
            setStatus("Status: error", "error");
            alert("API_BASE not set. Open Settings and set backend domain.");
            openCfg();
            return;
          }

          const res = await fetch(base + "/api/music/compose", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ text: lyrics }),
            signal: ctrl.signal
          });

          done();

          if (!res.ok) {
            const txt = await res.text().catch(() => "");
            const hint = explainFetchFailure(null, res.status);
            log(syslog, "âŒ Compose failed: HTTP " + res.status + " " + txt.slice(0, 200));
            setStatus("Status: error", "error");
            alert("Compose failed (HTTP " + res.status + ")\n\n" + hint + "\n\n" + txt.slice(0, 600));
            return;
          }

          const blob = await res.blob();
          const metaText = "OK â€¢ " + humanSize(blob.size) + " â€¢ " + (blob.type ? blob.type : "audio") + " â€¢ " + new Date().toLocaleTimeString();
          showAudio(blob, metaText);

          addMessage("assistant", "ğŸ§ Audio ready âœ…\n(Compose complete â€” Audio Player áƒœáƒáƒ®áƒ” áƒ¥áƒ•áƒ”áƒ›áƒáƒ—)");
          setStatus("Status: success âœ“", "success");
          log(syslog, "âœ… Compose success: " + humanSize(blob.size));
        } catch (e) {
          const hint = explainFetchFailure(e);
          log(syslog, "âŒ Compose error: " + hint);
          setStatus("Status: error", "error");
          alert("Compose error\n\n" + hint + "\n\n" + String(e?.message || e));
        }
      }

      if (btnCompose) addClickAndKey(btnCompose, async () => {
        const text = (prompt && prompt.value ? prompt.value.trim() : "");
        if (!text) await composeToAudio(getLastAssistantText());
        else await composeToAudio(text);
      });

      if (btnComposeFromLast) btnComposeFromLast.addEventListener("click", async () => {
        await composeToAudio(getLastAssistantText());
      });

      if (btnDownloadAudio) {
        btnDownloadAudio.addEventListener("click", () => {
          if (!lastAudioBlob) return alert("No audio yet.");
          const url = URL.createObjectURL(lastAudioBlob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "avatarg-compose." + (lastAudioExt || "mp3");
          document.body.appendChild(a);
          a.click();
          a.remove();
          setTimeout(() => { try { URL.revokeObjectURL(url); } catch { } }, 2000);
        });
      }

      // ===================== CHAT SEND =====================
      async function sendChat() {
        if (isSending || !prompt || !btnSend) return;

        const cfg = getCfg();
        const text = (prompt.value || "").trim();
        if (!text && !attached) return;

        const base = normalizeUrl(cfg.apiBase || "");
        if (!base || !isValidApiBase(base)) {
          addMessage("assistant", "âŒ API_BASE áƒáƒ  áƒáƒ áƒ˜áƒ¡ áƒ¡áƒ¬áƒáƒ áƒáƒ“ áƒ“áƒáƒ§áƒ”áƒœáƒ”áƒ‘áƒ£áƒšáƒ˜.\n\náƒ’áƒáƒ®áƒ¡áƒ”áƒœáƒ˜ Settings áƒ“áƒ áƒ©áƒáƒ¡áƒ•áƒ˜ backend domain (https://...).");
          openCfg();
          return;
        }

        isSending = true;
        btnSend.style.opacity = ".7";
        btnSend.style.pointerEvents = "none";

        let userText = text;
        let meta = null;

        if (attached) {
          meta = { fileName: attached.name, fileType: attached.type, fileSize: attached.size };
          if (attached.isImage) {
            // Send image as dataURL (backend should handle)
            userText = (userText ? userText + "\n\n" : "") + attached.dataUrl;
          } else {
            userText = (userText ? userText + "\n\n" : "") + `[Attachment: ${attached.name} (${humanSize(attached.size)})]`;
          }
        }

        addMessage("user", userText || "(empty)", meta);
        prompt.value = "";
        clearAttachment();

        setStatus("Status: sending...", "sending");
        showTyping();

        const url = base + "/api/ai";
        const context = buildChatContext();

        const payload = {
          message: userText || "",
          messages: context.length ? context : undefined,
          client: "AvatarG-Workspace-Pro",
          user: currentUser?.email || null,
          timestamp: new Date().toISOString()
        };

        const { ctrl, done } = withTimeout(TIMEOUT_AI_MS);

        try {
          const res = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
            signal: ctrl.signal
          });
          done();

          hideTyping();

          const contentType = (res.headers.get("content-type") || "").toLowerCase();
          let out = "";

          if (contentType.includes("application/json")) {
            const data = await res.json().catch(() => null);

            if (!res.ok) {
              const errMsg = data?.error || data?.message || ("HTTP " + res.status);
              const hint = data?.hint ? ("\n\nHint: " + String(data.hint)) : "";
              out = "âŒ Backend Error:\n" + safeText(errMsg) + safeText(hint);
              setStatus("Status: error", "error");
            } else {
              out = extractResponse(data);
              setStatus("Status: success âœ“", "success");
            }
          } else {
            const txt = await res.text().catch(() => "");
            if (!res.ok) {
              out = "âŒ Backend Error (HTTP " + res.status + "):\n" + safeText(txt.substring(0, 900));
              setStatus("Status: error", "error");
            } else {
              out = txt || "(empty response)";
              setStatus("Status: success âœ“", "success");
            }
          }

          addMessage("assistant", out);
        } catch (e) {
          done();
          hideTyping();

          const hint = explainFetchFailure(e);
          const rawMsg = safeText(e?.message || e);

          addMessage(
            "assistant",
            "âŒ " + hint +
            (rawMsg ? ("\n\nDetails: " + rawMsg) : "") +
            "\n\náƒ¨áƒ”áƒ¡áƒáƒ«áƒšáƒ áƒ›áƒ˜áƒ–áƒ”áƒ–áƒ”áƒ‘áƒ˜:\nâ€¢ Backend offline-áƒ˜áƒ\nâ€¢ CORS áƒáƒ  áƒáƒ áƒ˜áƒ¡ configured\nâ€¢ Route áƒáƒ  áƒáƒ áƒ¡áƒ”áƒ‘áƒáƒ‘áƒ¡ (/api/ai)\nâ€¢ Timeout"
          );

          setStatus("Status: failed", "error");
        } finally {
          isSending = false;
          btnSend.style.opacity = "1";
          btnSend.style.pointerEvents = "auto";
        }
      }

      if (prompt) {
        prompt.addEventListener("keydown", (e) => {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            sendChat();
          }
        });
      }
      if (btnSend) addClickAndKey(btnSend, sendChat);

      if (btnClear) {
        btnClear.addEventListener("click", () => {
          if (!confirm("Clear all chat history? This cannot be undone.")) return;
          chatHistory = [];
          localStorage.removeItem(KEY.CHAT);
          renderChat();
          log(syslog, "Chat cleared.");
          setStatus("Status: idle", "idle");
          cleanupAudioUrl();
        });
      }

      // ===================== INIT =====================
      (async function init() {
        setLog(syslog, "[boot] Avatar G Workspace loaded");
        setStatus("Status: idle", "idle");

        loadChat();
        renderChat();
        updateChips();

        const cfg = getCfg();

        if (cfg.supabaseUrl && cfg.supabaseAnon) {
          ensureSupabase();
          await readUser();

          if (supabaseClient?.auth?.onAuthStateChange) {
            supabaseClient.auth.onAuthStateChange((event, session) => {
              currentUser = session?.user || null;
              updateChips();
              if (event === "SIGNED_IN" && currentUser?.email) log(syslog, "âœ… Auth: Signed in as " + safeText(currentUser.email));
              if (event === "SIGNED_OUT") log(syslog, "âœ… Auth: Signed out");
            });
          }
        } else {
          if (!localStorage.getItem(KEY.SEEN_CFG_HINT)) {
            log(syslog, "âš ï¸ Supabase not configured. Open Settings to connect.");
            localStorage.setItem(KEY.SEEN_CFG_HINT, "1");
          }
        }

        if (cfg.apiBase && isValidApiBase(cfg.apiBase)) log(syslog, "âœ… API_BASE loaded: " + safeText(cfg.apiBase));
        else log(syslog, "âš ï¸ API_BASE not set or invalid. Open Settings.");

        log(syslog, "âœ… Ready. Test backend or start chatting!");
      })();
    })();
  </script>
</body>
</html>
```î¨0î¨‚
