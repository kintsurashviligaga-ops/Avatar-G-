<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Avatar G Workspace</title>

  <!-- ‚úÖ React (CDN) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- ‚úÖ Babel (so we can write JSX in one file) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- ‚úÖ Supabase JS v2 (CDN) -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#070A0F;
      --panel: rgba(255,255,255,0.06);
      --panel2: rgba(255,255,255,0.04);
      --line: rgba(255,255,255,0.10);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.62);
      --accent:#22d3ee;
      --accent2:#3b82f6;
      --danger:#ff6b6b;
      --ok:#2cffb2;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: radial-gradient(1000px 600px at 30% 20%, rgba(34,211,238,0.12), transparent 60%),
                  radial-gradient(900px 600px at 80% 70%, rgba(59,130,246,0.10), transparent 60%),
                  var(--bg);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    a{color:inherit;text-decoration:none}
    button,input,textarea{font-family:inherit}
    .wrap{min-height:100vh;display:grid;place-items:center;padding:18px}
    .container{width:min(1280px,100%)}

    .grid{display:grid;grid-template-columns:320px 1fr;gap:16px}
    .card{
      border:1px solid var(--line);
      background:rgba(255,255,255,0.05);
      border-radius:18px;
    }
    .pad{padding:16px}
    .muted{color:var(--muted)}
    .hr{height:1px;background:var(--line);margin:12px 0}
    .btn{
      border:1px solid var(--line);
      background:rgba(255,255,255,0.06);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:900;
    }
    .btn:hover{filter:brightness(1.06)}
    .btnPrimary{
      border:none;
      background:linear-gradient(135deg, rgba(34,211,238,0.55), rgba(59,130,246,0.30));
      color:#fff;
      box-shadow:0 8px 30px rgba(34,211,238,0.12);
    }
    .btnCyan{
      border:1px solid rgba(34,211,238,0.35);
      background:rgba(34,211,238,0.10);
      color:var(--accent);
    }
    .btnDanger{
      border:1px solid rgba(255,107,107,0.25);
      background:rgba(255,107,107,0.12);
      color:var(--danger);
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(0,0,0,0.25);
      font-size:12px;
      font-weight:900;
      color:var(--muted);
    }
    .projectItem{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,0.05);
      cursor:pointer;
    }
    .projectItem.active{
      border:1.5px solid var(--accent);
      background:linear-gradient(135deg, rgba(34,211,238,0.14), rgba(59,130,246,0.10));
    }
    .badge{
      font-size:11px;
      font-weight:900;
      padding:6px 8px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,0.18);
      color:var(--muted);
    }

    /* Chat */
    .chat{
      overflow:hidden;
      display:grid;
      grid-template-rows:auto 1fr auto;
      min-height:84vh;
      position:relative;
    }
    .chatHeader{
      padding:16px;
      border-bottom:1px solid var(--line);
      background:linear-gradient(135deg, rgba(34,211,238,0.14), rgba(59,130,246,0.10));
    }
    .chatBody{padding:16px;overflow:auto}
    .bubbleWrap{display:flex}
    .bubble{
      max-width:78%;
      padding:14px;
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(255,255,255,0.06);
      white-space:pre-wrap;
      line-height:1.6;
      font-size:14px;
      box-shadow:0 4px 16px rgba(0,0,0,0.08);
    }
    .bubble.user{
      border:1.5px solid rgba(34,211,238,0.30);
      background:linear-gradient(135deg, rgba(34,211,238,0.14), rgba(59,130,246,0.10));
      box-shadow:0 4px 16px rgba(34,211,238,0.10);
    }
    .composer{
      padding:14px;
      border-top:1px solid var(--line);
      background:rgba(255,255,255,0.03);
    }
    textarea{
      width:100%;
      resize:none;
      border-radius:14px;
      border:1.5px solid var(--line);
      background:rgba(0,0,0,0.25);
      color:var(--text);
      padding:12px;
      outline:none;
      font-size:14px;
      line-height:1.5;
    }

    /* Modal */
    .modalBackdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,0.65);
      backdrop-filter: blur(6px);
      display:grid; place-items:center;
      z-index:9999;
      padding:18px;
    }
    .modal{
      width:min(520px,100%);
      border:1px solid var(--line);
      background:rgba(255,255,255,0.05);
      border-radius:22px;
      padding:18px;
    }
    .input{
      width:100%;
      border-radius:14px;
      border:1.5px solid var(--line);
      background:rgba(0,0,0,0.25);
      color:var(--text);
      padding:12px;
      outline:none;
    }
    .warn{
      border:1px solid rgba(255,200,0,0.25);
      background:rgba(255,200,0,0.10);
      color:#ffd36e;
      padding:10px 12px;
      border-radius:14px;
      font-weight:900;
      font-size:12px;
      line-height:1.4;
    }

    /* Attachments */
    .attRow{
      border:1px solid var(--line);
      background:rgba(0,0,0,0.20);
      border-radius:14px;
      padding:10px 12px;
      display:flex;
      gap:10px;
      align-items:center;
      margin-bottom:8px;
    }
    .thumb{
      width:48px;height:48px;border-radius:10px;
      border:1px solid var(--line);
      object-fit:cover;
    }
    .thumbBox{
      width:48px;height:48px;border-radius:10px;
      border:1px solid var(--line);
      background:rgba(255,255,255,0.06);
      display:grid;place-items:center;
      font-weight:950;
    }
    .attName{font-weight:950;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .attMeta{font-size:11px;color:var(--muted)}
  </style>
</head>

<body>
  <div id="root"></div>

  <script type="text/babel">
    /************************************************************
     ‚úÖ CONFIG ‚Äî EDIT ONLY THIS SECTION
     ************************************************************/
    const CONFIG = {
      // ‚úÖ Your Supabase project
      SUPABASE_URL: "https://YOUR_PROJECT.supabase.co",
      SUPABASE_ANON_KEY: "YOUR_ANON_KEY",

      // ‚úÖ Your API base (your backend domain)
      // Example: "https://api.avatarg.ge" or "https://xxxx.ngrok-free.app"
      API_BASE: "https://YOUR_API_DOMAIN.com",

      // Optional: App name
      APP_NAME: "Avatar G Workspace",
    };

    /************************************************************
     Helper utils
     ************************************************************/
    const { useEffect, useMemo, useRef, useState } = React;

    function bytesToGB(n){
      const gb = n / (1024*1024*1024);
      return gb.toFixed(2);
    }

    function safeJson(x){ try{return JSON.parse(x);}catch{return null;} }

    function ensureConfig(){
      const okSupabase = CONFIG.SUPABASE_URL && CONFIG.SUPABASE_ANON_KEY &&
        !CONFIG.SUPABASE_URL.includes("YOUR_PROJECT") && !CONFIG.SUPABASE_ANON_KEY.includes("YOUR_ANON_KEY");
      const okApi = CONFIG.API_BASE && !CONFIG.API_BASE.includes("YOUR_API_DOMAIN");
      return { okSupabase, okApi };
    }

    /************************************************************
     API client (adds Authorization: Bearer <supabase access token>)
     ************************************************************/
    async function apiFetch({ path, method="GET", token, body, isForm=false }) {
      const url = CONFIG.API_BASE.replace(/\/$/,"") + path;
      const headers = {};
      if (token) headers["Authorization"] = "Bearer " + token;
      if (!isForm) headers["Content-Type"] = "application/json";

      const res = await fetch(url, {
        method,
        headers,
        body: isForm ? body : (body ? JSON.stringify(body) : undefined),
      });

      const text = await res.text();
      const json = safeJson(text);
      if (!res.ok) {
        const msg = json?.error || text || "Request failed";
        throw new Error(msg);
      }
      return json ?? {};
    }

    /************************************************************
     Auth Modal (Magic Link + OAuth placeholders)
     ************************************************************/
    function AuthModal({ supabase, onClose, onAuthed }) {
      const [email, setEmail] = useState("");
      const [busy, setBusy] = useState(false);
      const [msg, setMsg] = useState(null);

      async function magicLink(){
        setBusy(true); setMsg(null);
        try{
          const redirectTo = window.location.href.split("#")[0];
          const { error } = await supabase.auth.signInWithOtp({
            email,
            options: { emailRedirectTo: redirectTo }
          });
          if (error) throw error;
          setMsg("‚úÖ Magic link sent. Check your email.");
        }catch(e){
          setMsg("‚ùå " + (e?.message || "Auth failed"));
        }finally{
          setBusy(false);
        }
      }

      async function oauth(provider){
        setBusy(true); setMsg(null);
        try{
          const redirectTo = window.location.href.split("#")[0];
          const { error } = await supabase.auth.signInWithOAuth({
            provider,
            options: { redirectTo }
          });
          if (error) throw error;
        }catch(e){
          setMsg("‚ùå " + (e?.message || "OAuth failed"));
          setBusy(false);
        }
      }

      return (
        <div className="modalBackdrop">
          <div className="modal">
            <div style={{display:"grid", gap:10}}>
              <div style={{fontSize:22, fontWeight:950}}>{CONFIG.APP_NAME}</div>
              <div className="muted" style={{lineHeight:1.5}}>
                Sign in to your workspace. Your API must validate Supabase JWT and enforce RLS on server.
              </div>

              <div className="hr"></div>

              <div style={{fontSize:12, fontWeight:900, textTransform:"uppercase"}} className="muted">Magic Link</div>
              <input className="input" placeholder="you@company.com" value={email} onChange={e=>setEmail(e.target.value)} />
              <button className="btn btnPrimary" disabled={busy || !email.includes("@")} onClick={magicLink}>
                {busy ? "‚è≥" : "Send Magic Link ‚Üí"}
              </button>

              <div className="hr"></div>

              <div style={{fontSize:12, fontWeight:900, textTransform:"uppercase"}} className="muted">OAuth</div>
              <div style={{display:"flex", gap:10, flexWrap:"wrap"}}>
                <button className="btn" disabled={busy} onClick={()=>oauth("google")}>Continue with Google</button>
                <button className="btn" disabled={busy} onClick={()=>oauth("github")}>Continue with GitHub</button>
              </div>

              {msg && <div style={{fontSize:13, fontWeight:900, color: msg.startsWith("‚úÖ") ? "var(--accent)" : "var(--danger)"}}>{msg}</div>}

              <div style={{display:"flex", justifyContent:"space-between", gap:10, marginTop:6}}>
                <button className="btn" onClick={onClose}>Close</button>
                <button className="btn btnCyan" onClick={onAuthed}>I already signed in</button>
              </div>
            </div>
          </div>
        </div>
      );
    }

    /************************************************************
     Main App
     ************************************************************/
    function App(){
      const cfg = ensureConfig();

      const supabase = useMemo(()=>{
        if(!cfg.okSupabase) return null;
        return window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
      }, [cfg.okSupabase]);

      const [session, setSession] = useState(null);
      const [token, setToken] = useState("");
      const [showAuth, setShowAuth] = useState(false);

      // Workspace state
      const [projects, setProjects] = useState([]);
      const [activeProjectId, setActiveProjectId] = useState("");
      const [mode, setMode] = useState("general");
      const [usage, setUsage] = useState(null);
      const [attachments, setAttachments] = useState([]);
      const [uploading, setUploading] = useState([]);
      const [messages, setMessages] = useState([
        { role:"assistant", content:
          "Welcome to **Avatar G Workspace**.\n\n‚úÖ GPT-style unified window\n‚úÖ Projects + Files\n‚úÖ Usage limits + Billing\n\nUpload files and tell me what you want."
        }
      ]);
      const [input, setInput] = useState("");
      const [streaming, setStreaming] = useState(false);
      const bottomRef = useRef(null);

      function scrollBottom(){
        requestAnimationFrame(()=> bottomRef.current?.scrollIntoView({behavior:"smooth"}));
      }

      // Session init
      useEffect(()=>{
        if(!supabase) return;
        supabase.auth.getSession().then(({data})=>{
          setSession(data.session || null);
          setToken(data.session?.access_token || "");
        });
        const { data: sub } = supabase.auth.onAuthStateChange((_event, sess)=>{
          setSession(sess || null);
          setToken(sess?.access_token || "");
        });
        return ()=> sub?.subscription?.unsubscribe?.();
      }, [supabase]);

      // If config missing
      const configWarning = (!cfg.okSupabase || !cfg.okApi);

      // API calls
      async function loadProjects(){
        if(!token) return;
        const j = await apiFetch({ path:"/projects/list", token });
        const list = j.projects || [];
        setProjects(list);

        // ensure active
        if(!activeProjectId){
          if(list[0]) setActiveProjectId(list[0].id);
        } else {
          if(!list.some(p=>p.id===activeProjectId) && list[0]) setActiveProjectId(list[0].id);
        }
      }

      async function loadUsage(){
        if(!token) return;
        // Your API should return:
        // { plan, projectsUsed, projectsLimit, storageBytesUsed, storageBytesLimit, filesCount }
        const j = await apiFetch({ path:"/usage", token });
        setUsage(j.usage || j);
      }

      useEffect(()=>{
        if(!token || configWarning) return;
        loadProjects().catch(()=>{});
        loadUsage().catch(()=>{});
      }, [token]);

      async function createProject(){
        const name = prompt("Project name?");
        if(!name || !name.trim()) return;
        await apiFetch({ path:"/projects/create", method:"POST", token, body:{ name:name.trim() } });
        await loadProjects();
        await loadUsage();
      }

      async function deleteProject(id){
        if(!confirm("Delete project?")) return;
        await apiFetch({ path:"/projects/delete", method:"POST", token, body:{ projectId:id } });
        // remove attachments UI for that project
        setAttachments(prev=> prev.filter(a=>a.projectId!==id));
        await loadProjects();
        await loadUsage();
      }

      async function uploadFile(file){
        if(!activeProjectId) return alert("No active project");
        const uploadId = crypto.randomUUID();
        setUploading(prev=> [...prev, { id:uploadId, name:file.name, progress:0 }]);

        try{
          const fd = new FormData();
          fd.append("file", file);
          fd.append("projectId", activeProjectId);

          // If your API returns { meta: { key, projectId, name, type, size, timestamp } }
          // we use it directly.
          const json = await apiFetch({ path:"/upload", method:"POST", token, body:fd, isForm:true });
          const meta = json.meta || json;

          // client thumbnail only
          let previewUrl = null;
          if(file.type.startsWith("image/")){
            previewUrl = URL.createObjectURL(file);
          }

          setAttachments(prev=> [...prev, { ...meta, previewUrl } ]);
          setMessages(prev=> [...prev, { role:"assistant", content:`‚úÖ Uploaded: **${meta.name}**` } ]);
          scrollBottom();
          await loadUsage();
        }catch(e){
          alert(e?.message || "Upload failed");
        }finally{
          setUploading(prev=> prev.filter(u=>u.id!==uploadId));
        }
      }

      async function viewAttachment(att){
        // expects POST /r2/sign { key } => { url }
        const j = await apiFetch({ path:"/r2/sign", method:"POST", token, body:{ key:att.key } });
        window.open(j.url, "_blank");
      }

      async function deleteAttachment(att){
        if(!confirm("Delete file?")) return;
        await apiFetch({ path:"/r2/delete", method:"POST", token, body:{ key:att.key } });
        if(att.previewUrl) URL.revokeObjectURL(att.previewUrl);
        setAttachments(prev=> prev.filter(x=>x.key!==att.key));
        await loadUsage();
      }

      const visibleAttachments = useMemo(()=> attachments.filter(a=>a.projectId===activeProjectId), [attachments, activeProjectId]);

      async function startCheckout(plan){
        // expects POST /billing/checkout { plan } => { url }
        const j = await apiFetch({ path:"/billing/checkout", method:"POST", token, body:{ plan } });
        window.location.href = j.url;
      }

      async function openPortal(){
        // expects POST /billing/portal => { url }
        const j = await apiFetch({ path:"/billing/portal", method:"POST", token });
        window.location.href = j.url;
      }

      async function logout(){
        if(!supabase) return;
        await supabase.auth.signOut();
        setSession(null);
        setToken("");
      }

      // Chat streaming via SSE
      async function send(){
        const text = input.trim();
        if(!text || streaming) return;
        if(!activeProjectId) return alert("No active project");

        const next = [...messages, { role:"user", content:text }];
        setMessages(next);
        setInput("");
        setStreaming(true);
        scrollBottom();

        // placeholder assistant bubble
        setMessages(prev=> [...prev, { role:"assistant", content:"" } ]);

        try{
          const url = CONFIG.API_BASE.replace(/\/$/,"") + "/chat";
          const res = await fetch(url, {
            method:"POST",
            headers:{
              "Content-Type":"application/json",
              "Authorization":"Bearer " + token
            },
            body: JSON.stringify({
              mode,
              projectId: activeProjectId,
              messages: next,
              attachments: visibleAttachments
            })
          });

          if(!res.ok || !res.body){
            const t = await res.text();
            throw new Error(t || "Chat failed");
          }

          const reader = res.body.getReader();
          const decoder = new TextDecoder();
          let buffer = "";

          while(true){
            const { done, value } = await reader.read();
            if(done) break;

            buffer += decoder.decode(value, { stream:true });
            const parts = buffer.split("\n\n");
            buffer = parts.pop() || "";

            for(const part of parts){
              const line = part.trim();
              if(!line.startsWith("data:")) continue;
              const jsonStr = line.slice(5).trim();
              if(!jsonStr) continue;

              const evt = safeJson(jsonStr);
              if(!evt) continue;

              if(evt.type === "delta"){
                const delta = evt.delta || "";
                setMessages(prev=>{
                  const copy = [...prev];
                  const last = copy[copy.length-1];
                  if(last?.role === "assistant") last.content += delta;
                  return copy;
                });
                scrollBottom();
              }
              if(evt.type === "error"){
                throw new Error(evt.message || "Stream error");
              }
            }
          }
        }catch(e){
          setMessages(prev=>{
            const copy = [...prev];
            const last = copy[copy.length-1];
            const msg = "‚ùå " + (e?.message || "Unknown error");
            if(last?.role === "assistant" && !last.content) last.content = msg;
            else copy.push({ role:"assistant", content: msg });
            return copy;
          });
        }finally{
          setStreaming(false);
          scrollBottom();
        }
      }

      const modeOptions = [
        ["general","üí¨ Chat"],
        ["avatar","üßë‚Äçüé≠ Avatar"],
        ["voice","üé§ Voice"],
        ["music","üéµ Music"],
        ["video","üé¨ Video"],
        ["photo","üì∏ Photo"],
        ["marketing","üìà Marketing"],
      ];

      const usageText = useMemo(()=>{
        if(!usage) return "";
        const pLimit = Number.isFinite(usage.projectsLimit) ? usage.projectsLimit : "‚àû";
        const sLimit = Number.isFinite(usage.storageBytesLimit) ? bytesToGB(usage.storageBytesLimit) + "GB" : "‚àû";
        const sUsed = bytesToGB(usage.storageBytesUsed) + "GB";
        return `Plan: ${usage.plan} ‚Ä¢ Projects: ${usage.projectsUsed}/${pLimit} ‚Ä¢ Storage: ${sUsed}/${sLimit} ‚Ä¢ Files: ${usage.filesCount}`;
      }, [usage]);

      // UI
      return (
        <div className="wrap">
          <div className="container">

            {configWarning && (
              <div className="warn" style={{marginBottom:12}}>
                ‚ö†Ô∏è CONFIG is not set.<br/>
                Edit CONFIG at top of this file:<br/>
                - SUPABASE_URL + SUPABASE_ANON_KEY<br/>
                - API_BASE (your backend domain)<br/>
                Then refresh.
              </div>
            )}

            {(!session) && cfg.okSupabase && (
              <div className="warn" style={{marginBottom:12}}>
                üîê Not signed in. Click ‚ÄúSign in‚Äù to access workspace.
              </div>
            )}

            {showAuth && supabase && (
              <AuthModal
                supabase={supabase}
                onClose={()=>setShowAuth(false)}
                onAuthed={()=>{
                  setShowAuth(false);
                  // session auto updates by supabase listener
                }}
              />
            )}

            <div className="grid">

              {/* LEFT */}
              <aside className="card pad">
                <div style={{display:"grid", gap:12}}>
                  <div style={{display:"flex", justifyContent:"space-between", alignItems:"center", gap:12}}>
                    <div>
                      <div style={{fontWeight:950, fontSize:18}}>{CONFIG.APP_NAME}</div>
                      <div className="muted" style={{fontSize:12}}>
                        {session?.user?.email ? session.user.email : "Guest"}
                      </div>
                    </div>

                    <div style={{display:"flex", gap:8}}>
                      {!session ? (
                        <button className="btn btnPrimary" onClick={()=>setShowAuth(true)} disabled={!cfg.okSupabase}>
                          Sign in
                        </button>
                      ) : (
                        <button className="btn" onClick={logout}>Logout</button>
                      )}
                    </div>
                  </div>

                  <div className="hr"></div>

                  {/* Usage */}
                  <div style={{display:"grid", gap:8}}>
                    <div className="muted" style={{fontSize:12, fontWeight:900, textTransform:"uppercase"}}>Usage</div>
                    <div className="badge">{usage ? usageText : "‚Äî"}</div>
                  </div>

                  <div className="hr"></div>

                  {/* Projects */}
                  <div style={{display:"grid", gap:8}}>
                    <div style={{display:"flex", justifyContent:"space-between", alignItems:"center"}}>
                      <div className="muted" style={{fontSize:12, fontWeight:900, textTransform:"uppercase"}}>Projects</div>
                      <button className="btn btnCyan" onClick={createProject} disabled={!session || configWarning}>Ôºã</button>
                    </div>

                    <div style={{display:"grid", gap:6}}>
                      {projects.map(p=>{
                        const active = p.id === activeProjectId;
                        return (
                          <div key={p.id} className={"projectItem " + (active ? "active":"")}
                               onClick={()=>setActiveProjectId(p.id)}>
                            <div style={{fontSize:16}}>{active ? "üìÇ":"üìÅ"}</div>
                            <div style={{flex:1, minWidth:0}}>
                              <div style={{fontWeight:950, fontSize:13, whiteSpace:"nowrap", overflow:"hidden", textOverflow:"ellipsis"}}>{p.name}</div>
                              <div className="muted" style={{fontSize:11}}>
                                {new Date(p.created_at).toLocaleDateString("ka-GE")}
                              </div>
                            </div>
                            <button className="btn btnDanger"
                              style={{padding:"6px 8px", borderRadius:12}}
                              onClick={(e)=>{e.stopPropagation(); deleteProject(p.id);}}
                              disabled={!session || configWarning}
                              title="Delete project"
                            >üóëÔ∏è</button>
                          </div>
                        );
                      })}
                    </div>

                    <button className="btn" onClick={loadProjects} disabled={!session || configWarning}>
                      Refresh Projects
                    </button>
                  </div>

                  <div className="hr"></div>

                  {/* Billing */}
                  <div style={{display:"grid", gap:8}}>
                    <div className="muted" style={{fontSize:12, fontWeight:900, textTransform:"uppercase"}}>Billing</div>
                    <button className="btn btnPrimary" onClick={()=>startCheckout("pro")} disabled={!session || configWarning}>
                      Stripe Checkout: PRO ‚Üí
                    </button>
                    <button className="btn btnCyan" onClick={()=>startCheckout("studio")} disabled={!session || configWarning}>
                      Stripe Checkout: STUDIO ‚Üí
                    </button>
                    <button className="btn" onClick={openPortal} disabled={!session || configWarning}>
                      Customer Portal
                    </button>
                  </div>

                  <div className="hr"></div>

                  {/* Modes */}
                  <div style={{display:"grid", gap:8}}>
                    <div className="muted" style={{fontSize:12, fontWeight:900, textTransform:"uppercase"}}>Modes</div>
                    <div style={{display:"grid", gap:6}}>
                      {modeOptions.map(([id,label])=>{
                        const active = id === mode;
                        return (
                          <button key={id}
                            className="btn"
                            style={{
                              textAlign:"left",
                              border: active ? "1.5px solid var(--accent)" : "1px solid var(--line)",
                              background: active ? "linear-gradient(135deg, rgba(34,211,238,0.12), rgba(59,130,246,0.08))" : "rgba(255,255,255,0.05)"
                            }}
                            onClick={()=>setMode(id)}
                          >
                            {label}
                          </button>
                        );
                      })}
                    </div>
                  </div>

                </div>
              </aside>

              {/* RIGHT CHAT */}
              <section className="card chat">
                <div className="chatHeader">
                  <div style={{display:"flex", justifyContent:"space-between", alignItems:"center", gap:12}}>
                    <div>
                      <div style={{fontWeight:950, fontSize:16}}>Chat</div>
                      <div className="muted" style={{fontSize:12, fontWeight:700}}>
                        Project: <span style={{color:"var(--text)"}}>{activeProjectId ? "Selected" : "None"}</span>
                        {streaming ? <span style={{color:"var(--accent)"}}> ‚Ä¢ streaming‚Ä¶</span> : null}
                      </div>
                    </div>

                    <label className="btn" style={{cursor:(!session||configWarning)?"not-allowed":"pointer", opacity:(!session||configWarning)?0.6:1}}>
                      üìé Upload
                      <input type="file" style={{display:"none"}} disabled={!session || configWarning}
                        onChange={(e)=>{
                          const f = e.target.files?.[0];
                          if(f) uploadFile(f);
                          e.target.value = "";
                        }}
                      />
                    </label>
                  </div>
                </div>

                <div className="chatBody">
                  {uploading.length > 0 && (
                    <div style={{display:"grid", gap:8, marginBottom:12}}>
                      {uploading.map(u=>(
                        <div key={u.id} className="pill" style={{borderColor:"rgba(34,211,238,0.25)", color:"var(--accent)"}}>
                          ‚è≥ {u.name}
                        </div>
                      ))}
                    </div>
                  )}

                  {/* Attachments for active project */}
                  {activeProjectId && visibleAttachments.length > 0 && (
                    <div style={{marginBottom:12}}>
                      {visibleAttachments.map(att=>{
                        const isImg = (att.type||"").startsWith("image/");
                        const isPdf = att.type === "application/pdf";
                        return (
                          <div className="attRow" key={att.key}>
                            {isImg && att.previewUrl ? (
                              <img className="thumb" src={att.previewUrl} alt={att.name} />
                            ) : (
                              <div className="thumbBox">
                                {isPdf ? "PDF" : "FILE"}
                              </div>
                            )}

                            <div style={{flex:1, minWidth:0}}>
                              <div className="attName">{att.name}</div>
                              <div className="attMeta">{att.type} ‚Ä¢ {Math.round((att.size||0)/1024)} KB</div>
                            </div>

                            <div style={{display:"flex", gap:8}}>
                              {(isImg || isPdf) && (
                                <button className="btn btnCyan" style={{padding:"8px 10px"}} onClick={()=>viewAttachment(att)} disabled={!session || configWarning}>
                                  üëÅÔ∏è View
                                </button>
                              )}
                              <button className="btn btnDanger" style={{padding:"8px 10px"}} onClick={()=>deleteAttachment(att)} disabled={!session || configWarning}>
                                üóëÔ∏è
                              </button>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  )}

                  {/* Messages */}
                  <div style={{display:"grid", gap:12}}>
                    {messages.map((m,i)=>{
                      const isUser = m.role === "user";
                      return (
                        <div key={i} className="bubbleWrap" style={{justifyContent:isUser?"flex-end":"flex-start"}}>
                          <div className={"bubble " + (isUser ? "user":"")}>
                            {m.content}
                          </div>
                        </div>
                      );
                    })}
                    <div ref={bottomRef}></div>
                  </div>
                </div>

                <div className="composer">
                  <div style={{display:"grid", gridTemplateColumns:"1fr auto", gap:12}}>
                    <textarea
                      rows="2"
                      value={input}
                      placeholder={session ? "Write your request‚Ä¶ (Enter = send, Shift+Enter = new line)" : "Sign in to chat‚Ä¶"}
                      disabled={!session || configWarning}
                      onChange={e=>setInput(e.target.value)}
                      onKeyDown={(e)=>{
                        if(e.key==="Enter" && !e.shiftKey){
                          e.preventDefault();
                          send();
                        }
                      }}
                    />
                    <button className={"btn " + (streaming?"":"btnPrimary")}
                      disabled={!session || configWarning || streaming}
                      onClick={send}
                      style={{padding:"0 24px", opacity:(!session||configWarning)?0.6:1}}
                    >
                      {streaming ? "‚è≥" : "Send ‚Üí"}
                    </button>
                  </div>

                  <div className="muted" style={{fontSize:12, marginTop:8}}>
                    Tip: Attach files per project. Your backend must enforce RLS + quotas.
                  </div>
                </div>

              </section>
            </div>

          </div>
        </div>
      );
    }

    /************************************************************
     Mount
     ************************************************************/
    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App/>);
  </script>
</body>
</html>
