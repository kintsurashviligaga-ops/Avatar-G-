<!doctype html>
<html lang="ka">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Avatar G ‚Äî Workspace</title>
  <meta name="theme-color" content="#06121a" />
  <style>
    :root{
      --bg1:#06121a;
      --bg2:#0a2533;
      --card:rgba(0,0,0,.35);
      --card2:rgba(255,255,255,.06);
      --line:rgba(255,255,255,.10);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.68);
      --danger:#ff4d4d;
      --ok:#46e6a1;
      --cyan:#22d3ee;
      --blue:#3b82f6;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --radius: 18px;
      --radius2: 14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
      background:
        radial-gradient(1200px 800px at 20% 20%, rgba(34,211,238,.14), transparent 60%),
        radial-gradient(900px 700px at 70% 30%, rgba(59,130,246,.12), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      overflow-x:hidden;
    }
    .wrap{
      min-height:100vh;
      display:flex;
      align-items:flex-end;
      justify-content:center;
      padding: 18px 14px 24px;
    }
    .panel{
      width:min(980px, 100%);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      overflow:hidden;
      backdrop-filter: blur(10px);
      position:relative;
    }
    .top{
      display:flex;
      gap:14px;
      align-items:center;
      padding:18px 18px 10px;
    }
    .logo{
      width:44px;height:44px;border-radius:14px;
      background: radial-gradient(circle at 30% 30%, rgba(34,211,238,.9), rgba(59,130,246,.7));
      box-shadow: 0 12px 30px rgba(34,211,238,.12);
      border:1px solid rgba(255,255,255,.16);
      flex:0 0 auto;
    }
    .title{
      display:flex;flex-direction:column;line-height:1.1;
    }
    .title h1{
      font-size:18px;margin:0 0 4px;font-weight:760;letter-spacing:.2px;
    }
    .title p{
      margin:0;color:var(--muted);font-size:13px;
    }
    .chips{
      margin-left:auto;
      display:flex;flex-wrap:wrap;gap:8px;justify-content:flex-end;
    }
    .chip{
      font-size:12px;
      color:rgba(255,255,255,.82);
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      padding:7px 10px;border-radius:999px;
      white-space:nowrap;
    }
    .chip.ok{border-color:rgba(70,230,161,.25); background:rgba(70,230,161,.08)}
    .chip.bad{border-color:rgba(255,77,77,.25); background:rgba(255,77,77,.08)}
    .row{
      display:flex;
      gap:14px;
      padding: 10px 18px 18px;
      flex-wrap:wrap;
    }
    .btn{
      border:none;
      border-radius: 14px;
      padding: 12px 14px;
      font-weight:700;
      color:rgba(255,255,255,.92);
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      display:inline-flex;gap:10px;align-items:center;
    }
    .btn.primary{
      background: linear-gradient(90deg, rgba(34,211,238,.95), rgba(59,130,246,.85));
      border: 1px solid rgba(255,255,255,.18);
      color:#041018;
      box-shadow: 0 12px 30px rgba(34,211,238,.18);
    }
    .btn.danger{
      background: rgba(255,77,77,.10);
      border:1px solid rgba(255,77,77,.28);
    }
    .btn:active{transform:translateY(1px)}
    .grid{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:14px;
      padding: 0 18px 18px;
    }
    @media (max-width: 860px){
      .grid{grid-template-columns:1fr}
      .chips{display:none}
    }
    .card{
      background: rgba(0,0,0,.22);
      border:1px solid var(--line);
      border-radius: var(--radius2);
      padding:14px;
      min-height: 220px;
    }
    .card h2{
      margin:0 0 10px;
      font-size:14px;
      color:rgba(255,255,255,.90);
      letter-spacing:.2px;
    }
    .muted{color:var(--muted);font-size:13px}
    .klist{margin:10px 0 0; padding:0 0 0 18px; color:var(--muted); font-size:13px}
    .klist li{margin:6px 0}
    .log{
      margin-top:10px;
      background: rgba(0,0,0,.28);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 12px;
      padding:10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;
      color:rgba(255,255,255,.82);
      max-height: 160px;
      overflow:auto;
      white-space:pre-wrap;
    }

    /* Modal */
    .modalBack{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:9999;
    }
    .modal{
      width:min(720px, 100%);
      border-radius: 18px;
      background: linear-gradient(180deg, rgba(10,25,35,.98), rgba(6,18,26,.98));
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 22px 80px rgba(0,0,0,.6);
      overflow:hidden;
    }
    .modalHead{
      display:flex;
      align-items:center;
      gap:10px;
      padding:14px 14px 10px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .modalHead h3{
      margin:0;
      font-size:14px;
      font-weight:760;
    }
    .modalHead .x{
      margin-left:auto;
      width:40px;height:40px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      cursor:pointer;
      color:rgba(255,255,255,.88);
      font-size:18px;
    }
    .modalBody{padding:14px}
    .field{
      margin-bottom:12px;
    }
    .label{
      font-size:12px;
      color:rgba(255,255,255,.75);
      margin:0 0 6px;
    }
    input, textarea{
      width:100%;
      padding:12px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      color:rgba(255,255,255,.92);
      outline:none;
      font-size:14px;
    }
    input:focus, textarea:focus{
      border-color: rgba(34,211,238,.55);
      box-shadow: 0 0 0 3px rgba(34,211,238,.15);
    }
    .modalActions{
      display:flex; gap:10px; justify-content:flex-end;
      padding: 12px 14px 14px;
      border-top:1px solid rgba(255,255,255,.10);
      flex-wrap:wrap;
    }

    /* Chat */
    .chatBox{
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height: 360px;
    }
    .msgs{
      flex:1;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding: 12px;
      overflow:auto;
      max-height: 420px;
    }
    .bubble{
      max-width: 90%;
      padding:10px 12px;
      border-radius: 14px;
      margin: 8px 0;
      border:1px solid rgba(255,255,255,.10);
      line-height:1.35;
      font-size:14px;
      white-space:pre-wrap;
      word-break:break-word;
    }
    .me{
      margin-left:auto;
      background: rgba(34,211,238,.10);
      border-color: rgba(34,211,238,.22);
    }
    .ai{
      background: rgba(255,255,255,.06);
    }
    .composer{
      display:flex;
      gap:10px;
      align-items:flex-end;
    }
    .composer textarea{
      min-height: 48px;
      max-height: 140px;
      resize: vertical;
    }
    .small{
      font-size:12px;
      color:rgba(255,255,255,.70);
    }
    .hint{
      margin-top:8px;
      padding:10px;
      border-radius: 14px;
      border:1px dashed rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color:rgba(255,255,255,.74);
      font-size:12px;
    }
    .dangerText{color:rgba(255,120,120,.95)}
    .okText{color:rgba(120,255,190,.95)}
  </style>

  <!-- Supabase JS (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
  <div class="wrap">
    <div class="panel">
      <div class="top">
        <div class="logo" aria-hidden="true"></div>
        <div class="title">
          <h1>Avatar G Workspace</h1>
          <p>Mode B ‚Äî Workspace first, connect on demand</p>
        </div>
        <div class="chips" id="chips">
          <div class="chip" id="chipMode">Mode: Ready</div>
          <div class="chip" id="chipApi">API_BASE: not set</div>
          <div class="chip" id="chipSb">Supabase: not set</div>
          <div class="chip" id="chipUser">User: not signed in</div>
        </div>
      </div>

      <div class="row">
        <button class="btn" id="btnSettings">Settings (Supabase / API)</button>
        <button class="btn" id="btnTest">Test Backend</button>
        <button class="btn primary" id="btnConnect">Connect / Sign in</button>
        <button class="btn danger" id="btnLogout" style="display:none">Logout</button>
      </div>

      <div class="grid">
        <div class="card">
          <h2>‚úÖ Workspace ·É°·É¢·Éê·É¢·É£·É°·Éò</h2>
          <div class="muted">
            ·Éê·É• ·É®·Éî·Éí·Éò·É´·Éö·Éò·Éê:
            <ul class="klist">
              <li>·Éì·Éê·Éê·Éß·Éî·Éú·Éù Supabase URL + anon key + API_BASE</li>
              <li>·É®·Éî·Éê·Éõ·Éù·É¨·Éõ·Éù backend (/api/health)</li>
              <li>·Éí·Éê·Éò·Éê·É†·Éù Magic Link Login (email)</li>
              <li>·Éí·Éê·Éõ·Éù·Éò·Éß·Éî·Éú·Éù Chat ‚Äî ·É†·Éù·Éõ·Éî·Éö·Éò·É™ backend-·É° ·Éî·É´·Éê·ÉÆ·Éò·É° (/api/ai)</li>
            </ul>
          </div>

          <div class="hint">
            <div>‚úÖ Tip:</div>
            <div>·Éó·É£ <b>Failed to fetch</b> ·É©·Éê·Éú·É° ‚Äî 99% ·Éê·É†·Éò·É° CORS ·Éê·Éú API_BASE ·Éê·É†·Éê·É°·É¨·Éù·É†·Éò·Éê.</div>
            <div class="small">API_BASE ·É£·Éú·Éì·Éê ·Éò·Éß·Éù·É°: <b>https://avatarg-backend.vercel.app</b></div>
          </div>

          <div class="log" id="syslog">[boot] Page loaded‚Ä¶</div>
        </div>

        <div class="card">
          <h2>üí¨ Chat (frontend ‚Üí backend /api/ai)</h2>

          <div class="chatBox">
            <div class="msgs" id="msgs"></div>

            <div class="composer">
              <textarea id="prompt" placeholder="·Éì·Éê·É¨·Éî·É†·Éî ·Éõ·Éî·É°·Éò·ÉØ·Éò‚Ä¶ (Enter = ·Éí·Éê·Éí·Éñ·Éê·Éï·Éú·Éê, Shift+Enter = ·Éê·ÉÆ·Éê·Éö·Éò ·ÉÆ·Éê·Éñ·Éò)"></textarea>
              <button class="btn primary" id="btnSend">Send</button>
            </div>

            <div class="small" id="chatStatus">Status: idle</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modalBack" id="modalBack" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalHead">
        <h3>Connect Avatar G to Supabase + Backend</h3>
        <button class="x" id="btnClose" aria-label="Close">√ó</button>
      </div>

      <div class="modalBody">
        <div class="small" style="margin-bottom:10px">
          Paste once ‚Äî saved in this browser (localStorage).
        </div>

        <div class="field">
          <div class="label">SUPABASE_URL</div>
          <input id="sbUrl" inputmode="url" placeholder="https://xxxx.supabase.co" autocomplete="off" />
        </div>

        <div class="field">
          <div class="label">API_BASE (backend domain)</div>
          <input id="apiBase" inputmode="url" placeholder="https://avatarg-backend.vercel.app" autocomplete="off" />
        </div>

        <div class="field">
          <div class="label">SUPABASE_ANON_KEY (public anon key)</div>
          <textarea id="sbAnon" rows="3" placeholder="eyJhbGciOi..." autocomplete="off"></textarea>
        </div>

        <div class="small">
          Supabase ‚Üí Project Settings ‚Üí API ‚Üí <b>Project URL</b> + <b>anon public key</b>.
          <br/>API_BASE ·Éê·É†·Éò·É° ·É®·Éî·Éú·Éò backend HTTPS domain.
        </div>

        <div class="log" id="cfglog">[cfg] Waiting‚Ä¶</div>
      </div>

      <div class="modalActions">
        <button class="btn" id="btnReset">Reset</button>
        <button class="btn primary" id="btnSave">Save & Continue</button>
      </div>
    </div>
  </div>

  <script>
    // ---------- Storage keys ----------
    const KEY = {
      SUPABASE_URL: "AVATARG_SUPABASE_URL",
      SUPABASE_ANON: "AVATARG_SUPABASE_ANON",
      API_BASE: "AVATARG_API_BASE",
      CHAT: "AVATARG_CHAT_LOG"
    };

    // ---------- DOM ----------
    const syslog = document.getElementById("syslog");
    const cfglog = document.getElementById("cfglog");
    const modalBack = document.getElementById("modalBack");

    const chipMode = document.getElementById("chipMode");
    const chipApi  = document.getElementById("chipApi");
    const chipSb   = document.getElementById("chipSb");
    const chipUser = document.getElementById("chipUser");

    const btnSettings = document.getElementById("btnSettings");
    const btnTest = document.getElementById("btnTest");
    const btnConnect = document.getElementById("btnConnect");
    const btnLogout = document.getElementById("btnLogout");
    const btnClose = document.getElementById("btnClose");
    const btnSave = document.getElementById("btnSave");
    const btnReset = document.getElementById("btnReset");

    const sbUrl = document.getElementById("sbUrl");
    const sbAnon = document.getElementById("sbAnon");
    const apiBase = document.getElementById("apiBase");

    const msgs = document.getElementById("msgs");
    const prompt = document.getElementById("prompt");
    const btnSend = document.getElementById("btnSend");
    const chatStatus = document.getElementById("chatStatus");

    // ---------- State ----------
    let supabaseClient = null;
    let currentUser = null;

    function log(el, text){
      const ts = new Date().toLocaleTimeString();
      el.textContent += `\n[${ts}] ${text}`;
      el.scrollTop = el.scrollHeight;
    }
    function setLog(el, text){
      el.textContent = text;
      el.scrollTop = el.scrollHeight;
    }

    function getCfg(){
      return {
        supabaseUrl: (localStorage.getItem(KEY.SUPABASE_URL) || "").trim(),
        supabaseAnon: (localStorage.getItem(KEY.SUPABASE_ANON) || "").trim(),
        apiBase: (localStorage.getItem(KEY.API_BASE) || "").trim().replace(/\/+$/,"")
      };
    }

    function saveCfg(cfg){
      localStorage.setItem(KEY.SUPABASE_URL, (cfg.supabaseUrl||"").trim());
      localStorage.setItem(KEY.SUPABASE_ANON, (cfg.supabaseAnon||"").trim());
      localStorage.setItem(KEY.API_BASE, (cfg.apiBase||"").trim().replace(/\/+$/,""));
    }

    function resetCfg(){
      localStorage.removeItem(KEY.SUPABASE_URL);
      localStorage.removeItem(KEY.SUPABASE_ANON);
      localStorage.removeItem(KEY.API_BASE);
    }

    function updateChips(){
      const cfg = getCfg();

      chipMode.textContent = currentUser ? "Mode: Authenticated" : "Mode: Ready";

      if(cfg.apiBase){
        chipApi.textContent = "API_BASE: set";
        chipApi.classList.add("ok");
        chipApi.classList.remove("bad");
      }else{
        chipApi.textContent = "API_BASE: not set";
        chipApi.classList.remove("ok");
        chipApi.classList.remove("bad");
      }

      if(cfg.supabaseUrl && cfg.supabaseAnon){
        chipSb.textContent = "Supabase: set";
        chipSb.classList.add("ok");
        chipSb.classList.remove("bad");
      }else{
        chipSb.textContent = "Supabase: not set";
        chipSb.classList.remove("ok");
        chipSb.classList.remove("bad");
      }

      if(currentUser?.email){
        chipUser.textContent = "User: " + currentUser.email;
        chipUser.classList.add("ok");
        btnLogout.style.display = "inline-flex";
        btnConnect.textContent = "Connect / Sign in";
      }else{
        chipUser.textContent = "User: not signed in";
        chipUser.classList.remove("ok");
        btnLogout.style.display = "none";
        btnConnect.textContent = "Connect / Sign in";
      }
    }

    function openModal(){
      const cfg = getCfg();
      sbUrl.value = cfg.supabaseUrl;
      sbAnon.value = cfg.supabaseAnon;
      apiBase.value = cfg.apiBase || "https://avatarg-backend.vercel.app";
      setLog(cfglog, "[cfg] Paste values and Save & Continue‚Ä¶");
      modalBack.style.display = "flex";

      // IMPORTANT: ensure keyboard opens on mobile by focusing input AFTER modal shown
      setTimeout(() => {
        sbUrl.focus();
        sbUrl.scrollIntoView({behavior:"smooth", block:"center"});
      }, 120);
    }

    function closeModal(){
      modalBack.style.display = "none";
    }

    function ensureSupabase(){
      const cfg = getCfg();
      if(!cfg.supabaseUrl || !cfg.supabaseAnon){
        log(syslog, "Supabase config missing. Open Settings and paste SUPABASE_URL + ANON key.");
        chipSb.classList.add("bad");
        return null;
      }
      if(!window.supabase){
        log(syslog, "Supabase SDK not loaded (CDN).");
        return null;
      }
      if(!supabaseClient){
        supabaseClient = window.supabase.createClient(cfg.supabaseUrl, cfg.supabaseAnon);
        log(syslog, "Supabase client ready.");
      }
      return supabaseClient;
    }

    async function readUser(){
      const sb = ensureSupabase();
      if(!sb) return null;
      try{
        const { data, error } = await sb.auth.getUser();
        if(error) throw error;
        currentUser = data?.user || null;
        updateChips();
        return currentUser;
      }catch(e){
        log(syslog, "Auth getUser error: " + (e?.message || e));
        currentUser = null;
        updateChips();
        return null;
      }
    }

    async function magicLinkLogin(){
      const sb = ensureSupabase();
      if(!sb){
        openModal();
        return;
      }

      // Use a prompt to keep it simple and make keyboard open (browser built-in)
      const email = window.prompt("Enter email for Magic Link login:");
      if(!email) return;

      try{
        log(syslog, "Sending magic link‚Ä¶");
        const { error } = await sb.auth.signInWithOtp({
          email: email.trim(),
          options: {
            emailRedirectTo: window.location.href
          }
        });
        if(error) throw error;
        log(syslog, "Magic link sent. Check your email, open link on SAME device/browser.");
        alert("Magic link sent ‚úÖ\n·Éí·Éê·ÉÆ·É°·Éî·Éú·Éò email-·Éò·Éì·Éê·Éú ·Éö·Éò·Éú·Éô·Éò ·Éê·Éõ·Éê·Éï·Éî ·Éë·É†·Éê·É£·Éñ·Éî·É†·É®·Éò.");
      }catch(e){
        log(syslog, "Login error: " + (e?.message || e));
        alert("Login error: " + (e?.message || e));
      }
    }

    async function logout(){
      const sb = ensureSupabase();
      if(!sb) return;
      try{
        await sb.auth.signOut();
        currentUser = null;
        supabaseClient = null;
        log(syslog, "Signed out.");
        updateChips();
      }catch(e){
        log(syslog, "Sign out error: " + (e?.message || e));
      }
    }

    // ---------- Backend ----------
    function withTimeout(ms){
      const ctrl = new AbortController();
      const t = setTimeout(() => ctrl.abort(), ms);
      return { ctrl, done: () => clearTimeout(t) };
    }

    async function testBackend(){
      const cfg = getCfg();
      if(!cfg.apiBase){
        log(syslog, "API_BASE not set. Open Settings.");
        chipApi.classList.add("bad");
        openModal();
        return;
      }

      const url = cfg.apiBase.replace(/\/+$/,"") + "/api/health";
      const { ctrl, done } = withTimeout(12000);

      try{
        log(syslog, "Testing backend: " + url);
        const res = await fetch(url, { method:"GET", signal: ctrl.signal, cache:"no-store" });
        done();
        const txt = await res.text();
        if(!res.ok){
          chipApi.classList.add("bad");
          log(syslog, "Backend error: HTTP " + res.status + " " + txt);
          alert("Backend error: HTTP " + res.status);
          return;
        }
        chipApi.classList.add("ok");
        chipApi.classList.remove("bad");
        log(syslog, "Backend OK: " + txt);
      }catch(e){
        done();
        chipApi.classList.add("bad");
        log(syslog, "Backend error: " + (e?.message || e) + " (Failed to fetch = CORS/Network/HTTPS mismatch)");
        alert("Backend error: Failed to fetch\n(·ÉÆ·É®·Éò·É†·Éê·Éì ·Éê·É†·Éò·É° CORS ·Éê·Éú API_BASE ·Éê·É†·Éê·É°·É¨·Éù·É†·Éò·Éê)");
      }
    }

    // ---------- Chat ----------
    function loadChat(){
      try{
        const raw = localStorage.getItem(KEY.CHAT);
        const arr = raw ? JSON.parse(raw) : [];
        msgs.innerHTML = "";
        arr.forEach(m => addMsg(m.role, m.text, false));
        msgs.scrollTop = msgs.scrollHeight;
      }catch{
        msgs.innerHTML = "";
      }
    }

    function saveChat(){
      const items = [...msgs.querySelectorAll(".bubble")].map(b => ({
        role: b.classList.contains("me") ? "user" : "assistant",
        text: b.textContent || ""
      }));
      localStorage.setItem(KEY.CHAT, JSON.stringify(items.slice(-60)));
    }

    function addMsg(role, text, persist=true){
      const div = document.createElement("div");
      div.className = "bubble " + (role === "user" ? "me" : "ai");
      div.textContent = text;
      msgs.appendChild(div);
      msgs.scrollTop = msgs.scrollHeight;
      if(persist) saveChat();
    }

    async function sendChat(){
      const cfg = getCfg();
      const text = (prompt.value || "").trim();
      if(!text) return;

      if(!cfg.apiBase){
        addMsg("assistant", "‚ùå API_BASE ·Éê·É† ·Éê·É†·Éò·É° ·Éì·Éê·Éß·Éî·Éú·Éî·Éë·É£·Éö·Éò. ·Éí·Éê·ÉÆ·É°·Éî·Éú·Éò Settings ·Éì·Éê ·É©·Éê·É°·Éï·Éò backend domain.");
        openModal();
        return;
      }

      addMsg("user", text);
      prompt.value = "";
      chatStatus.textContent = "Status: sending‚Ä¶";
      btnSend.disabled = true;

      const url = cfg.apiBase.replace(/\/+$/,"") + "/api/ai";

      const payload = {
        message: text,
        // optional metadata
        client: "AvatarG-Workspace",
        user: currentUser?.email || null
      };

      const { ctrl, done } = withTimeout(30000);

      try{
        const res = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
          signal: ctrl.signal
        });
        done();

        const ct = res.headers.get("content-type") || "";
        let data = null;
        if(ct.includes("application/json")){
          data = await res.json();
        }else{
          const t = await res.text();
          data = { text: t };
        }

        if(!res.ok){
          const msg = data?.error || data?.message || ("HTTP " + res.status);
          addMsg("assistant", "‚ùå Backend error: " + msg);
          chatStatus.innerHTML = `<span class="dangerText">Status: error</span>`;
          btnSend.disabled = false;
          return;
        }

        const answer =
          data?.reply ||
          data?.output ||
          data?.text ||
          data?.message ||
          JSON.stringify(data, null, 2);

        addMsg("assistant", answer);
        chatStatus.innerHTML = `<span class="okText">Status: ok</span>`;
      }catch(e){
        done();
        addMsg("assistant", "‚ùå Failed to fetch / timeout. (CORS ·Éê·Éú backend route ·Éû·É†·Éù·Éë·Éö·Éî·Éõ·Éê)\n" + (e?.message || e));
        chatStatus.innerHTML = `<span class="dangerText">Status: failed</span>`;
      }finally{
        btnSend.disabled = false;
      }
    }

    // Enter to send
    prompt.addEventListener("keydown", (e) => {
      if(e.key === "Enter" && !e.shiftKey){
        e.preventDefault();
        sendChat();
      }
    });

    // ---------- Events ----------
    btnSettings.addEventListener("click", openModal);
    btnClose.addEventListener("click", closeModal);
    modalBack.addEventListener("click", (e) => {
      if(e.target === modalBack) closeModal();
    });

    btnSave.addEventListener("click", () => {
      const cfg = {
        supabaseUrl: sbUrl.value.trim(),
        supabaseAnon: sbAnon.value.trim(),
        apiBase: apiBase.value.trim().replace(/\/+$/,"")
      };

      // light validation
      if(cfg.apiBase && !cfg.apiBase.startsWith("https://")){
        setLog(cfglog, "‚ùå API_BASE ·É£·Éú·Éì·Éê ·Éò·É¨·Éß·Éî·Éë·Éù·Éì·Éî·É° https://");
        return;
      }
      if(cfg.supabaseUrl && !cfg.supabaseUrl.includes("supabase.co")){
        // still allow, just warn
        log(cfglog, "‚ö†Ô∏è SUPABASE_URL ·Éê·É† ·É∞·Éí·Éê·Éï·É° supabase.co domain-·É°. ·Éí·Éê·Éì·Éê·Éê·Éõ·Éù·É¨·Éõ·Éî.");
      }

      saveCfg(cfg);
      supabaseClient = null; // rebuild
      setLog(cfglog, "‚úÖ Config saved. You can test backend and connect.");
      log(syslog, "Config saved.");
      updateChips();
      setTimeout(closeModal, 250);
    });

    btnReset.addEventListener("click", () => {
      resetCfg();
      supabaseClient = null;
      currentUser = null;
      setLog(cfglog, "‚úÖ Reset done.");
      setLog(syslog, "[boot] Reset done.");
      updateChips();
    });

    btnTest.addEventListener("click", testBackend);

    btnConnect.addEventListener("click", async () => {
      // Ensure config first
      const cfg = getCfg();
      if(!cfg.supabaseUrl || !cfg.supabaseAnon){
        openModal();
        return;
      }
      await magicLinkLogin();
      // After magic link open, auth will update
    });

    btnLogout.addEventListener("click", logout);

    btnSend.addEventListener("click", sendChat);

    // ---------- Init ----------
    (async function init(){
      setLog(syslog, "[boot] Page loaded‚Ä¶");
      updateChips();

      // load chat from localStorage
      loadChat();

      // auto-init supabase if configured
      const cfg = getCfg();
      if(cfg.supabaseUrl && cfg.supabaseAnon){
        ensureSupabase();
        await readUser();

        // Listen auth changes
        try{
          supabaseClient?.auth?.onAuthStateChange(async (event, session) => {
            currentUser = session?.user || null;
            updateChips();
            log(syslog, "Auth event: " + event);
          });
        }catch(e){}
      }

      // quick backend hint
      if(cfg.apiBase){
        log(syslog, "API_BASE loaded: " + cfg.apiBase);
      }else{
        log(syslog, "API_BASE not set yet. Open Settings.");
      }
    })();
  </script>
</body>
</html>
