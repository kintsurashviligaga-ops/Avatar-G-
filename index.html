<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Avatar G Workspace</title>

  <!-- React 18 (CDN) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Babel (JSX in one file) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- âœ… Supabase JS v2 UMD (IMPORTANT: exposes window.supabase reliably) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.49.1/dist/umd/supabase.min.js"></script>

  <style>
    :root{
      --bg:#070A0F;
      --panel: rgba(255,255,255,0.06);
      --panel2: rgba(255,255,255,0.04);
      --line: rgba(255,255,255,0.10);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.62);
      --accent:#22d3ee;
      --accent2:#3b82f6;
      --danger:#ff6b6b;
      --ok:#22c55e;
      --shadow: 0 16px 40px rgba(0,0,0,0.35);
      --r: 18px;
      --r2: 14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(900px 600px at 20% 10%, rgba(34,211,238,0.12), transparent 60%),
        radial-gradient(900px 600px at 90% 10%, rgba(59,130,246,0.10), transparent 60%),
        radial-gradient(1200px 900px at 50% 100%, rgba(255,255,255,0.05), transparent 60%),
        var(--bg);
      color:var(--text);
      min-height:100vh;
    }
    a{color:var(--accent); text-decoration:none}
    .wrap{
      max-width:1200px;
      margin:0 auto;
      padding:18px;
      display:grid;
      gap:14px;
    }
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:14px 16px;
      border:1px solid var(--line);
      background: linear-gradient(135deg, rgba(34,211,238,0.14), rgba(59,130,246,0.10));
      border-radius: var(--r);
      box-shadow: var(--shadow);
    }
    .brand{display:flex; align-items:center; gap:12px;}
    .logo{
      width:34px;height:34px;border-radius:12px;
      border:1px solid rgba(34,211,238,0.30);
      background: linear-gradient(135deg, rgba(34,211,238,0.28), rgba(59,130,246,0.18));
      display:grid; place-items:center;
      font-weight:900;
    }
    .brand h1{margin:0; font-size:16px; letter-spacing:0.2px;}
    .brand p{margin:0; font-size:12px; color:var(--muted)}
    .actions{display:flex; gap:10px; align-items:center}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,0.18);
      font-size:12px; color:var(--muted);
      white-space:nowrap;
    }
    .btn{
      border:none;
      padding:10px 14px;
      border-radius: 999px;
      font-weight:900;
      cursor:pointer;
      color:#fff;
      background: linear-gradient(135deg, rgba(34,211,238,0.55), rgba(59,130,246,0.35));
      box-shadow: 0 10px 28px rgba(34,211,238,0.16);
    }
    .btn:disabled{opacity:.55; cursor:not-allowed; box-shadow:none}
    .btn2{
      border:1px solid var(--line);
      background: rgba(255,255,255,0.06);
      color:var(--text);
      padding:10px 14px;
      border-radius: 999px;
      font-weight:900;
      cursor:pointer;
    }
    .grid{display:grid; grid-template-columns: 360px 1fr; gap:14px;}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr;} }
    .card{
      border:1px solid var(--line);
      background: rgba(255,255,255,0.04);
      border-radius: var(--r);
      padding:14px;
      box-shadow: var(--shadow);
    }
    .cardTitle{display:flex; align-items:center; justify-content:space-between; margin-bottom:10px;}
    .cardTitle h2{margin:0; font-size:14px; letter-spacing:0.2px}
    .sub{font-size:12px; color:var(--muted); margin-top:6px; line-height:1.5}
    .notice{
      border:1px solid rgba(245,158,11,0.30);
      background: rgba(245,158,11,0.10);
      color: rgba(255,255,255,0.85);
      padding:12px 14px;
      border-radius: 14px;
      font-size:12px;
      line-height:1.4;
    }
    .kpiRow{display:grid; gap:10px}
    .kpi{
      border:1px solid var(--line);
      background: rgba(0,0,0,0.20);
      border-radius: 16px;
      padding:12px;
    }
    .kpiTop{display:flex; justify-content:space-between; align-items:center}
    .kpiLabel{font-size:12px; color:var(--muted); font-weight:800}
    .badge{
      font-size:11px; font-weight:900;
      padding:5px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,0.05);
      color: var(--muted);
    }
    .bar{
      height:10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,0.04);
      overflow:hidden;
      margin-top:10px;
    }
    .bar > div{
      height:100%;
      background: linear-gradient(135deg, rgba(34,211,238,0.65), rgba(59,130,246,0.40));
      width:0%;
      transition: width .25s ease;
    }
    .row{display:flex; gap:10px; align-items:center;}
    .input{
      width:100%;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,0.22);
      color: var(--text);
      padding:12px 12px;
      outline:none;
      font-size:14px;
    }
    .miniBtn{
      border:1px solid var(--line);
      background: rgba(255,255,255,0.05);
      color: var(--text);
      border-radius: 14px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:900;
      min-width:48px;
    }
    .miniBtnDanger{
      border:1px solid rgba(255,107,107,0.30);
      background: rgba(255,107,107,0.10);
      color: #ffd0d0;
    }
    .list{display:grid; gap:8px; margin-top:10px}
    .item{
      border:1px solid var(--line);
      background: rgba(255,255,255,0.05);
      border-radius: 14px;
      padding:10px 12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      cursor:pointer;
      transition: .15s ease;
    }
    .item:hover{transform: translateY(-1px)}
    .itemActive{
      border:1.5px solid rgba(34,211,238,0.40);
      background: linear-gradient(135deg, rgba(34,211,238,0.14), rgba(59,130,246,0.10));
    }
    .itemLeft{min-width:0}
    .itemName{
      font-weight:900; font-size:13px;
      overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
    }
    .itemMeta{font-size:11px; color:var(--muted); margin-top:3px}
    .modes{display:grid; gap:8px; margin-top:10px}
    .modeBtn{
      border:1px solid var(--line);
      background: rgba(255,255,255,0.05);
      color: var(--text);
      border-radius: 14px;
      padding:12px 12px;
      cursor:pointer;
      font-weight:900;
      display:flex; align-items:center; gap:10px;
    }
    .modeBtnActive{
      border:1.5px solid rgba(34,211,238,0.45);
      background: linear-gradient(135deg, rgba(34,211,238,0.14), rgba(59,130,246,0.10));
    }

    /* Chat panel */
    .chatCard{
      border:1px solid var(--line);
      background: rgba(255,255,255,0.04);
      border-radius: var(--r);
      overflow:hidden;
      box-shadow: var(--shadow);
      display:grid;
      grid-template-rows: auto 1fr auto;
      min-height: 68vh;
    }
    .chatHeader{
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(135deg, rgba(34,211,238,0.14), rgba(59,130,246,0.10));
      display:flex; justify-content:space-between; align-items:center;
      gap:10px;
    }
    .chatHeader h2{margin:0; font-size:14px}
    .chatHeader .meta{font-size:12px; color:var(--muted); margin-top:4px}
    .chatBody{
      padding:14px;
      overflow:auto;
      display:grid;
      gap:12px;
    }
    .msgRow{display:flex}
    .msgRow.user{justify-content:flex-end}
    .bubble{
      max-width: 78%;
      padding:12px 12px;
      border-radius: 16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,0.06);
      white-space: pre-wrap;
      line-height:1.5;
      font-size:14px;
    }
    .bubble.user{
      border:1.5px solid rgba(34,211,238,0.35);
      background: linear-gradient(135deg, rgba(34,211,238,0.14), rgba(59,130,246,0.10));
    }
    .composer{
      padding:14px;
      border-top:1px solid var(--line);
      background: rgba(255,255,255,0.03);
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:end;
    }
    textarea{
      width:100%;
      resize:none;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,0.22);
      color: var(--text);
      padding:12px;
      outline:none;
      font-size:14px;
      line-height:1.45;
      min-height: 52px;
    }

    /* Modal */
    .overlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,0.60);
      backdrop-filter: blur(6px);
      display:grid;
      place-items:center;
      z-index:9999;
      padding:16px;
    }
    .modal{
      width:min(760px, 100%);
      border-radius: 20px;
      border:1px solid var(--line);
      background: rgba(12,16,24,0.92);
      box-shadow: 0 30px 90px rgba(0,0,0,0.55);
      padding:16px;
    }
    .modalHeader{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
    }
    .modalHeader h3{margin:0; font-size:16px; letter-spacing:.2px}
    .modalHeader p{margin:6px 0 0 0; font-size:12px; color:var(--muted); line-height:1.45}
    .closeX{
      border:1px solid var(--line);
      background: rgba(255,255,255,0.06);
      color:var(--text);
      border-radius: 12px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:900;
    }
    .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    @media (max-width: 760px){ .grid2{grid-template-columns:1fr} }
    .help{
      margin-top:10px;
      font-size:12px;
      color: var(--muted);
      line-height:1.45;
    }
    .dangerText{color:#ffd0d0}
    .okText{color:#bfffd2}
    .tiny{font-size:11px; color:var(--muted)}
  </style>
</head>

<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useEffect, useMemo, useRef, useState } = React;

    // CONFIG storage
    const CONFIG_KEY = "avatarg_config_v1";

    function loadConfig(){
      try{
        const raw = localStorage.getItem(CONFIG_KEY);
        if(!raw) return null;
        const obj = JSON.parse(raw);
        if(!obj) return null;
        return obj;
      }catch(e){ return null; }
    }

    function saveConfig(cfg){
      localStorage.setItem(CONFIG_KEY, JSON.stringify(cfg));
    }

    function isValidUrl(u){
      try{ new URL(u); return true; }catch(e){ return false; }
    }

    function fmtBytes(bytes){
      if(!bytes || bytes <= 0) return "0 B";
      const units = ["B","KB","MB","GB","TB"];
      const i = Math.min(units.length-1, Math.floor(Math.log(bytes)/Math.log(1024)));
      const v = bytes / Math.pow(1024, i);
      return (i === 0 ? v.toFixed(0) : v.toFixed(1)) + " " + units[i];
    }

    // Plans
    const PLANS = {
      guest:   { name:"GUEST",   projects: 1,  storageBytes: 1,                 priceLabel: "Free" },
      free:    { name:"FREE",    projects: 2,  storageBytes: 1 * 1024**3,      priceLabel: "$0" },
      pro:     { name:"PRO",     projects: 10, storageBytes: 50 * 1024**3,     priceLabel: "$19" },
      studio:  { name:"STUDIO",  projects: 999999, storageBytes: 999999999999, priceLabel: "$49" },
    };

    const SERVICE_MODES = [
      { id:"general",  title:"Chat",     icon:"ðŸ’¬" },
      { id:"avatar",   title:"Avatar",   icon:"ðŸ§‘â€ðŸŽ­" },
      { id:"voice",    title:"Voice",    icon:"ðŸŽ¤" },
      { id:"music",    title:"Music",    icon:"ðŸŽµ" },
      { id:"video",    title:"Video",    icon:"ðŸŽ¬" },
      { id:"photo",    title:"Photo",    icon:"ðŸ“¸" },
      { id:"marketing",title:"Marketing",icon:"ðŸ“ˆ" },
    ];

    // âœ… Supabase Client Helper (hardened)
    function createSupabaseClient(cfg){
      if(!window.supabase || !window.supabase.createClient){
        throw new Error("Supabase SDK not loaded. Check CDN link.");
      }
      return window.supabase.createClient(cfg.SUPABASE_URL, cfg.SUPABASE_ANON_KEY, {
        auth: {
          flowType: "pkce",
          persistSession: true,
          autoRefreshToken: true,
          detectSessionInUrl: true
        }
      });
    }

    // Backend fetch helper
    async function apiFetch(cfg, path, { method="GET", headers={}, body=null, token=null, isJson=true } = {}){
      const url = cfg.API_BASE.replace(/\/$/, "") + path;
      const h = { ...headers };
      if(token) h["Authorization"] = "Bearer " + String(token);
      if(isJson && body && !h["Content-Type"]) h["Content-Type"] = "application/json";

      const res = await fetch(url, {
        method,
        headers: h,
        body: isJson && body ? JSON.stringify(body) : body
      });

      const text = await res.text();
      let data = null;
      try{ data = text ? JSON.parse(text) : null; }catch(e){ data = { raw: text }; }
      if(!res.ok){
        const msg = data?.error || data?.message || ("Request failed: " + res.status);
        throw new Error(msg);
      }
      return data;
    }

    // CONFIG MODAL
    function ConfigModal({ open, initial, onClose, onSave }){
      const [cfg, setCfg] = useState(initial || { SUPABASE_URL:"", SUPABASE_ANON_KEY:"", API_BASE:"" });
      const [err, setErr] = useState("");

      useEffect(()=>{ setCfg(initial || { SUPABASE_URL:"", SUPABASE_ANON_KEY:"", API_BASE:"" }); }, [initial]);

      function validate(){
        if(!cfg.SUPABASE_URL || !isValidUrl(cfg.SUPABASE_URL)) return "SUPABASE_URL is invalid";
        if(!cfg.SUPABASE_ANON_KEY || cfg.SUPABASE_ANON_KEY.length < 30) return "SUPABASE_ANON_KEY looks wrong";
        if(!cfg.API_BASE || !isValidUrl(cfg.API_BASE)) return "API_BASE is invalid (must be https://...)";
        return "";
      }

      if(!open) return null;
      return (
        <div className="overlay">
          <div className="modal">
            <div className="modalHeader">
              <div>
                <h3>Connect Avatar G to Supabase + Backend</h3>
                <p>Paste once and it will be saved in this browser (localStorage).</p>
              </div>
              <button className="closeX" onClick={onClose}>X</button>
            </div>

            <div className="grid2">
              <div>
                <div className="tiny" style={{marginBottom:6}}>SUPABASE_URL</div>
                <input className="input" value={cfg.SUPABASE_URL} onChange={e=>setCfg({...cfg, SUPABASE_URL:e.target.value.trim()})} placeholder="https://xxxx.supabase.co" />
              </div>
              <div>
                <div className="tiny" style={{marginBottom:6}}>API_BASE (backend domain)</div>
                <input className="input" value={cfg.API_BASE} onChange={e=>setCfg({...cfg, API_BASE:e.target.value.trim()})} placeholder="https://your-backend.com" />
              </div>
              <div style={{gridColumn:"1 / -1"}}>
                <div className="tiny" style={{marginBottom:6}}>SUPABASE_ANON_KEY (public anon key)</div>
                <input className="input" value={cfg.SUPABASE_ANON_KEY} onChange={e=>setCfg({...cfg, SUPABASE_ANON_KEY:e.target.value.trim()})} placeholder="eyJhbGciOiJIUzI1NiIs..." />
              </div>
            </div>

            {err && (
              <div className="notice" style={{marginTop:10, borderColor:"rgba(255,107,107,0.35)", background:"rgba(255,107,107,0.12)"}}>
                <b className="dangerText">WARNING: {err}</b>
              </div>
            )}

            <div style={{display:"flex", gap:10, justifyContent:"flex-end", marginTop:12}}>
              <button className="btn2" onClick={()=>{
                localStorage.removeItem(CONFIG_KEY);
                setCfg({ SUPABASE_URL:"", SUPABASE_ANON_KEY:"", API_BASE:"" });
                setErr("");
              }}>Reset</button>

              <button className="btn" onClick={()=>{
                const v = validate();
                if(v){ setErr(v); return; }
                setErr("");
                onSave(cfg);
              }}>Save & Continue</button>
            </div>

            <div className="help">
              Supabase -> Project Settings -> API -> Project URL + anon public key.<br/>
              API_BASE is your backend HTTPS domain.
            </div>
          </div>
        </div>
      );
    }

    // âœ… AUTH MODAL (fixed redirect)
    function AuthModal({ open, onClose, supabase }){
      const [email, setEmail] = useState("");
      const [password, setPassword] = useState("");
      const [busy, setBusy] = useState(false);
      const [msg, setMsg] = useState("");

      useEffect(()=>{ setMsg(""); }, [open]);

      if(!open) return null;

      return (
        <div className="overlay">
          <div className="modal">
            <div className="modalHeader">
              <div>
                <h3>Sign in to Avatar G</h3>
                <p>Magic link or Email/Password (Supabase Auth)</p>
              </div>
              <button className="closeX" onClick={onClose}>X</button>
            </div>

            <div className="grid2">
              <div style={{gridColumn:"1 / -1"}}>
                <div className="tiny" style={{marginBottom:6}}>Email</div>
                <input className="input" value={email} onChange={e=>setEmail(e.target.value)} placeholder="you@domain.com" />
              </div>
              <div style={{gridColumn:"1 / -1"}}>
                <div className="tiny" style={{marginBottom:6}}>Password (optional)</div>
                <input className="input" value={password} onChange={e=>setPassword(e.target.value)} placeholder="********" type="password" />
              </div>
            </div>

            {msg && <div className="notice" style={{marginTop:10}}>{msg}</div>}

            <div style={{display:"flex", gap:10, justifyContent:"flex-end", marginTop:12}}>
              <button className="btn2" disabled={busy} onClick={async ()=>{
                if(!email.trim()) return setMsg("Email is required");
                setBusy(true);
                setMsg("");
                try{
                  // âœ… safest redirect (origin only) to avoid non-latin / weird chars
                  const safeRedirect = window.location.origin;

                  const { error } = await supabase.auth.signInWithOtp({
                    email: email.trim(),
                    options: {
                      emailRedirectTo: safeRedirect
                    }
                  });

                  if(error) throw error;
                  setMsg("OK - Magic link sent. Open your email and confirm.");
                }catch(e){
                  setMsg("ERROR: " + (e?.message || "Failed"));
                }finally{ setBusy(false); }
              }}>Send Magic Link</button>

              <button className="btn" disabled={busy} onClick={async ()=>{
                if(!email.trim() || !password.trim()) return setMsg("Email + Password required");
                setBusy(true);
                setMsg("");
                try{
                  const { error } = await supabase.auth.signInWithPassword({ email: email.trim(), password: password.trim() });
                  if(error){
                    const { error: suErr } = await supabase.auth.signUp({ email: email.trim(), password: password.trim() });
                    if(suErr) throw suErr;
                    setMsg("OK - Account created. Check email if confirmation is enabled.");
                  }else{
                    setMsg("OK - Signed in.");
                    onClose();
                  }
                }catch(e){
                  setMsg("ERROR: " + (e?.message || "Failed"));
                }finally{ setBusy(false); }
              }}>{busy ? "..." : "Sign in / Sign up"}</button>
            </div>

            <div className="help tiny">
              Tip: if Email confirmation is enabled in Supabase, you must confirm email on first sign-up.
            </div>
          </div>
        </div>
      );
    }

    // MAIN APP
    function App(){
      const [config, setConfig] = useState(loadConfig());
      const [configOpen, setConfigOpen] = useState(!loadConfig());
      const [supabase, setSupabase] = useState(null);

      const [session, setSession] = useState(null);
      const [user, setUser] = useState(null);

      const [plan, setPlan] = useState("guest");
      const [storageUsed, setStorageUsed] = useState(0);
      const [storageMax, setStorageMax] = useState(PLANS.guest.storageBytes);

      const [projects, setProjects] = useState([]);
      const [activeProjectId, setActiveProjectId] = useState("");
      const [newProjectName, setNewProjectName] = useState("");

      const [mode, setMode] = useState("general");
      const [messages, setMessages] = useState([
        { role:"assistant", content:
`Welcome to Avatar G Workspace.

- Unified GPT-style window
- Projects + Files
- Usage limits + Billing

Upload files and tell me what you want.` }
      ]);
      const [input, setInput] = useState("");
      const [streaming, setStreaming] = useState(false);

      const bottomRef = useRef(null);

      const configWarning = useMemo(()=> {
        if(!config) return "CONFIG is not set. Open Settings and paste SUPABASE + API_BASE.";
        const ok = config?.SUPABASE_URL && config?.SUPABASE_ANON_KEY && config?.API_BASE;
        return ok ? "" : "CONFIG is incomplete.";
      }, [config]);

      // Init supabase when config exists
      useEffect(()=>{
        if(!config) return;
        try{
          const sb = createSupabaseClient(config);
          setSupabase(sb);

          sb.auth.getSession().then(({ data })=>{
            setSession(data.session || null);
            setUser(data.session?.user || null);
          });

          const { data: sub } = sb.auth.onAuthStateChange((_event, newSession)=>{
            setSession(newSession || null);
            setUser(newSession?.user || null);
          });

          return ()=> sub?.subscription?.unsubscribe?.();
        }catch(e){
          console.error(e);
        }
      }, [config]);

      function scrollBottom(){
        requestAnimationFrame(()=> bottomRef.current?.scrollIntoView({ behavior:"smooth" }));
      }

      async function refreshAll(){
        if(!config || !session) return;
        try{
          const token = session.access_token;
          const usage = await apiFetch(config, "/usage", { token });
          const planId = usage?.plan || "free";
          setPlan(planId);
          setStorageUsed(usage?.storageUsedBytes || 0);
          setStorageMax(usage?.storageMaxBytes || PLANS[planId]?.storageBytes || PLANS.free.storageBytes);

          const list = await apiFetch(config, "/projects", { token });
          setProjects(Array.isArray(list) ? list : []);
          if(Array.isArray(list) && list.length){
            setActiveProjectId(prev => prev && list.find(p=>p.id===prev) ? prev : list[0].id);
          }else{
            setActiveProjectId("");
          }
        }catch(e){
          console.warn(e);
        }
      }

      useEffect(()=>{
        if(session && config) refreshAll();
      }, [session, config]);

      const limits = useMemo(()=>{
        const p = PLANS[plan] || PLANS.free;
        return { maxProjects: p.projects, maxStorage: storageMax || p.storageBytes };
      }, [plan, storageMax]);

      const storagePct = useMemo(()=>{
        const max = Math.max(1, limits.maxStorage);
        return Math.min(100, Math.round((storageUsed / max) * 100));
      }, [storageUsed, limits.maxStorage]);

      const canCreateProject = useMemo(()=>{
        if(!session) return false;
        return projects.length < limits.maxProjects;
      }, [projects.length, limits.maxProjects, session]);

      const canUseApp = useMemo(()=>{
        return !!config && !!supabase;
      }, [config, supabase]);

      const canChat = useMemo(()=>{
        return !!session && !!activeProjectId && !streaming && !!config;
      }, [session, activeProjectId, streaming, config]);

      async function createProject(){
        if(!session || !config) return;
        const name = newProjectName.trim();
        if(!name) return;
        if(!canCreateProject){
          alert("Project limit reached. Upgrade plan.");
          return;
        }
        try{
          const token = session.access_token;
          const p = await apiFetch(config, "/projects", { method:"POST", token, body:{ name } });
          setNewProjectName("");
          await refreshAll();
          if(p?.id) setActiveProjectId(p.id);
        }catch(e){
          alert(e.message || "Failed to create project");
        }
      }

      async function deleteProject(id){
        if(!session || !config) return;
        if(!confirm("Delete this project?")) return;
        try{
          const token = session.access_token;
          await apiFetch(config, "/projects/" + encodeURIComponent(id), { method:"DELETE", token });
          await refreshAll();
        }catch(e){
          alert(e.message || "Failed to delete");
        }
      }

      async function uploadFile(){
        if(!session || !config || !activeProjectId) return;
        const inputEl = document.createElement("input");
        inputEl.type = "file";
        inputEl.onchange = async (e)=>{
          const file = e.target.files?.[0];
          if(!file) return;
          if(storageUsed + file.size > limits.maxStorage){
            alert("Storage limit reached. Upgrade plan.");
            return;
          }
          try{
            const token = session.access_token;
            const fd = new FormData();
            fd.append("file", file);
            fd.append("projectId", activeProjectId);

            const data = await apiFetch(config, "/upload", { method:"POST", token, body: fd, isJson:false });
            setMessages(prev => [...prev, { role:"assistant", content:`Uploaded: ${data?.meta?.name || file.name}` }]);
            await refreshAll();
            scrollBottom();
          }catch(e){
            alert(e.message || "Upload failed");
          }
        };
        inputEl.click();
      }

      async function stripeCheckout(planKey){
        if(!session || !config) return;
        try{
          const token = session.access_token;
          const data = await apiFetch(config, "/billing/checkout", { method:"POST", token, body:{ plan: planKey }});
          if(!data?.url) throw new Error("No checkout url returned");
          window.location.href = data.url;
        }catch(e){
          alert(e.message || "Checkout failed");
        }
      }

      async function openPortal(){
        if(!session || !config) return;
        try{
          const token = session.access_token;
          const data = await apiFetch(config, "/billing/portal", { method:"POST", token, body:{}});
          if(!data?.url) throw new Error("No portal url returned");
          window.location.href = data.url;
        }catch(e){
          alert(e.message || "Portal failed");
        }
      }

      async function send(){
        const text = input.trim();
        if(!text || !canChat) return;

        const next = [...messages, { role:"user", content:text }];
        setMessages(next);
        setInput("");
        setStreaming(true);
        scrollBottom();

        setMessages(prev => [...prev, { role:"assistant", content:"" }]);

        try{
          const token = session.access_token;
          const url = config.API_BASE.replace(/\/$/,"") + "/chat";

          const res = await fetch(url, {
            method:"POST",
            headers:{
              "Content-Type":"application/json",
              "Authorization":"Bearer " + String(token)
            },
            body: JSON.stringify({ mode, projectId: activeProjectId, messages: next })
          });

          const ct = res.headers.get("content-type") || "";
          if(!res.ok) {
            const t = await res.text();
            let j = null; try{ j = JSON.parse(t); }catch(e){}
            throw new Error(j?.error || t || "Chat failed");
          }

          if(ct.includes("application/json")){
            const j = await res.json();
            const reply = j.reply || j.message || "(no reply)";
            setMessages(prev => {
              const copy = [...prev];
              const last = copy[copy.length-1];
              if(last?.role==="assistant") last.content = reply;
              return copy;
            });
            scrollBottom();
          } else if(res.body){
            const reader = res.body.getReader();
            const decoder = new TextDecoder();
            let buffer = "";
            while(true){
              const { done, value } = await reader.read();
              if(done) break;
              buffer += decoder.decode(value, { stream:true });
              const parts = buffer.split("\n\n");
              buffer = parts.pop() || "";
              for(const part of parts){
                const line = part.trim();
                if(!line.startsWith("data:")) continue;
                const jsonStr = line.slice(5).trim();
                if(!jsonStr) continue;
                const evt = JSON.parse(jsonStr);
                if(evt.type === "delta"){
                  const delta = evt.delta || "";
                  if(!delta) continue;
                  setMessages(prev=>{
                    const copy=[...prev];
                    const last=copy[copy.length-1];
                    if(last?.role==="assistant") last.content += delta;
                    return copy;
                  });
                  scrollBottom();
                }
                if(evt.type === "error"){
                  throw new Error(evt.message || "Stream error");
                }
              }
            }
          }
        }catch(e){
          setMessages(prev=>{
            const copy=[...prev];
            const last=copy[copy.length-1];
            const msg = "ERROR: " + (e?.message || "Unknown error");
            if(last?.role==="assistant") last.content = msg;
            else copy.push({ role:"assistant", content: msg });
            return copy;
          });
        }finally{
          setStreaming(false);
          scrollBottom();
        }
      }

      async function signOut(){
        if(!supabase) return;
        await supabase.auth.signOut();
        setProjects([]);
        setActiveProjectId("");
        setPlan("guest");
        setStorageUsed(0);
        setStorageMax(PLANS.guest.storageBytes);
      }

      return (
        <div className="wrap">
          <ConfigModal
            open={configOpen}
            initial={config || { SUPABASE_URL:"", SUPABASE_ANON_KEY:"", API_BASE:"" }}
            onClose={()=>{
              if(!config) return;
              setConfigOpen(false);
            }}
            onSave={(cfg)=>{
              saveConfig(cfg);
              setConfig(cfg);
              setConfigOpen(false);
            }}
          />

          <AuthModal
            open={!!supabase && !session && !configOpen && !!config}
            onClose={()=>{}}
            supabase={supabase}
          />

          <div className="topbar">
            <div className="brand">
              <div className="logo">âš¡</div>
              <div>
                <h1>Avatar G</h1>
                <p>Unified AI Workspace</p>
              </div>
            </div>

            <div className="actions">
              <span className="pill">Plan: <b style={{color:"var(--text)"}}>{(PLANS[plan]?.name || "GUEST")}</b></span>
              <span className="pill">User: <b style={{color:"var(--text)"}}>{user?.email || "Guest"}</b></span>
              <button className="btn2" onClick={()=>setConfigOpen(true)}>Settings</button>
              {session ? (
                <button className="btn2" onClick={signOut}>Sign out</button>
              ) : (
                <button className="btn" disabled={!canUseApp} onClick={()=>alert("Open Settings and paste Supabase + API_BASE. Then sign-in modal will appear.")}>
                  Sign in
                </button>
              )}
            </div>
          </div>

          {configWarning && (
            <div className="notice">
              <b>CONFIG is not set.</b><br/>
              Open <b>Settings</b> and paste:
              <br/>- <b>SUPABASE_URL</b> + <b>SUPABASE_ANON_KEY</b>
              <br/>- <b>API_BASE</b> (backend domain)
            </div>
          )}

          <div className="grid">
            <div className="card">
              <div className="cardTitle">
                <h2>Avatar G Workspace</h2>
                <span className="badge">{session ? "SIGNED IN" : "GUEST"}</span>
              </div>
              <div className="sub">GPT-style interface - Projects - Files - Billing-ready</div>

              <div style={{marginTop:12}} className="kpiRow">
                <div className="kpi">
                  <div className="kpiTop">
                    <div className="kpiLabel">USAGE</div>
                    <span className="badge">{(PLANS[plan]?.name || "GUEST")}</span>
                  </div>
                  <div className="sub" style={{marginTop:6}}>
                    Storage: <b style={{color:"var(--text)"}}>{fmtBytes(storageUsed)}</b> used / <b style={{color:"var(--text)"}}>{fmtBytes(limits.maxStorage)}</b> max
                  </div>
                  <div className="bar"><div style={{width: storagePct + "%"}}/></div>
                  <div className="tiny" style={{marginTop:8}}>
                    Projects: <b style={{color:"var(--text)"}}>{projects.length}</b> / <b style={{color:"var(--text)"}}>{limits.maxProjects >= 999999 ? "âˆž" : limits.maxProjects}</b>
                  </div>
                </div>
              </div>

              <div style={{marginTop:12}}>
                <div className="cardTitle" style={{marginBottom:6}}>
                  <h2>PROJECTS</h2>
                  <span className="badge">{activeProjectId ? "ACTIVE" : "NONE"}</span>
                </div>

                <div className="row">
                  <input className="input" value={newProjectName} onChange={e=>setNewProjectName(e.target.value)} placeholder="New project name..." />
                  <button className={"miniBtn " + (!canCreateProject ? "miniBtnDanger" : "")}
                    disabled={!session || !config}
                    title={!canCreateProject ? "Upgrade plan for more projects" : "Create project"}
                    onClick={createProject}>
                    +
                  </button>
                </div>

                <div className="sub tiny" style={{marginTop:6}}>
                  {session ? (canCreateProject ? "Create and switch projects instantly." : "Project limit reached. Upgrade plan.")
                  : "Sign in to create projects."}
                </div>

                <div className="list">
                  {projects.length ? projects.map(p=>(
                    <div key={p.id}
                      className={"item " + (p.id===activeProjectId ? "itemActive" : "")}
                      onClick={()=>setActiveProjectId(p.id)}
                    >
                      <div className="itemLeft">
                        <div className="itemName">{p.name}</div>
                        <div className="itemMeta">{new Date(p.createdAt || Date.now()).toLocaleDateString("ka-GE")}</div>
                      </div>
                      <div style={{display:"flex", gap:8, alignItems:"center"}}>
                        {p.id!==activeProjectId && <span className="badge">switch</span>}
                        <button className="miniBtn miniBtnDanger"
                          onClick={(e)=>{ e.stopPropagation(); deleteProject(p.id); }}
                          title="Delete project"
                        >ðŸ—‘</button>
                      </div>
                    </div>
                  )) : (
                    <div className="sub">No projects yet. Create one.</div>
                  )}
                </div>

                <div style={{display:"flex", gap:10, marginTop:10}}>
                  <button className="btn2" disabled={!session || !config} onClick={refreshAll} style={{width:"100%"}}>
                    Refresh Projects
                  </button>
                </div>
              </div>

              <div style={{marginTop:14}}>
                <div className="cardTitle" style={{marginBottom:6}}>
                  <h2>BILLING</h2>
                  <span className="badge">Stripe</span>
                </div>
                <div style={{display:"grid", gap:10}}>
                  <button className="btn" disabled={!session || !config} onClick={()=>stripeCheckout("pro")}>
                    Stripe Checkout: PRO
                  </button>
                  <button className="btn2" disabled={!session || !config} onClick={()=>stripeCheckout("studio")}>
                    Stripe Checkout: STUDIO
                  </button>
                  <button className="btn2" disabled={!session || !config} onClick={openPortal}>
                    Customer Portal
                  </button>
                </div>
                <div className="tiny" style={{marginTop:8}}>
                  Backend must return url for checkout/portal.
                </div>
              </div>

              <div style={{marginTop:14}}>
                <div className="cardTitle" style={{marginBottom:6}}>
                  <h2>MODES</h2>
                  <span className="badge">{mode}</span>
                </div>
                <div className="modes">
                  {SERVICE_MODES.map(m=>(
                    <button key={m.id}
                      className={"modeBtn " + (m.id===mode ? "modeBtnActive" : "")}
                      onClick={()=>setMode(m.id)}
                    >
                      <span style={{fontSize:18}}>{m.icon}</span>
                      <span>{m.title}</span>
                    </button>
                  ))}
                </div>
              </div>
            </div>

            <div className="chatCard">
              <div className="chatHeader">
                <div>
                  <h2>Chat</h2>
                  <div className="meta">
                    Project: <b style={{color:"var(--text)"}}>{activeProjectId ? (projects.find(p=>p.id===activeProjectId)?.name || activeProjectId) : "None"}</b>
                    {" - "}
                    Mode: <b style={{color:"var(--text)"}}>{mode}</b>
                    {streaming ? <span style={{color:"var(--accent)"}}> - streaming</span> : null}
                  </div>
                </div>
                <div style={{display:"flex", gap:10}}>
                  <button className="btn2" disabled={!session || !config || !activeProjectId} onClick={uploadFile}>
                    Upload
                  </button>
                </div>
              </div>

              <div className="chatBody">
                {messages.map((m, i)=>(
                  <div key={i} className={"msgRow " + (m.role==="user" ? "user":"")}>
                    <div className={"bubble " + (m.role==="user" ? "user":"")}>
                      {m.content}
                    </div>
                  </div>
                ))}
                <div ref={bottomRef}></div>
              </div>

              <div className="composer">
                <textarea
                  value={input}
                  onChange={e=>setInput(e.target.value)}
                  placeholder={session ? "Write a request (Enter=send, Shift+Enter=new line)" : "Sign in to chat"}
                  onKeyDown={(e)=>{
                    if(e.key==="Enter" && !e.shiftKey){
                      e.preventDefault();
                      send();
                    }
                  }}
                />
                <button className="btn"
                  disabled={!canChat}
                  onClick={send}
                  style={{padding:"0 24px", opacity: (!canChat ? 0.55 : 1)}}
                >
                  {streaming ? "..." : "Send"}
                </button>
              </div>
            </div>
          </div>

          <div className="tiny">
            Security note: frontend sends Authorization: Bearer &lt;supabase_access_token&gt; to backend.
            Backend must verify token and enforce limits server-side.
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
